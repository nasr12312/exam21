<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³ | Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>

<!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ù„Ø¥ÙƒØ³Ù„ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --accent: #4895ef;
        --success: #06d6a0;
        --warning: #ffd166;
        --danger: #ef476f;
        --dark: #1e1e2e;
        --light: #f8f9fa;
        --card-bg: #ffffff;
        --text: #2b2d42;
        --sidebar-w: 280px;
        --shadow: 0 10px 30px rgba(0,0,0,0.05);
    }

    [data-theme="dark"] {
        --primary: #4cc9f0;
        --card-bg: #2d2d44;
        --light: #181824;
        --text: #edf2f4;
        --shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    body {
        font-family: 'Tajawal', sans-serif;
        background-color: var(--light);
        color: var(--text);
        transition: 0.3s;
        overflow-x: hidden;
    }

    /* === Sidebar === */
    .sidebar {
        width: var(--sidebar-w);
        height: 100vh;
        position: fixed;
        right: 0;
        top: 0;
        background: var(--card-bg);
        box-shadow: var(--shadow);
        z-index: 1000;
        transition: 0.3s;
        display: flex;
        flex-direction: column;
        border-left: 1px solid rgba(0,0,0,0.05);
    }

    .sidebar-header {
        padding: 30px 20px;
        text-align: center;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
    }
    
    .logo-img {
        width: 80px; height: 80px; 
        border-radius: 50%; 
        border: 4px solid rgba(255,255,255,0.3);
        margin-bottom: 10px;
        object-fit: cover;
    }

    .nav-menu {
        flex: 1;
        overflow-y: auto;
        padding: 20px 10px;
    }

    .nav-item {
        padding: 12px 20px;
        margin-bottom: 8px;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.2s;
        color: var(--text);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 15px;
        opacity: 0.8;
    }

    .nav-item:hover, .nav-item.active {
        background: var(--primary);
        color: white;
        opacity: 1;
        transform: translateX(-5px);
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
    }

    /* === Main Content === */
    .main-content {
        margin-right: var(--sidebar-w);
        padding: 30px;
        transition: 0.3s;
        min-height: 100vh;
    }

    /* === Header & Stats === */
    .top-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(128,128,128,0.1);
    }

    .stat-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 25px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
        transition: 0.3s;
        border: 1px solid rgba(128,128,128,0.1);
    }
    .stat-card:hover { transform: translateY(-5px); }
    
    .stat-icon {
        width: 60px; height: 60px;
        border-radius: 15px;
        display: flex; align-items: center; justify-content: center;
        font-size: 24px;
        position: absolute;
        top: 20px; left: 20px;
        opacity: 0.2;
    }
    .st-blue { background: var(--primary); color: white; }
    .st-green { background: var(--success); color: white; }
    .st-orange { background: var(--warning); color: #333; }

    /* === Advanced Tables === */
    .pro-table-container {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 20px;
        box-shadow: var(--shadow);
        overflow: hidden;
    }
    
    .table {
        color: var(--text);
        border-color: rgba(128,128,128,0.1);
    }
    .table thead th {
        background: rgba(67, 97, 238, 0.05);
        color: var(--primary);
        font-weight: 700;
        border: none;
        padding: 15px;
    }
    .table td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid rgba(128,128,128,0.1);
    }

    /* === Cards (Codes/Students) === */
    .code-card {
        background: var(--card-bg);
        border: 1px dashed var(--primary);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        position: relative;
        cursor: pointer;
        transition: 0.2s;
    }
    .code-card.selected {
        background: rgba(67, 97, 238, 0.1);
        border-style: solid;
        border-width: 2px;
    }
    .code-num { font-family: monospace; font-size: 1.5rem; font-weight: 800; letter-spacing: 2px; color: var(--primary); }

    /* === Mobile & Utility === */
    .hidden { display: none !important; }
    .loader-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
        z-index: 9999; display: flex; flex-direction: column;
        justify-content: center; align-items: center; color: white;
        transition: opacity 0.3s;
    }
    
    #loader-actions {
        margin-top: 20px;
        display: none;
        animation: fadeIn 0.5s;
        text-align: center;
    }

    @media (max-width: 992px) {
        .sidebar { transform: translateX(100%); width: 100%; max-width: 300px; }
        .sidebar.active { transform: translateX(0); }
        .main-content { margin-right: 0; padding: 15px; }
        .mobile-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none;
        }
        .mobile-overlay.active { display: block; }
    }

    /* Animation */
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
    .view-section { animation: fadeIn 0.4s ease-out; }
    
    /* Social Inputs */
    .social-input-group .input-group-text { width: 45px; justify-content: center; }
</style>
</head>
<body>

<!-- Loader -->
<div id="loader" class="loader-overlay">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
    <h5 id="loader-txt">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</h5>
    <div id="loader-actions">
        <p class="text-white-50 small mb-2">Ø§Ø³ØªØºØ±Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹ØŸ</p>
        <button class="btn btn-outline-light btn-sm" onclick="location.reload()">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</button>
        <button class="btn btn-danger btn-sm" onclick="forceChangeAPI()">ØªØºÙŠÙŠØ± Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        <button class="btn btn-link text-white btn-sm d-block mx-auto mt-2" onclick="showLoader(false)">Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø³Ø±ÙŠ</button>
    </div>
</div>

<div class="mobile-overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" class="logo-img" alt="Logo">
        <h5 class="mb-0 fw-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h5>
        <small style="opacity:0.8">Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ 3.0</small>
    </div>
    <div class="nav-menu">
        <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-th-large"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item" onclick="nav('students', this)"><i class="fas fa-user-graduate"></i> Ø§Ù„Ø·Ù„Ø§Ø¨</div>
        <div class="nav-item" onclick="nav('codes', this)"><i class="fas fa-barcode"></i> Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</div>
        <div class="nav-item" onclick="nav('results', this)"><i class="fas fa-chart-pie"></i> Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
        <div class="nav-item" onclick="nav('library', this)"><i class="fas fa-book"></i> Ø§Ù„Ù…ÙƒØªØ¨Ø©</div>
        <div class="nav-item" onclick="nav('assignments', this)"><i class="fas fa-tasks"></i> Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</div>
        <div class="nav-item" onclick="nav('complaints', this)"><i class="fas fa-envelope-open-text"></i> Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ <span id="comp-badge" class="badge bg-danger rounded-pill ms-auto d-none">!</span></div>
        <div class="nav-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>
    <div class="p-3">
        <button class="btn btn-outline-danger w-100" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
    </div>
</aside>

<!-- Main Content -->
<main class="main-content">
    <!-- Top Bar -->
    <div class="top-header">
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-light d-lg-none shadow-sm" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <div>
                <h4 class="fw-bold mb-0">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ø§Ù„Ù‚Ø§Ø¦Ø¯ ğŸ‘‹</h4>
                <small class="text-muted">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</small>
            </div>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-light shadow-sm rounded-circle" onclick="toggleTheme()" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
            <button class="btn btn-primary shadow rounded-pill px-4" onclick="refreshAll()">
                <i class="fas fa-sync-alt me-2"></i> ØªØ­Ø¯ÙŠØ«
            </button>
        </div>
    </div>

    <!-- 1. HOME DASHBOARD -->
    <div id="view-home" class="view-section">
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <h6 class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h6>
                    <h2 class="fw-bold mb-0" id="st-total-std">0</h2>
                    <div class="stat-icon st-blue"><i class="fas fa-users"></i></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <h6 class="text-muted">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h6>
                    <h2 class="fw-bold mb-0" id="st-total-exam">0</h2>
                    <div class="stat-icon st-green"><i class="fas fa-file-alt"></i></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <h6 class="text-muted">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©</h6>
                    <h2 class="fw-bold mb-0" id="st-total-code">0</h2>
                    <div class="stat-icon st-orange"><i class="fas fa-ticket-alt"></i></div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="stat-card h-100">
                    <h5 class="fw-bold mb-3">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª)</h5>
                    <canvas id="chart-performance"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="stat-card h-100">
                    <h5 class="fw-bold mb-3">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</h5>
                    <canvas id="chart-students"></canvas>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <h5 class="fw-bold mb-3"><i class="fas fa-newspaper text-info"></i> Ù†Ø´Ø± Ø£Ø®Ø¨Ø§Ø± ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h5>
            <div class="input-group">
                <input type="text" class="form-control" id="notif-msg" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø®Ø¨Ø± Ø£Ùˆ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§ Ù„ÙŠØ¸Ù‡Ø± ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨...">
                <button class="btn btn-info fw-bold text-white" onclick="sendNotif()">Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± ğŸ“¢</button>
            </div>
            <small class="text-muted">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø¨Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨.</small>
        </div>
    </div>

    <!-- 2. STUDENTS VIEW -->
    <div id="view-students" class="view-section hidden">
        <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
            <h4 class="fw-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h4>
            <div class="d-flex gap-2">
                <input type="text" id="search-std" class="form-control" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." onkeyup="renderStudents()">
                <button class="btn btn-success" onclick="printIDCards()"><i class="fas fa-id-card"></i> Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø§Øª</button>
            </div>
        </div>
        <div class="row g-3" id="students-grid"></div>
    </div>

    <!-- 3. CODES VIEW -->
    <div id="view-codes" class="view-section hidden">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="stat-card">
                    <h5 class="fw-bold mb-3 text-primary">ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ø¬Ø¯ÙŠØ¯Ø©</h5>
                    <div class="mb-3">
                        <label>Ø§Ù„Ø¹Ø¯Ø¯:</label>
                        <input type="number" id="gen-count" class="form-control" value="10">
                    </div>
                    <div class="mb-3">
                        <label>Ø§Ù„ØµÙ:</label>
                        <input type="text" id="gen-cls" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¹Ø§Ø´Ø±">
                    </div>
                    <div class="mb-3">
                        <label>Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…):</label>
                        <select id="gen-days" class="form-select">
                            <option value="120">ÙØµÙ„ (120 ÙŠÙˆÙ…)</option>
                            <option value="365">Ø³Ù†Ø© (365 ÙŠÙˆÙ…)</option>
                            <option value="7">ØªØ¬Ø±ÙŠØ¨ÙŠ (7 Ø£ÙŠØ§Ù…)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="generateCodes()">ØªÙˆÙ„ÙŠØ¯ ÙˆØ­ÙØ¸</button>
                </div>
            </div>
            
            <div class="col-lg-8">
                <div class="stat-card">
                    <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap gap-2">
                        <h5 class="fw-bold">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            <select id="filter-code-cls" class="form-select form-select-sm" style="width: auto;" onchange="renderCodes()">
                                <option value="all">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>
                            </select>
                            <select id="filter-code-status" class="form-select form-select-sm" style="width: auto;" onchange="renderCodes()">
                                <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                <option value="New">Ø¬Ø¯ÙŠØ¯</option>
                                <option value="Used">Ù…Ø³ØªØ®Ø¯Ù…</option>
                            </select>
                            
                            <div class="dropdown">
                                <button class="btn btn-sm btn-dark dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-print"></i> Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="printFilteredCodes('selected')">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="printFilteredCodes('view')">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="printFilteredCodes('new')">Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯</a></li>
                                </ul>
                            </div>
                            
                            <button class="btn btn-sm btn-success" onclick="exportCodesToExcel()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSelectedCodes()">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                        </div>
                    </div>
                    
                    <!-- ØªØ®ØµÙŠØµ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
                    <div class="row g-2 mb-3 align-items-end p-2 border rounded bg-light">
                        <div class="col-md-5">
                            <label class="small text-muted">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©):</label>
                            <input id="card-title-input" class="form-control form-control-sm" value="Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©">
                        </div>
                        <div class="col-md-5">
                            <label class="small text-muted">ÙˆØµÙ/Ù…Ù„Ø§Ø­Ø¸Ø©:</label>
                            <input id="card-desc-input" class="form-control form-control-sm" value="Activate at Platform">
                        </div>
                        <div class="col-md-2 text-center">
                            <small class="text-muted d-block">Ù…Ø¹Ø§ÙŠÙ†Ø©</small>
                            <i class="fas fa-eye text-primary"></i>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center justify-content-between mb-2">
                         <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check-all-codes" onchange="toggleAllCodes(this)">
                            <label class="form-check-label user-select-none" for="check-all-codes">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</label>
                        </div>
                        <span class="text-muted small" id="codes-count-badge">0 ÙƒÙˆØ¯</span>
                    </div>

                    <div id="codes-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-height: 50vh; overflow-y: auto; padding: 5px;">
                        <!-- JS populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. RESULTS VIEW -->
    <div id="view-results" class="view-section hidden">
        <div class="d-flex justify-content-between mb-3 align-items-center">
            <h4 class="fw-bold">Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h4>
            <button class="btn btn-success" onclick="exportToExcel('results-table')"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel</button>
        </div>
        <div class="mb-3 row g-2">
            <div class="col-md-8"><input id="search-res" class="form-control" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†..." onkeyup="renderResults()"></div>
            <div class="col-md-4">
                <select id="filter-res-cls" class="form-select" onchange="renderResults()">
                    <option value="all">Ø§Ù„ÙƒÙ„</option>
                </select>
            </div>
        </div>
        <div class="pro-table-container">
            <div class="table-responsive" style="max-height: 70vh;">
                <table class="table table-hover mb-0" id="results-table">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>ØºØ´ØŸ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="results-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. LIBRARY VIEW -->
    <div id="view-library" class="view-section hidden">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <h5 class="fw-bold mb-3 text-primary">Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰</h5>
                    <input id="lib-title" class="form-control mb-2" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³">
                    <input id="lib-subject" class="form-control mb-2" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø© (ØªØµÙ†ÙŠÙ)">
                    <select id="lib-type" class="form-select mb-2"><option value="PDF">Ù…Ù„Ù PDF</option><option value="Video">ÙÙŠØ¯ÙŠÙˆ</option></select>
                    <input id="lib-cls" class="form-control mb-2" placeholder="Ø§Ù„ØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                    <input id="lib-link" class="form-control mb-3" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
                    <button class="btn btn-primary w-100" onclick="addToLib()">Ù†Ø´Ø±</button>
                </div>
            </div>
            <div class="col-md-8">
                <div class="pro-table-container">
                    <table class="table table-hover mb-0">
                        <thead><tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØµÙ</th><th>Ø­Ø°Ù</th></tr></thead>
                        <tbody id="lib-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. ASSIGNMENTS VIEW -->
    <div id="view-assignments" class="view-section hidden">
        <h4 class="fw-bold mb-3">Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h4>
        <div class="pro-table-container">
            <table class="table table-hover mb-0">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ù„Ù</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø±ØµØ¯</th></tr></thead>
                <tbody id="assign-body"></tbody>
            </table>
        </div>
    </div>

    <!-- 7. COMPLAINTS VIEW -->
    <div id="view-complaints" class="view-section hidden">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold">ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h4>
            <button class="btn btn-sm btn-light" onclick="refreshAll()"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«</button>
        </div>
        <div class="pro-table-container">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th><th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th><th>Ø§Ù„Ø±Ø¯</th></tr></thead>
                    <tbody id="comp-body">
                        <tr><td colspan="5" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 8. SETTINGS VIEW -->
    <div id="view-settings" class="view-section hidden">
        <div class="row g-4">
            <!-- General Settings -->
            <div class="col-md-12 col-lg-4">
                <div class="stat-card mb-3">
                    <h5 class="fw-bold mb-3 text-primary"><i class="fas fa-sliders-h"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</h5>
                    <div class="mb-3"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… (Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª):</label><input id="set-name" class="form-control"></div>
                    <div class="mb-3"><label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù„Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¹Ø§Ù…):</label><input id="set-wa" class="form-control"></div>
                    <div class="mb-3"><label>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…:</label>
                        <select id="set-maint" class="form-select"><option value="Off">ÙŠØ¹Ù…Ù„</option><option value="On">ØµÙŠØ§Ù†Ø©</option></select>
                    </div>
                </div>
            </div>

            <!-- Store & Packages Settings (UPDATED) -->
            <div class="col-md-12 col-lg-8">
                <div class="stat-card mb-3">
                    <h5 class="fw-bold mb-3 text-warning"><i class="fas fa-store"></i> Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø¨Ø§Ù‚Ø§Øª</h5>
                    <div class="mb-3">
                        <label>Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…ØªØ¬Ø±/Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø¨Ø¯ÙˆÙ† +):</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fab fa-whatsapp text-success"></i></span>
                            <input id="soc-wa" class="form-control" placeholder="9627xxxxxxxx">
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <!-- Basic Package -->
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light">
                                <h6 class="fw-bold text-center">Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h6>
                                <input id="pkg-basic-name" class="form-control form-control-sm mb-2" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)">
                                <input id="price-basic" class="form-control form-control-sm mb-2" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: 5 JD)">
                                <textarea id="pkg-basic-desc" class="form-control form-control-sm" rows="3" placeholder="Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)"></textarea>
                            </div>
                        </div>
                        <!-- Gold Package -->
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light">
                                <h6 class="fw-bold text-center text-warning">Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</h6>
                                <input id="pkg-gold-name" class="form-control form-control-sm mb-2" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©)">
                                <input id="price-gold" class="form-control form-control-sm mb-2" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: 15 JD)">
                                <textarea id="pkg-gold-desc" class="form-control form-control-sm" rows="3" placeholder="Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)"></textarea>
                            </div>
                        </div>
                        <!-- Term Package -->
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light">
                                <h6 class="fw-bold text-center text-success">Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„ÙØµÙ„ÙŠØ©</h6>
                                <input id="pkg-term-name" class="form-control form-control-sm mb-2" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„ÙØµÙ„ÙŠØ©)">
                                <input id="price-term" class="form-control form-control-sm mb-2" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: 35 JD)">
                                <textarea id="pkg-term-desc" class="form-control form-control-sm" rows="3" placeholder="Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Social & Danger Zone -->
            <div class="col-md-12 col-lg-4">
                <div class="stat-card mb-3">
                    <h5 class="fw-bold mb-3 text-success"><i class="fas fa-share-alt"></i> Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„</h5>
                    <div class="social-input-group mb-2 input-group">
                        <span class="input-group-text"><i class="fab fa-facebook text-primary"></i></span>
                        <input id="soc-fb" class="form-control" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ">
                    </div>
                    <div class="social-input-group mb-2 input-group">
                        <span class="input-group-text"><i class="fab fa-instagram text-danger"></i></span>
                        <input id="soc-ig" class="form-control" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…">
                    </div>
                    <div class="social-input-group mb-2 input-group">
                        <span class="input-group-text"><i class="fab fa-youtube text-danger"></i></span>
                        <input id="soc-yt" class="form-control" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨">
                    </div>
                </div>

                <div class="stat-card border-danger border">
                    <h5 class="fw-bold text-danger mb-3"><i class="fas fa-exclamation-triangle"></i> Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø± ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©</h5>
                    <p class="text-muted small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                    <div class="row" id="reset-boxes">
                        <!-- JS populated -->
                    </div>
                    <button class="btn btn-danger w-100 mt-2" onclick="resetSystem()">ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù (Ø®Ø·Ø±)</button>
                    <!-- New Button for Strong Init / Smart Repair -->
                    <button class="btn btn-warning w-100 mt-2 text-dark fw-bold" onclick="smartRepair()">ğŸ› ï¸ ØµÙŠØ§Ù†Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</button>
                </div>
            </div>
            
            <!-- âœ… Ù‚Ø³Ù… Ø±ÙˆØ§Ø¨Ø· Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØµÙÙˆÙ (Ù…ÙˆØ³Ø¹ Ù…Ù† 3 Ø¥Ù„Ù‰ 12) -->
            <div class="col-md-12 col-lg-8"> 
                <div class="stat-card mb-3">
                    <h5 class="fw-bold mb-3 text-success"><i class="fab fa-whatsapp"></i> Ø±ÙˆØ§Ø¨Ø· Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØµÙÙˆÙ</h5>
                    <div class="row g-3">
                        <div class="col-md-3"><label>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«:</label><input id="set-group-3" class="form-control form-control-sm" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·"></div>
                        <div class="col-md-3"><label>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹:</label><input id="set-group-4" class="form-control form-control-sm" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·"></div>
                        <div class="col-md-3"><label>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³:</label><input id="set-group-5" class="form-control form-control-sm" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·"></div>
                        <div class="col-md-3"><label>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³:</label><input id="set-group-6" class="form-control form-control-sm" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·"></div>
                        <div class="col-md-3"><label>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹:</label><input id="set-group-7" class="form-control form-control-sm" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·"></div>
                        <div class="col-md-3"><label>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†:</label><input id="set-group-8" class="form-control form-control-sm" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·"></div>
                        <div class="col-md-3"><label>Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹:</label><input id="set-group-9" class="form-control form-control-sm" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·"></div>
                        <div class="col-md-3"><label>Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±:</label><input id="set-group-10" class="form-control form-control-sm" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·"></div>
                        <div class="col-md-4"><label>Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ:</label><input id="set-group-11" class="form-control form-control-sm" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·"></div>
                        <div class="col-md-4"><label>Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ:</label><input id="set-group-12" class="form-control form-control-sm" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-12">
                <button class="btn btn-primary w-100 btn-lg shadow" onclick="saveSettings()"><i class="fas fa-save"></i> Ø­ÙØ¸ ÙƒØ§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
        </div>
    </div>

</main>

<!-- Hidden print area -->
<div id="print-area" class="d-none"></div>

<script>
// ============================================
// âš ï¸ Ù‡Ø§Ù…: Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø´Ø± (Web App URL) Ù‡Ù†Ø§
let API_URL = "https://script.google.com/macros/s/AKfycbyJ8FX2Hd_OAakWU0Gbo35jcLq5b-tjwGdoGb4RimJtJCfgZqWnM4OSa7kGV-usUwgX/exec";
// ============================================

// Local State
let DB = { students: [], exams: [], codes: [], results: [], library: [], assignments: [], complaints: [] };
let CHARTS = {};
let loadTimer = null;

// Initialization
window.onload = function() {
    let savedUrl = localStorage.getItem('api_url');
    if(savedUrl) API_URL = savedUrl;
    
    // Check Theme
    if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    // Load Data
    refreshAll();
    
    // Init Danger Zone
    let tables = ['Students', 'Codes', 'Results', 'Library', 'Assignments', 'Complaints'];
    let h = '';
    tables.forEach(t => h+=`<div class="col-6"><div class="form-check"><input type="checkbox" class="form-check-input r-chk" value="${t}" id="r-${t}"><label class="form-check-label small" for="r-${t}">${t}</label></div></div>`);
    document.getElementById('reset-boxes').innerHTML = h;
};

// --- CORE FUNCTIONS ---
function showLoader(s) { 
    let l = document.getElementById('loader');
    let acts = document.getElementById('loader-actions');
    
    if(s) {
        l.style.display = 'flex';
        // Show emergency buttons if it takes too long
        clearTimeout(loadTimer);
        acts.style.display = 'none';
        loadTimer = setTimeout(() => {
            if(l.style.display !== 'none') acts.style.display = 'block';
        }, 5000); // 5 seconds
    } else {
        l.style.display = 'none';
        clearTimeout(loadTimer);
    }
}

function forceChangeAPI() {
    let u = prompt('Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Web App URL):', API_URL);
    if(u && u.startsWith('http')) {
        localStorage.setItem('api_url', u);
        location.reload();
    }
}

async function callApi(action, payload={}) {
    showLoader(true);
    payload.action = action;
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout

    try {
        let res = await fetch(API_URL, { 
            method: 'POST', 
            body: JSON.stringify(payload),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!res.ok) throw new Error("HTTP Error");
        
        let data = await res.json();
        showLoader(false);
        return data;
    } catch(e) {
        clearTimeout(timeoutId);
        showLoader(false);
        console.error(e);
        return null;
    }
}

async function refreshAll() {
    showLoader(true);
    try {
        let d = await callApi('getAdminData_V2'); 
        
        if (!d || !d.stats) {
            console.warn("V2 failed or missing stats, trying V1...");
            d = await callApi('getAdminData');
        }

        if(d && d.stats) {
            DB.codes = Array.isArray(d.codes) ? d.codes : [];
            
            // Parallel loading for better performance
            await Promise.all([
                loadSection('getStudentsForCards', d => { DB.students = Array.isArray(d) ? d : []; renderStudents(); }),
                loadSection('getAllResultsForAdmin', d => { DB.results = Array.isArray(d) ? d : []; renderResults(); }),
                loadSection('getComplaintsForAdmin', d => { DB.complaints = Array.isArray(d) ? d : []; renderComp(); })
            ]);
            
            updateCharts();

            document.getElementById('st-total-code').innerText = DB.codes.length;
            document.getElementById('st-total-exam').innerText = d.stats.exams || 0;
            document.getElementById('st-total-std').innerText = d.stats.students || 0;
            
            // Populate General & Price Settings
            if(d.settings) {
                // Basic Settings
                if(document.getElementById('set-name')) document.getElementById('set-name').value = d.settings['TeacherName'] || '';
                if(document.getElementById('set-wa')) document.getElementById('set-wa').value = d.settings['WhatsApp'] || '';
                if(document.getElementById('set-maint')) document.getElementById('set-maint').value = d.settings['Maintenance'] || 'Off';
                
                // Store Settings (Names, Prices, Descs)
                if(document.getElementById('pkg-basic-name')) document.getElementById('pkg-basic-name').value = d.settings['Pkg_Basic_Name'] || 'Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©';
                if(document.getElementById('price-basic')) document.getElementById('price-basic').value = d.settings['Price_Basic'] || '5 JD';
                if(document.getElementById('pkg-basic-desc')) document.getElementById('pkg-basic-desc').value = d.settings['Pkg_Basic_Desc'] || '';
                
                if(document.getElementById('pkg-gold-name')) document.getElementById('pkg-gold-name').value = d.settings['Pkg_Gold_Name'] || 'Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©';
                if(document.getElementById('price-gold')) document.getElementById('price-gold').value = d.settings['Price_Gold'] || '15 JD';
                if(document.getElementById('pkg-gold-desc')) document.getElementById('pkg-gold-desc').value = d.settings['Pkg_Gold_Desc'] || '';

                if(document.getElementById('pkg-term-name')) document.getElementById('pkg-term-name').value = d.settings['Pkg_Term_Name'] || 'Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„ÙØµÙ„ÙŠØ©';
                if(document.getElementById('price-term')) document.getElementById('price-term').value = d.settings['Price_Term'] || '35 JD';
                if(document.getElementById('pkg-term-desc')) document.getElementById('pkg-term-desc').value = d.settings['Pkg_Term_Desc'] || '';
                
                // Class Groups (3-12)
                if(document.getElementById('set-group-3')) document.getElementById('set-group-3').value = d.settings['Group_Ø§Ù„Ø«Ø§Ù„Ø«'] || '';
                if(document.getElementById('set-group-4')) document.getElementById('set-group-4').value = d.settings['Group_Ø§Ù„Ø±Ø§Ø¨Ø¹'] || '';
                if(document.getElementById('set-group-5')) document.getElementById('set-group-5').value = d.settings['Group_Ø§Ù„Ø®Ø§Ù…Ø³'] || '';
                if(document.getElementById('set-group-6')) document.getElementById('set-group-6').value = d.settings['Group_Ø§Ù„Ø³Ø§Ø¯Ø³'] || '';
                if(document.getElementById('set-group-7')) document.getElementById('set-group-7').value = d.settings['Group_Ø§Ù„Ø³Ø§Ø¨Ø¹'] || '';
                if(document.getElementById('set-group-8')) document.getElementById('set-group-8').value = d.settings['Group_Ø§Ù„Ø«Ø§Ù…Ù†'] || '';
                if(document.getElementById('set-group-9')) document.getElementById('set-group-9').value = d.settings['Group_Ø§Ù„ØªØ§Ø³Ø¹'] || '';
                if(document.getElementById('set-group-10')) document.getElementById('set-group-10').value = d.settings['Group_Ø§Ù„Ø¹Ø§Ø´Ø±'] || '';
                if(document.getElementById('set-group-11')) document.getElementById('set-group-11').value = d.settings['Group_Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ'] || '';
                if(document.getElementById('set-group-12')) document.getElementById('set-group-12').value = d.settings['Group_Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ'] || '';
            }

            if(d.socials) {
                 if(document.getElementById('soc-wa')) document.getElementById('soc-wa').value = d.socials.whatsapp || '';
                 if(document.getElementById('soc-fb')) document.getElementById('soc-fb').value = d.socials.facebook || '';
                 if(document.getElementById('soc-ig')) document.getElementById('soc-ig').value = d.socials.instagram || '';
                 if(document.getElementById('soc-yt')) document.getElementById('soc-yt').value = d.socials.youtube || '';
            }

            renderCodes();
            populateFilters();
        } else {
             // Fallback
             document.getElementById('st-total-code').innerText = "0";
             document.getElementById('st-total-exam').innerText = "0";
             document.getElementById('st-total-std').innerText = "0";
        }
    } catch(err) {
        console.error("Critical Error in refreshAll:", err);
    } finally {
        showLoader(false);
    }
}

async function loadSection(act, cb) {
    let d = await callApi(act);
    if(d) cb(d);
}

// --- NAVIGATION ---
function nav(view, el) {
    document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
    document.getElementById('view-'+view).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    
    // Lazy Load with checks
    if(view === 'library') loadSection('getLibraryForAdmin', d => { DB.library = Array.isArray(d) ? d : []; renderLib(); });
    if(view === 'assignments') loadSection('getAssignmentsForAdmin', d => { DB.assignments = Array.isArray(d) ? d : []; renderAssign(); });
    // Complaints are now loaded in refreshAll to show badge if needed
    
    if(window.innerWidth < 992) toggleSidebar();
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
    document.querySelector('.mobile-overlay').classList.toggle('active');
}

function toggleTheme() {
    let b = document.body;
    if(b.getAttribute('data-theme') === 'dark') {
        b.removeAttribute('data-theme'); localStorage.setItem('theme', 'light');
    } else {
        b.setAttribute('data-theme', 'dark'); localStorage.setItem('theme', 'dark');
    }
}

// --- CHARTS ---
function updateCharts() {
    let classes = {};
    if(DB.students) DB.students.forEach(s => { classes[s.cls] = (classes[s.cls]||0) + 1; });
    
    // Check if element exists before populating (it might be removed in news update)
    let filterCls = document.getElementById('notif-target');
    if (filterCls) {
        filterCls.innerHTML = '<option value="All">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>';
        Object.keys(classes).forEach(c => {
            filterCls.innerHTML += `<option value="${c}">Ø·Ù„Ø§Ø¨ ${c}</option>`;
        });
    }

    if(CHARTS.std) CHARTS.std.destroy();
    CHARTS.std = new Chart(document.getElementById('chart-students'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(classes),
            datasets: [{
                data: Object.values(classes),
                backgroundColor: ['#4361ee', '#3f37c9', '#4895ef', '#4cc9f0', '#f72585']
            }]
        }
    });

    let scores = {}; let counts = {};
    if(DB.results) DB.results.forEach(r => {
        let c = r.cls || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        scores[c] = (scores[c]||0) + parseFloat(r.score);
        counts[c] = (counts[c]||0) + 1;
    });
    let avgLabels = [], avgData = [];
    Object.keys(scores).forEach(k => {
        avgLabels.push(k);
        avgData.push(Math.round(scores[k] / counts[k]));
    });

    if(CHARTS.perf) CHARTS.perf.destroy();
    CHARTS.perf = new Chart(document.getElementById('chart-performance'), {
        type: 'bar',
        data: {
            labels: avgLabels,
            datasets: [{
                label: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª',
                data: avgData,
                backgroundColor: '#06d6a0',
                borderRadius: 5
            }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
    });
}

// --- RENDERERS ---

function renderStudents() {
    let s = document.getElementById('search-std').value.toLowerCase();
    let div = document.getElementById('students-grid');
    div.innerHTML = '';
    if(DB.students) DB.students.filter(x => String(x.name||'').toLowerCase().includes(s)).forEach(st => {
        div.innerHTML += `
        <div class="col-md-6 col-lg-4">
            <div class="stat-card d-flex align-items-center gap-3 p-3">
                <img src="${st.photo && st.photo.length > 20 ? st.photo : 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" 
                     style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--primary)">
                <div class="flex-grow-1 overflow-hidden">
                    <h6 class="fw-bold mb-1 text-truncate">${st.name}</h6>
                    <span class="badge bg-light text-dark border">${st.cls}</span>
                    <small class="d-block text-muted text-truncate mt-1">${st.email}</small>
                </div>
                
                <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-light text-warning" onclick="resetDev('${st.email}')" title="ÙÙƒ Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²"><i class="fas fa-unlock"></i></button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item text-danger" onclick="delStudent('${st.email}')">Ø­Ø°Ù</a></li>
                            <li><a class="dropdown-item" onclick="changePass('${st.email}')">ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø±</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>`;
    });
}

function renderCodes() {
    let div = document.getElementById('codes-container');
    let fCls = document.getElementById('filter-code-cls').value;
    let fStats = document.getElementById('filter-code-status').value;
    
    div.innerHTML = '';
    
    let filtered = [];
    if(DB.codes) {
        filtered = DB.codes.filter(c => (fCls === 'all' || c.cls === fCls) && (fStats === 'all' || (fStats === 'New' && c.status === 'New') || (fStats === 'Used' && c.status !== 'New')));
        
        filtered.forEach(c => {
            let used = c.status !== 'New';
            div.innerHTML += `
            <div class="code-card ${used ? 'opacity-50' : ''}" onclick="selectCode(this)">
                <input type="checkbox" class="form-check-input position-absolute top-0 end-0 m-2 code-chk" value="${c.code}">
                <div class="code-num">${c.code}</div>
                <div class="d-flex justify-content-between mt-2 small">
                    <span class="badge ${used ? 'bg-secondary' : 'bg-success'}">${used ? 'Ù…Ø³ØªØ®Ø¯Ù…' : 'Ø¬Ø¯ÙŠØ¯'}</span>
                    <span class="text-muted">${c.cls}</span>
                </div>
                ${c.days ? `<span class="badge bg-warning text-dark mt-1" style="font-size:10px">${c.days} ÙŠÙˆÙ…</span>` : ''}
            </div>`;
        });
    }
    document.getElementById('codes-count-badge').innerText = filtered.length + ' ÙƒÙˆØ¯';
}

function renderResults() {
    let s = document.getElementById('search-res').value.toLowerCase();
    let f = document.getElementById('filter-res-cls').value;
    let tb = document.getElementById('results-body');
    tb.innerHTML = '';
    if(DB.results) DB.results.filter(r => (f==='all' || r.cls===f) && (String(r.name||'').toLowerCase().includes(s) || String(r.exam||'').toLowerCase().includes(s))).forEach(r => {
        tb.innerHTML += `
        <tr>
            <td>${r.date}</td>
            <td class="fw-bold">${r.name}</td>
            <td>${r.exam}</td>
            <td><span class="badge ${r.score>=50?'bg-success':'bg-danger'}">${r.score}%</span></td>
            <td>${r.cheats > 0 ? `<span class="text-danger fw-bold">${r.cheats}</span>` : '-'}</td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="delRes(${r.rowId})"><i class="fas fa-trash"></i></button></td>
        </tr>`;
    });
}

function renderLib() {
    let h=''; if(DB.library) DB.library.forEach(i => h+=`<tr><td>${i.title}</td><td>${i.subject || 'ØºÙŠØ± Ù…ØµÙ†Ù'}</td><td>${i.type}</td><td>${i.cls}</td><td><button class="btn btn-sm btn-danger" onclick="delLib(${i.rowId})">Ø­Ø°Ù</button></td></tr>`);
    document.getElementById('lib-body').innerHTML = h || '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰</td></tr>';
}
function renderAssign() {
    let h=''; if(DB.assignments) DB.assignments.forEach(a => h+=`<tr><td>${a.date}</td><td>${a.name}</td><td>${a.type}</td><td><a href="${a.link}" target="_blank" class="btn btn-sm btn-info">Ø¹Ø±Ø¶</a></td><td>${a.grade}</td><td><button class="btn btn-sm btn-primary" onclick="gradeAss(${a.rowId})">Ø±ØµØ¯</button></td></tr>`);
    document.getElementById('assign-body').innerHTML = h || '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ§Ø¬Ø¨Ø§Øª</td></tr>';
}
function renderComp() {
    let h=''; 
    if(DB.complaints && DB.complaints.length > 0) {
        DB.complaints.forEach(c => {
             h+=`<tr>
                <td>${c.date}</td>
                <td>${c.name}</td>
                <td>${c.email}</td>
                <td><div style="max-width:300px; white-space:normal;">${c.msg}</div></td>
                <td>${c.reply || `<button class="btn btn-sm btn-warning" onclick="replyComp(${c.rowId})">Ø±Ø¯</button>`}</td>
             </tr>`;
        });
    } else {
        h = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</td></tr>';
    }
    document.getElementById('comp-body').innerHTML = h;
}

// --- ACTIONS ---

async function generateCodes() {
    let n = document.getElementById('gen-count').value;
    let c = document.getElementById('gen-cls').value;
    let d = document.getElementById('gen-days').value;
    if(!c) return Swal.fire('Ø®Ø·Ø£', 'Ø£Ø¯Ø®Ù„ Ø§Ù„ØµÙ', 'warning');
    await callApi('generateNewCodes', {count:n, cls:c, days:d});
    Swal.fire('ØªÙ…', 'ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯', 'success');
    refreshAll();
}

function selectCode(el) {
    let chk = el.querySelector('.code-chk');
    chk.checked = !chk.checked;
    el.classList.toggle('selected', chk.checked);
}

function toggleAllCodes(source) {
    document.querySelectorAll('.code-chk').forEach(c => {
        c.checked = source.checked;
        c.parentElement.classList.toggle('selected', source.checked);
    });
}

async function deleteSelectedCodes() {
    let selected = [...document.querySelectorAll('.code-chk:checked')].map(c => c.value);
    if(selected.length == 0) return;
    if(confirm('Ø­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŸ')) {
        await callApi('deleteUsedCodes'); 
        Swal.fire('ØªÙ…', 'ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©', 'info');
        refreshAll();
    }
}

async function addToLib() {
    let d = {
        title: document.getElementById('lib-title').value,
        subject: document.getElementById('lib-subject').value,
        type: document.getElementById('lib-type').value,
        cls: document.getElementById('lib-cls').value,
        link: document.getElementById('lib-link').value
    };
    await callApi('addToLibrary', {d:d});
    Swal.fire('ØªÙ…', 'ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'success');
    nav('library', document.querySelectorAll('.nav-item')[4]);
}

async function sendNotif() {
    let t = document.getElementById('notif-target').value;
    let m = document.getElementById('notif-msg').value;
    if(!m) return;
    await callApi('sendTargetedMessage', {target:t, msg:m});
    Swal.fire('ØªÙ…', 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'success');
}

async function delStudent(e) { if(confirm('Ø­Ø°ÙØŸ')) { await callApi('deleteStudent', {email:e}); refreshAll(); } }
async function resetDev(e) { await callApi('resetStudentDevice', {email:e}); Swal.fire('ØªÙ…', 'ØªÙ… ÙÙƒ Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù„Ø·Ø§Ù„Ø¨', 'success'); }
async function changePass(e) { let p = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:'); if(p) await callApi('adminResetPass', {email:e, newPass:p}); }
async function delRes(id) { if(confirm('Ø­Ø°ÙØŸ')) { await callApi('deleteResultRow', {rowId:id}); refreshAll(); } }
async function delLib(id) { if(confirm('Ø­Ø°ÙØŸ')) { await callApi('deleteLibraryItem', {rowId:id}); nav('library', document.querySelectorAll('.nav-item')[4]); } }
async function gradeAss(id) { let g = prompt('Ø§Ù„Ø¯Ø±Ø¬Ø©:'); if(g) { await callApi('gradeAssignment', {rowId:id, grade:g}); nav('assignments', document.querySelectorAll('.nav-item')[5]); } }
async function replyComp(id) { let r = prompt('Ø§Ù„Ø±Ø¯:'); if(r) { await callApi('replyToComplaint', {rowId:id, reply:r}); nav('complaints', document.querySelectorAll('.nav-item')[6]); } }

async function saveSettings() {
    // 1. General Settings
    let s = {
        'TeacherName': document.getElementById('set-name').value,
        'WhatsApp': document.getElementById('set-wa').value, // Contact WA
        'Maintenance': document.getElementById('set-maint').value,
        
        // Store Settings (Names & Prices & Desc)
        'Pkg_Basic_Name': document.getElementById('pkg-basic-name').value,
        'Price_Basic': document.getElementById('price-basic').value,
        'Pkg_Basic_Desc': document.getElementById('pkg-basic-desc').value,
        
        'Pkg_Gold_Name': document.getElementById('pkg-gold-name').value,
        'Price_Gold': document.getElementById('price-gold').value,
        'Pkg_Gold_Desc': document.getElementById('pkg-gold-desc').value,

        'Pkg_Term_Name': document.getElementById('pkg-term-name').value,
        'Price_Term': document.getElementById('price-term').value,
        'Pkg_Term_Desc': document.getElementById('pkg-term-desc').value,
        
        // Group Links (3-12)
        'Group_Ø§Ù„Ø«Ø§Ù„Ø«': document.getElementById('set-group-3').value,
        'Group_Ø§Ù„Ø±Ø§Ø¨Ø¹': document.getElementById('set-group-4').value,
        'Group_Ø§Ù„Ø®Ø§Ù…Ø³': document.getElementById('set-group-5').value,
        'Group_Ø§Ù„Ø³Ø§Ø¯Ø³': document.getElementById('set-group-6').value,
        'Group_Ø§Ù„Ø³Ø§Ø¨Ø¹': document.getElementById('set-group-7').value,
        'Group_Ø§Ù„Ø«Ø§Ù…Ù†': document.getElementById('set-group-8').value,
        'Group_Ø§Ù„ØªØ§Ø³Ø¹': document.getElementById('set-group-9').value,
        'Group_Ø§Ù„Ø¹Ø§Ø´Ø±': document.getElementById('set-group-10').value,
        'Group_Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ': document.getElementById('set-group-11').value,
        'Group_Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ': document.getElementById('set-group-12').value
    };
    
    // 2. Social Links
    let links = {
        'Facebook': document.getElementById('soc-fb').value,
        'Instagram': document.getElementById('soc-ig').value,
        'WhatsApp_Link': document.getElementById('soc-wa').value, // Store/Renewal WA
        'Youtube': document.getElementById('soc-yt').value
    };

    // Parallel save
    await Promise.all([
        callApi('saveGeneralSettings', {s:s}),
        callApi('saveSocialLinks', {links:links})
    ]);
    
    Swal.fire('ØªÙ…', 'ØªÙ… Ø­ÙØ¸ ÙƒØ§ÙØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

async function resetSystem() {
    let t = [...document.querySelectorAll('.r-chk:checked')].map(c => c.value);
    if(t.length === 0) return;
    let p = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ù„ØªØ£ÙƒÙŠØ¯:');
    if(p === 'admin') { 
        await callApi('resetSpecificTables', {tables:t});
        Swal.fire('ØªÙ…', 'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·', 'success').then(()=>location.reload());
    }
}

async function smartRepair() {
    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¬Ø±Ø§Ø¡ ÙØ­Øµ ÙˆØµÙŠØ§Ù†Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù†Ø¸Ø§Ù…ØŸ\nØ³ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø¨Ø­Ø°Ù Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø·ÙˆØ¨Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§Ù‚ØµØ© Ø¯ÙˆÙ† Ø§Ù„Ù…Ø³Ø§Ø³ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬.')) {
        await callApi('fullSystemSetup');
        Swal.fire('ØªÙ…', 'ØªÙ…Øª ØµÙŠØ§Ù†Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠØ©', 'success');
    }
}

// --- UTILS ---
function populateFilters() {
    let classes = [...new Set((DB.codes||[]).map(c => c.cls).filter(c => c))];
    let opts = '<option value="all">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>';
    classes.forEach(c => opts += `<option value="${c}">${c}</option>`);
    
    // Code Filters
    let cEl = document.getElementById('filter-code-cls');
    if(cEl) cEl.innerHTML = opts;

    // Result Filters
    let rEl = document.getElementById('filter-res-cls');
    if(rEl) rEl.innerHTML = opts.replace('ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ', 'Ø§Ù„ÙƒÙ„');
}

function exportToExcel(tableId) {
    let tbl = document.getElementById(tableId);
    let wb = XLSX.utils.table_to_book(tbl, {sheet:"Sheet1"});
    XLSX.writeFile(wb, 'Export_Data.xlsx');
}

// âœ… Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function exportCodesToExcel() {
    let fCls = document.getElementById('filter-code-cls').value;
    let fStats = document.getElementById('filter-code-status').value;
    let selectedVals = [...document.querySelectorAll('.code-chk:checked')].map(c => c.value);

    let data = [];
    // Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŒ Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§. ÙˆØ¥Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ.
    if (selectedVals.length > 0) {
         data = DB.codes.filter(c => selectedVals.includes(String(c.code)));
    } else {
         data = DB.codes.filter(c =>
            (fCls === 'all' || c.cls === fCls) &&
            (fStats === 'all' || (fStats === 'New' && c.status === 'New') || (fStats === 'Used' && c.status !== 'New'))
        );
    }

    if(data.length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥ÙƒØ³Ù„
    let csvData = data.map(c => ({
        "Ø§Ù„ÙƒÙˆØ¯": c.code,
        "Ø§Ù„ØµÙ": c.cls,
        "Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)": c.days,
        "Ø§Ù„Ø­Ø§Ù„Ø©": c.status === 'New' ? 'Ø¬Ø¯ÙŠØ¯' : 'Ù…Ø³ØªØ®Ø¯Ù…',
        "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…": c.email || '-'
    }));

    let ws = XLSX.utils.json_to_sheet(csvData);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Codes");
    XLSX.writeFile(wb, "Codes_Export.xlsx");
}

function printIDCards() {
    let w = window.open('', '', 'width=900,height=600');
    let h = `<style>
        body { font-family: sans-serif; direction: rtl; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
        .card { border: 2px solid #333; border-radius: 10px; padding: 15px; display: flex; align-items: center; gap: 15px; page-break-inside: avoid; }
        img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
    </style>`;
    if(DB.students) DB.students.forEach(s => {
        let qr = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(s.email)}`;
        h += `<div class="card">
            <img src="${s.photo || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}">
            <div><h3>${s.name}</h3><p>${s.cls}</p><small>${s.email}</small></div>
            <img src="${qr}" style="border-radius:0; margin-right:auto">
        </div>`;
    });
    w.document.write(h);
    w.print();
}

function printFilteredCodes(mode) {
    let cardTitle = document.getElementById('card-title-input').value || 'NEBRAS PLATFORM';
    let cardDesc = document.getElementById('card-desc-input').value || 'Activate at Platform';

    // Modes: 'selected', 'view', 'new'
    let dataToPrint = [];
    
    if (mode === 'selected') {
        let selectedVals = [...document.querySelectorAll('.code-chk:checked')].map(c => c.value);
        if(selectedVals.length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø­Ø¯Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        dataToPrint = DB.codes.filter(c => selectedVals.includes(String(c.code)));
    } 
    else if (mode === 'view') {
        let fCls = document.getElementById('filter-code-cls').value;
        let fStats = document.getElementById('filter-code-status').value;
        dataToPrint = DB.codes.filter(c => 
            (fCls === 'all' || c.cls === fCls) && 
            (fStats === 'all' || (fStats === 'New' && c.status === 'New') || (fStats === 'Used' && c.status !== 'New'))
        );
    }
    else if (mode === 'new') {
        dataToPrint = DB.codes.filter(c => c.status === 'New');
    }

    if(dataToPrint.length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'info');

    let w = window.open('', '', 'width=900,height=600');
    
    // âœ… ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (CSS Ø§Ø­ØªØ±Ø§ÙÙŠ)
    let h = `
    <html>
    <head>
    <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; direction: ltr; background: #fff; padding: 20px; }
        .grid-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 15px; 
        }
        .ticket { 
            border: 2px solid #333; 
            border-radius: 12px; 
            padding: 15px; 
            text-align: center; 
            page-break-inside: avoid; 
            background: #fff;
            position: relative;
            overflow: hidden;
        }
        .header {
            font-size: 14px;
            color: #555;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
            border-bottom: 2px dashed #ddd;
            padding-bottom: 5px;
        }
        .code-box { 
            font-size: 24px; 
            font-weight: 800; 
            margin: 10px 0; 
            background: #f0f0f0; 
            padding: 8px; 
            border-radius: 8px;
            letter-spacing: 2px;
            border: 1px dashed #000;
        }
        .details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #333;
            font-weight: bold;
            margin-top: 10px;
        }
        .badge-pill {
            background: #000;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }
        @media print {
            body { margin: 0; padding: 10px; }
            .ticket { box-shadow: none; }
        }
    </style>
    </head>
    <body>
    <div class="grid-container">`;
    
    dataToPrint.forEach(c => {
        h += `
        <div class="ticket">
            <div class="header">${cardTitle}</div>
            <div class="code-box">${c.code}</div>
            <div class="details">
                <span>${c.cls}</span>
                <span>${c.days || 120} Days</span>
            </div>
            <div style="margin-top:5px; font-size:10px; color:#777;">${cardDesc}</div>
        </div>`;
    });
    h += `</div></body></html>`;
    
    w.document.write(h);
    w.document.close();
    w.focus();
    setTimeout(() => { w.print(); }, 500);
}

function logout() {
    localStorage.removeItem('api_url');
    location.reload();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
