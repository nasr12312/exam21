<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>منصة نبراس | لوحة الإدارة Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root { --primary: #4f46e5; --secondary: #64748b; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --dark: #1e293b; --light: #f8fafc; }
  body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; min-height: 100vh; overflow-x: hidden; }
  .sidebar { width: 260px; height: 100vh; position: fixed; right: 0; top: 0; background: var(--dark); color: white; transition: 0.3s; z-index: 1000; padding-top: 20px; }
  .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; text-align: center; }
  .logo-img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; border: 3px solid var(--warning); object-fit: cover; }
  .nav-link { color: #94a3b8; padding: 12px 20px; display: flex; align-items: center; gap: 12px; font-weight: 500; transition: 0.3s; border-radius: 8px; margin: 0 10px 5px; cursor: pointer; }
  .nav-link:hover, .nav-link.active { background: var(--primary); color: white; transform: translateX(-5px); }
  .main-content { margin-right: 260px; padding: 30px; transition: 0.3s; }
  .stat-card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; height: 100%; }
  .stat-card.blue::after { content:''; position:absolute; top:0; right:0; width:4px; height:100%; background: var(--primary); }
  .stat-card.green::after { content:''; position:absolute; top:0; right:0; width:4px; height:100%; background: var(--success); }
  .stat-card.orange::after { content:''; position:absolute; top:0; right:0; width:4px; height:100%; background: var(--warning); }
  .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 15px; }
  .bg-soft-blue { background: #e0e7ff; color: var(--primary); }
  .bg-soft-green { background: #d1fae5; color: var(--success); }
  .bg-soft-orange { background: #fef3c7; color: var(--warning); }
  .custom-table { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
  .custom-table th { background: #f8fafc; color: var(--secondary); font-weight: 700; padding: 15px; border-bottom: 2px solid #e2e8f0; }
  .custom-table td { padding: 15px; vertical-align: middle; color: var(--dark); border-bottom: 1px solid #f1f5f9; }
  .form-control, .form-select { padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; box-shadow: none; font-size: 14px; }
  .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
  .btn-primary { background: var(--primary); border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; }
  #connection-status { position: fixed; top: 0; left: 0; right: 0; z-index: 9999; text-align: center; padding: 5px; font-weight: bold; font-size: 14px; color: white; }
  .status-connecting { background-color: #f59e0b; }
  .status-connected { background-color: #10b981; }
  .status-error { background-color: #ef4444; }
  
  @media print { .sidebar, .no-print, #connection-status { display: none !important; } .main-content { margin: 0; width: 100%; } }
  @media (max-width: 992px) { .sidebar { transform: translateX(100%); } .sidebar.active { transform: translateX(0); } .main-content { margin-right: 0; } }
</style>
</head>
<body>

<div id="connection-status" class="status-connecting">جاري الاتصال بالسيرفر...</div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" class="logo-img">
    <h4 class="mb-0 fw-bold">منصة نبراس</h4>
    <small class="text-white-50">Admin Panel Pro</small>
  </div>
  <div class="nav flex-column">
    <div class="nav-link active" onclick="showTab('home', this)"><i class="fas fa-home"></i> الرئيسية</div>
    <div class="nav-link" onclick="showTab('students', this)"><i class="fas fa-users"></i> الطلاب</div>
    <div class="nav-link" onclick="showTab('results', this)"><i class="fas fa-chart-bar"></i> النتائج</div>
    <div class="nav-link" onclick="showTab('library', this)"><i class="fas fa-book"></i> المكتبة</div>
    <div class="nav-link" onclick="showTab('assign', this)"><i class="fas fa-tasks"></i> الواجبات</div>
    <div class="nav-link" onclick="showTab('complaints', this)"><i class="fas fa-envelope"></i> الشكاوى</div>
    <div class="nav-link" onclick="showTab('settings', this)"><i class="fas fa-cog"></i> الإعدادات</div>
  </div>
</div>

<div class="main-content">
  <div class="d-flex justify-content-between align-items-center mb-4 header-area no-print">
    <div><h3 class="fw-bold text-dark mb-1">لوحة القيادة</h3><p class="text-muted mb-0">نظرة عامة</p></div>
    <div class="d-flex gap-2"><button onclick="location.reload()" class="btn btn-light"><i class="fas fa-sync-alt"></i> تحديث</button><button class="btn btn-primary d-lg-none" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button></div>
  </div>

  <div id="tab-home" class="section-tab">
    <div class="row g-4 mb-4">
      <div class="col-md-4"><div class="stat-card blue"><div class="d-flex justify-content-between"><div><p class="text-muted mb-1">الطلاب</p><h2 class="fw-bold mb-0" id="s-cnt">...</h2></div><div class="stat-icon bg-soft-blue"><i class="fas fa-user-graduate"></i></div></div></div></div>
      <div class="col-md-4"><div class="stat-card green"><div class="d-flex justify-content-between"><div><p class="text-muted mb-1">الامتحانات</p><h2 class="fw-bold mb-0" id="e-cnt">...</h2></div><div class="stat-icon bg-soft-green"><i class="fas fa-file-alt"></i></div></div></div></div>
      <div class="col-md-4"><div class="stat-card orange"><div class="d-flex justify-content-between"><div><p class="text-muted mb-1">الأكواد</p><h2 class="fw-bold mb-0" id="c-cnt">...</h2></div><div class="stat-icon bg-soft-orange"><i class="fas fa-barcode"></i></div></div></div></div>
    </div>
    
    <div class="row">
      <div class="col-md-8 mb-4">
        <div class="card border-0 shadow-sm p-4 h-100">
          <h5 class="fw-bold mb-3">توليد أكواد</h5>
          <div class="row g-2">
             <div class="col-md-3"><input id="gen-count" type="number" class="form-control" placeholder="العدد"></div>
             <div class="col-md-3"><input id="gen-cls" class="form-control" placeholder="الصف"></div>
             <div class="col-md-3"><select id="gen-days" class="form-select"><option value="120">4 شهور</option><option value="365">سنة</option><option value="7">أسبوع</option></select></div>
             <div class="col-md-3"><button onclick="generate()" class="btn btn-primary w-100">توليد</button></div>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-3"><h6 class="fw-bold m-0">الأكواد</h6><div class="d-flex gap-2"><select id="f-cls" class="form-select form-select-sm" style="width:100px" onchange="render()"><option value="all">الكل</option></select><button onclick="deleteUsedCodes()" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i> تنظيف</button><button onclick="printCodes()" class="btn btn-sm btn-outline-dark"><i class="fas fa-print"></i></button></div></div>
          <div id="code-container" style="max-height:400px; overflow-y:auto; display:grid; grid-template-columns:repeat(auto-fill, minmax(130px, 1fr)); gap:10px"></div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card border-0 shadow-sm p-4 h-100 bg-dark text-white">
           <h5 class="fw-bold mb-3">إرسال إشعار</h5>
           <select id="msg-target" class="form-select mb-2"><option value="All">الجميع</option></select>
           <textarea id="msg-text" class="form-control mb-3" rows="3" placeholder="الرسالة..."></textarea>
           <button onclick="sendMsg()" class="btn btn-warning w-100 fw-bold">إرسال</button>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-students" class="section-tab d-none">
     <div class="d-flex justify-content-between mb-3"><h4 class="fw-bold">الطلاب</h4><button onclick="printCards()" class="btn btn-success"><i class="fas fa-print"></i> طباعة</button></div>
     <div class="card p-3 mb-3"><div class="row g-2"><div class="col-md-4"><input id="m-email" class="form-control" placeholder="البريد"></div><div class="col-md-3"><input id="m-pass" class="form-control" placeholder="الباس الجديد"></div><div class="col-md-2"><button onclick="resetPass()" class="btn btn-warning w-100">تغيير</button></div><div class="col-md-2"><button onclick="delStudent()" class="btn btn-danger w-100">حذف</button></div></div></div>
     <div id="ids-grid" class="row g-3"></div>
  </div>

  <div id="tab-results" class="section-tab d-none">
     <div class="d-flex justify-content-between mb-3"><h4 class="fw-bold">النتائج</h4><button onclick="exportToExcel()" class="btn btn-success">Excel</button></div>
     <div class="custom-table"><table class="table table-hover mb-0"><thead><tr><th>التاريخ</th><th>الطالب</th><th>الامتحان</th><th>الدرجة</th><th>حذف</th></tr></thead><tbody id="res-body"></tbody></table></div>
  </div>

  <div id="tab-library" class="section-tab d-none">
     <div class="row"><div class="col-md-4"><div class="card p-4"><h5 class="fw-bold">إضافة</h5><input id="lib-title" class="form-control mb-2" placeholder="العنوان"><select id="lib-type" class="form-select mb-2"><option value="PDF">PDF</option><option value="Video">فيديو</option></select><input id="lib-link" class="form-control mb-3" placeholder="الرابط"><button onclick="addLib()" class="btn btn-primary w-100">نشر</button></div></div><div class="col-md-8"><div class="custom-table"><table class="table"><thead><tr><th>العنوان</th><th>النوع</th><th>حذف</th></tr></thead><tbody id="lib-body"></tbody></table></div></div></div>
  </div>

  <div id="tab-assign" class="section-tab d-none"><div class="custom-table"><table class="table"><thead><tr><th>التاريخ</th><th>الطالب</th><th>النوع</th><th>رابط</th><th>الدرجة</th><th>رصد</th></tr></thead><tbody id="ass-body"></tbody></table></div></div>
  <div id="tab-complaints" class="section-tab d-none"><div class="custom-table"><table class="table"><thead><tr><th>الطالب</th><th>الرسالة</th><th>الرد</th></tr></thead><tbody id="comp-body"></tbody></table></div></div>

  <div id="tab-settings" class="section-tab d-none">
    <div class="row g-4">
      <div class="col-md-6"><div class="card p-4"><h5 class="fw-bold">الإعدادات</h5><input id="sett-name" class="form-control mb-3" placeholder="اسم المعلم"><input id="sett-wa" class="form-control mb-3" placeholder="واتساب"><select id="sett-maint" class="form-select mb-3"><option value="Off">تشغيل</option><option value="On">صيانة</option></select><button onclick="saveSettings()" class="btn btn-primary w-100">حفظ</button></div></div>
      <div class="col-md-6"><div class="card p-4 border-danger"><h5 class="text-danger fw-bold">تهيئة (حذف البيانات)</h5><button onclick="performReset()" class="btn btn-danger w-100">تهيئة النظام بالكامل</button></div></div>
    </div>
  </div>

</div>
<div id="print-area"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===========================================
// ⚠️ هام: ضع الرابط الجديد هنا بدلاً من النص
// ===========================================
const API_URL = "https://script.google.com/macros/s/AKfycbyJ8FX2Hd_OAakWU0Gbo35jcLq5b-tjwGdoGb4RimJtJCfgZqWnM4OSa7kGV-usUwgX/exec"; 
// ===========================================

let allData=[], allResults=[], allStudents=[];

window.onload = function() {
    // اختبار الاتصال فوراً
    if(API_URL.includes("ضع_رابط")) {
        updateStatus("⚠️ خطأ: لم يتم وضع الرابط في الكود!", "error");
        return;
    }
    checkConnection();
};

function updateStatus(msg, type) {
    let el = document.getElementById('connection-status');
    el.innerText = msg;
    el.className = '';
    if(type=='success') el.classList.add('status-connected');
    else if(type=='error') el.classList.add('status-error');
    else el.classList.add('status-connecting');
}

function checkConnection() {
    // نقوم بعمل طلب بسيط (GET) للتأكد من أن السكريبت يعمل
    fetch(API_URL)
    .then(res => {
        if(res.ok) {
            updateStatus("✅ متصل بالسيرفر بنجاح", "success");
            setTimeout(() => document.getElementById('connection-status').style.display='none', 3000);
            loadAllData(); // البدء في جلب البيانات
        } else {
            updateStatus("❌ السيرفر لا يستجيب (404/500)", "error");
        }
    })
    .catch(e => {
        updateStatus("❌ فشل الاتصال! تأكد من الرابط وصلاحيات النشر (Anyone)", "error");
        console.error(e);
    });
}

async function callApi(action, data = {}) {
    data.action = action;
    try {
        const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
        return await response.json();
    } catch (e) { 
        console.error(e); return {success: false}; 
    }
}

function loadAllData() {
    Swal.fire({title: 'جاري التحميل...', didOpen: () => Swal.showLoading()});
    callApi('getAdminData').then(data => {
        Swal.close();
        if(data && data.stats) init(data);
        else Swal.fire('تنبيه', 'لم يتم جلب بيانات صحيحة', 'warning');
    });
}

function init(data) {
    allData = data.codes || [];
    document.getElementById('s-cnt').innerText = data.stats.students;
    document.getElementById('e-cnt').innerText = data.stats.exams;
    document.getElementById('c-cnt').innerText = data.stats.codes;
    
    if(data.settings) {
        if(data.settings['TeacherName']) document.getElementById('sett-name').value = data.settings['TeacherName'];
        if(data.settings['WhatsApp']) document.getElementById('sett-wa').value = data.settings['WhatsApp'];
        if(data.settings['Maintenance']) document.getElementById('sett-maint').value = data.settings['Maintenance'];
    }
    
    // تعبئة قائمة الصفوف
    let classes = [...new Set(allData.map(i=>i.cls).filter(c=>c))];
    let sel = document.getElementById('f-cls'); sel.innerHTML = '<option value="all">الكل</option>';
    classes.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
    
    render();
}

function render() {
    let cls = document.getElementById('f-cls').value;
    let sts = document.getElementById('f-sts').value;
    let filtered = allData.filter(c => (cls=='all'||c.cls==cls) && (sts=='all'||c.status==sts));
    let h = '';
    filtered.forEach(c => {
        h += `<div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px; text-align:center;">
                <div class="fw-bold text-muted" style="font-size:12px">${c.cls}</div>
                <div class="fw-bold text-primary my-1" style="font-size:18px; letter-spacing:1px">${c.code}</div>
                <span class="badge ${c.status=='New'?'bg-success':'bg-secondary'}">${c.status}</span>
                <span class="badge bg-warning text-dark">${c.days} يوم</span>
              </div>`;
    });
    document.getElementById('code-container').innerHTML = h || '<div class="text-center w-100 text-muted">لا يوجد</div>';
}

function showTab(id, el) {
    document.querySelectorAll('.section-tab').forEach(d=>d.classList.add('d-none'));
    document.getElementById('tab-'+id).classList.remove('d-none');
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    el.classList.add('active');
    
    if(id=='students') loadIds();
    if(id=='results') loadResults();
    if(id=='library') loadLib();
    if(id=='assign') loadAss();
    if(id=='complaints') loadComp();
    
    if(window.innerWidth < 992) document.getElementById('sidebar').classList.remove('active');
}
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('active'); }

// --- دوال التشغيل ---
function generate(){
    let c = document.getElementById('gen-count').value, cl = document.getElementById('gen-cls').value, d = document.getElementById('gen-days').value;
    if(!c || !cl) return Swal.fire('خطأ','أدخل البيانات','error');
    Swal.showLoading();
    callApi('generateNewCodes', {count:c, cls:cl, days:d}).then(r=>{ Swal.close(); Swal.fire('تم',r,'success').then(()=>location.reload()); });
}
function deleteUsedCodes(){ callApi('deleteUsedCodes').then(r=>location.reload()); }
function sendMsg(){
    let t = document.getElementById('msg-target').value, m = document.getElementById('msg-text').value;
    if(!m) return;
    callApi('sendTargetedMessage', {target:t, msg:m}).then(r=>Swal.fire('تم','أرسلت','success'));
}
function loadIds(){
    callApi('getStudentsForCards').then(l=>{
        let h=''; l.forEach(s=>{ 
            let qr = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(s.email)}`;
            h+=`<div class="col-md-3"><div class="card p-2 text-center"><img src="${s.photo||'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" style="width:60px;height:60px;margin:0 auto;border-radius:50%"><div class="fw-bold">${s.name}</div><div class="small text-muted">${s.email}</div><img src="${qr}" style="width:60px;margin-top:5px"></div></div>`;
        });
        document.getElementById('ids-grid').innerHTML = h;
    });
}
function printCards(){ window.print(); }
function printCodes(){
    let w=window.open(); w.document.write('<html><body style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;text-align:center;font-family:sans-serif">'+document.getElementById('code-container').innerHTML+'</body></html>'); w.print();
}
function resetPass(){ let e=document.getElementById('m-email').value, p=document.getElementById('m-pass').value; callApi('adminResetPass',{email:e,newPass:p}).then(r=>Swal.fire(r)); }
function delStudent(){ let e=document.getElementById('m-email').value; callApi('deleteStudent',{email:e}).then(r=>Swal.fire(r)); }

function loadResults(){
    callApi('getAllResultsForAdmin').then(l=>{
        let h=''; l.forEach(r=>{ h+=`<tr><td>${r.date}</td><td>${r.name}</td><td>${r.exam}</td><td>${r.score}</td><td><button class="btn btn-sm btn-danger" onclick="delRes(${r.rowId})">X</button></td></tr>`; });
        document.getElementById('res-body').innerHTML = h;
    });
}
function delRes(id){ callApi('deleteResultRow',{rowId:id}).then(()=>loadResults()); }
function loadLib(){
    callApi('getLibraryForAdmin').then(l=>{
        let h=''; l.forEach(i=>{ h+=`<tr><td>${i.title}</td><td>${i.type}</td><td><button class="btn btn-sm btn-danger" onclick="delLib(${i.rowId})">X</button></td></tr>`; });
        document.getElementById('lib-body').innerHTML=h;
    });
}
function addLib(){
    let d={title:document.getElementById('lib-title').value, type:document.getElementById('lib-type').value, link:document.getElementById('lib-link').value, cls:document.getElementById('lib-cls').value};
    callApi('addToLibrary',{d:d}).then(()=>loadLib());
}
function delLib(id){ callApi('deleteLibraryItem',{rowId:id}).then(()=>loadLib()); }
function loadAss(){
    callApi('getAssignmentsForAdmin').then(l=>{
        let h=''; l.forEach(a=>{ h+=`<tr><td>${a.date}</td><td>${a.name}</td><td>${a.type}</td><td><a href="${a.link}" target="_blank">رابط</a></td><td><input id="g-${a.rowId}" value="${a.grade}" size="3"></td><td><button onclick="saveGrade(${a.rowId})">حفظ</button></td></tr>`; });
        document.getElementById('ass-body').innerHTML=h;
    });
}
function saveGrade(id){ callApi('gradeAssignment',{rowId:id, grade:document.getElementById('g-'+id).value}); }
function loadComp(){
    callApi('getComplaintsForAdmin').then(l=>{
        let h=''; l.forEach(c=>{ h+=`<tr><td>${c.name}</td><td>${c.msg}</td><td><input id="rep-${c.rowId}" value="${c.reply}"><button onclick="reply(${c.rowId})">رد</button></td></tr>`; });
        document.getElementById('comp-body').innerHTML=h;
    });
}
function reply(id){ callApi('replyToComplaint',{rowId:id, reply:document.getElementById('rep-'+id).value}); }
function saveSettings(){
    let s={TeacherName:document.getElementById('sett-name').value, WhatsApp:document.getElementById('sett-wa').value, Maintenance:document.getElementById('sett-maint').value};
    callApi('saveGeneralSettings',{s:s}).then(r=>Swal.fire('تم الحفظ'));
}
function performReset(){
    Swal.fire({title:'تأكد؟',text:'حذف كل البيانات؟',icon:'warning',showCancelButton:true}).then(r=>{
        if(r.isConfirmed) {
            Swal.fire({input:'password', title:'كلمة المرور'}).then(pass=>{
                if(pass.value=='admin') {
                    callApi('fullSystemSetup').then(res=>Swal.fire(res.message).then(()=>location.reload()));
                }
            });
        }
    });
}
</script>
</body>
</html>
