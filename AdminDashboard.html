<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ููุตุฉ ูุจุฑุงุณ | ููุญุฉ ุงูููุงุฏุฉ ุงููุชูุงููุฉ</title>

<!-- ุงูููุชุจุงุช -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- ุงูุฑุณูู ุงูุจูุงููุฉ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ุงูุชูุจููุงุช -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- ุงูุชุตุฏูุฑ ููุฅูุณู -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --accent: #4895ef;
        --success: #06d6a0;
        --warning: #ffd166;
        --danger: #ef476f;
        --dark: #1e1e2e;
        --light: #f8f9fa;
        --card-bg: #ffffff;
        --text: #2b2d42;
        --sidebar-w: 280px;
        --shadow: 0 10px 30px rgba(0,0,0,0.05);
    }

    [data-theme="dark"] {
        --primary: #4cc9f0;
        --card-bg: #2d2d44;
        --light: #181824;
        --text: #edf2f4;
        --shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    body {
        font-family: 'Tajawal', sans-serif;
        background-color: var(--light);
        color: var(--text);
        transition: 0.3s;
        overflow-x: hidden;
    }

    /* === Sidebar === */
    .sidebar {
        width: var(--sidebar-w);
        height: 100vh;
        position: fixed;
        right: 0;
        top: 0;
        background: var(--card-bg);
        box-shadow: var(--shadow);
        z-index: 1000;
        transition: 0.3s;
        display: flex;
        flex-direction: column;
        border-left: 1px solid rgba(0,0,0,0.05);
    }

    .sidebar-header {
        padding: 30px 20px;
        text-align: center;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
    }
    
    .logo-img {
        width: 80px; height: 80px; 
        border-radius: 50%; 
        border: 4px solid rgba(255,255,255,0.3);
        margin-bottom: 10px;
        object-fit: cover;
    }

    .nav-menu {
        flex: 1;
        overflow-y: auto;
        padding: 20px 10px;
    }

    .nav-item {
        padding: 12px 20px;
        margin-bottom: 8px;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.2s;
        color: var(--text);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 15px;
        opacity: 0.8;
    }

    .nav-item:hover, .nav-item.active {
        background: var(--primary);
        color: white;
        opacity: 1;
        transform: translateX(-5px);
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
    }

    /* === Main Content === */
    .main-content {
        margin-right: var(--sidebar-w);
        padding: 30px;
        transition: 0.3s;
        min-height: 100vh;
    }

    /* === Header & Stats === */
    .top-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(128,128,128,0.1);
    }

    .stat-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 25px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
        transition: 0.3s;
        border: 1px solid rgba(128,128,128,0.1);
    }
    .stat-card:hover { transform: translateY(-5px); }
    
    .stat-icon {
        width: 60px; height: 60px;
        border-radius: 15px;
        display: flex; align-items: center; justify-content: center;
        font-size: 24px;
        position: absolute;
        top: 20px; left: 20px;
        opacity: 0.2;
    }
    .st-blue { background: var(--primary); color: white; }
    .st-green { background: var(--success); color: white; }
    .st-orange { background: var(--warning); color: #333; }

    /* === Advanced Tables === */
    .pro-table-container {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 20px;
        box-shadow: var(--shadow);
        overflow: hidden;
    }
    
    .table {
        color: var(--text);
        border-color: rgba(128,128,128,0.1);
    }
    .table thead th {
        background: rgba(67, 97, 238, 0.05);
        color: var(--primary);
        font-weight: 700;
        border: none;
        padding: 15px;
    }
    .table td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid rgba(128,128,128,0.1);
    }

    /* === Cards (Codes/Students) === */
    .code-card {
        background: var(--card-bg);
        border: 1px dashed var(--primary);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        position: relative;
        cursor: pointer;
        transition: 0.2s;
    }
    .code-card.selected {
        background: rgba(67, 97, 238, 0.1);
        border-style: solid;
        border-width: 2px;
    }
    .code-num { font-family: monospace; font-size: 1.5rem; font-weight: 800; letter-spacing: 2px; color: var(--primary); }

    /* === Mobile & Utility === */
    .hidden { display: none !important; }
    .loader-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
        z-index: 9999; display: flex; flex-direction: column;
        justify-content: center; align-items: center; color: white;
        transition: opacity 0.3s;
    }
    
    #loader-actions {
        margin-top: 20px;
        display: none;
        animation: fadeIn 0.5s;
        text-align: center;
    }

    @media (max-width: 992px) {
        .sidebar { transform: translateX(100%); width: 100%; max-width: 300px; }
        .sidebar.active { transform: translateX(0); }
        .main-content { margin-right: 0; padding: 15px; }
        .mobile-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none;
        }
        .mobile-overlay.active { display: block; }
    }

    /* Animation */
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
    .view-section { animation: fadeIn 0.4s ease-out; }
    
    /* Social Inputs */
    .social-input-group .input-group-text { width: 45px; justify-content: center; }
</style>
</head>
<body>

<!-- Loader -->
<div id="loader" class="loader-overlay">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
    <h5 id="loader-txt">ุฌุงุฑู ุงูุงุชุตุงู ุจุงููุธุงู...</h5>
    <div id="loader-actions">
        <p class="text-white-50 small mb-2">ุงุณุชุบุฑู ุงูุงุชุตุงู ููุชุงู ุทูููุงูุ</p>
        <button class="btn btn-outline-light btn-sm" onclick="location.reload()">ุชุญุฏูุซ ุงูุตูุญุฉ</button>
        <button class="btn btn-danger btn-sm" onclick="forceChangeAPI()">ุชุบููุฑ ุฑุงุจุท ุงููุธุงู</button>
        <button class="btn btn-link text-white btn-sm d-block mx-auto mt-2" onclick="showLoader(false)">ุฅุบูุงู ูุณุฑู</button>
    </div>
</div>

<div class="mobile-overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" class="logo-img" alt="Logo">
        <h5 class="mb-0 fw-bold">ููุญุฉ ุงููุฏูุฑ</h5>
        <small style="opacity:0.8">ุงูุฅุตุฏุงุฑ ุงูุงุญุชุฑุงูู 5.0</small>
    </div>
    <div class="nav-menu">
        <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-th-large"></i> ุงูุฑุฆูุณูุฉ</div>
        <div class="nav-item" onclick="nav('students', this)"><i class="fas fa-user-graduate"></i> ุงูุทูุงุจ</div>
        <div class="nav-item" onclick="nav('codes', this)"><i class="fas fa-barcode"></i> ุงูุฃููุงุฏ ูุงูุจุทุงูุงุช</div>
        <div class="nav-item" onclick="nav('results', this)"><i class="fas fa-chart-pie"></i> ุงููุชุงุฆุฌ</div>
        <div class="nav-item" onclick="nav('library', this)"><i class="fas fa-book"></i> ุงูููุชุจุฉ ูุงููููุงุช</div>
        <div class="nav-item" onclick="nav('assignments', this)"><i class="fas fa-tasks"></i> ุงููุงุฌุจุงุช</div>
        <div class="nav-item" onclick="nav('complaints', this)"><i class="fas fa-envelope-open-text"></i> ุงูุดูุงูู <span id="comp-badge" class="badge bg-danger rounded-pill ms-auto d-none">!</span></div>
        <div class="nav-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i> ุงูุฅุนุฏุงุฏุงุช</div>
    </div>
    <div class="p-3">
        <button class="btn btn-outline-danger w-100" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ุฎุฑูุฌ</button>
    </div>
</aside>

<!-- Main Content -->
<main class="main-content">
    <!-- Top Bar -->
    <div class="top-header">
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-light d-lg-none shadow-sm" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <div>
                <h4 class="fw-bold mb-0">ุฃููุงู ุจูุ ุงููุงุฆุฏ ๐</h4>
                <small class="text-muted">ูุธุงู ุฅุฏุงุฑุฉ ุงููุญุชูู ุงูุชุนูููู</small>
            </div>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-light shadow-sm rounded-circle" onclick="toggleTheme()" title="ุงููุถุน ุงููููู">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
            <button class="btn btn-primary shadow rounded-pill px-4" onclick="refreshAll()">
                <i class="fas fa-sync-alt me-2"></i> ุชุญุฏูุซ
            </button>
        </div>
    </div>

    <!-- 1. HOME DASHBOARD -->
    <div id="view-home" class="view-section">
        <!-- โ ูุธุงู ุงููุฑุงุณูุฉ ุงูุดุงูู -->
        <div class="stat-card mb-4 border-primary border">
            <h5 class="fw-bold mb-3 text-primary"><i class="fas fa-paper-plane"></i> ุฅุฑุณุงู ุชูุจููุงุช (Popups)</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="small text-muted mb-1">ุงูุฌูููุฑ ุงููุณุชูุฏู:</label>
                    <select class="form-select" id="notif-target">
                        <option value="All">๐ข ุงูุฌููุน (ุฑุณุงูุฉ ุนุงูุฉ)</option>
                        <option value="ุงูุซุงูุซ">ุงูุตู ุงูุซุงูุซ</option>
                        <option value="ุงูุฑุงุจุน">ุงูุตู ุงูุฑุงุจุน</option>
                        <option value="ุงูุฎุงูุณ">ุงูุตู ุงูุฎุงูุณ</option>
                        <option value="ุงูุณุงุฏุณ">ุงูุตู ุงูุณุงุฏุณ</option>
                        <option value="ุงูุณุงุจุน">ุงูุตู ุงูุณุงุจุน</option>
                        <option value="ุงูุซุงูู">ุงูุตู ุงูุซุงูู</option>
                        <option value="ุงูุชุงุณุน">ุงูุตู ุงูุชุงุณุน</option>
                        <option value="ุงูุนุงุดุฑ">ุงูุตู ุงูุนุงุดุฑ</option>
                        <option value="ุงูุฃูู ุซุงููู">ุงูุฃูู ุซุงููู</option>
                        <option value="ุงูุชูุฌููู">ุงูุชูุฌููู</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small text-muted mb-1">ุฃู ุทุงูุจ ูุญุฏุฏ (ุงูุจุฑูุฏ):</label>
                    <input type="text" class="form-control" id="notif-email" placeholder="example@gmail.com">
                </div>
                <div class="col-md-4">
                    <label class="small text-muted mb-1">ูุต ุงูุฑุณุงูุฉ:</label>
                    <input type="text" class="form-control" id="notif-msg" placeholder="ุงูุชุจ ุงูุชูุจูู ููุง...">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100 fw-bold" onclick="sendNotif()">ุฅุฑุณุงู</button>
                </div>
            </div>
            <div class="mt-2 text-muted small"><i class="fas fa-info-circle"></i> ุณูุธูุฑ ูุฐุง ูุฑุณุงูุฉ ููุจุซูุฉ ููุทุงูุจ ุนูุฏ ุฏุฎููู ุงูููุตุฉ.</div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <h6 class="text-muted">ุฅุฌูุงูู ุงูุทูุงุจ</h6>
                    <h2 class="fw-bold mb-0" id="st-total-std">0</h2>
                    <div class="stat-icon st-blue"><i class="fas fa-users"></i></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <h6 class="text-muted">ุงูุงูุชุญุงูุงุช ุงููุดุทุฉ</h6>
                    <h2 class="fw-bold mb-0" id="st-total-exam">0</h2>
                    <div class="stat-icon st-green"><i class="fas fa-file-alt"></i></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <h6 class="text-muted">ุงูุฃููุงุฏ ุงููุชุงุญุฉ</h6>
                    <h2 class="fw-bold mb-0" id="st-total-code">0</h2>
                    <div class="stat-icon st-orange"><i class="fas fa-ticket-alt"></i></div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="stat-card h-100">
                    <h5 class="fw-bold mb-3">ุฃุฏุงุก ุงูุทูุงุจ (ูุชูุณุท ุงูุฏุฑุฌุงุช)</h5>
                    <canvas id="chart-performance"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="stat-card h-100">
                    <h5 class="fw-bold mb-3">ุชูุฒูุน ุงูุทูุงุจ</h5>
                    <canvas id="chart-students"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. STUDENTS VIEW -->
    <div id="view-students" class="view-section hidden">
        <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
            <h4 class="fw-bold">ุฅุฏุงุฑุฉ ุงูุทูุงุจ</h4>
            <div class="d-flex gap-2">
                <input type="text" id="search-std" class="form-control" placeholder="ุจุญุซ ุจุงูุงุณู..." onkeyup="renderStudents()">
                <button class="btn btn-success" onclick="printIDCards()"><i class="fas fa-id-card"></i> ุทุจุงุนุฉ ุจุทุงูุงุช ูููุฉ</button>
            </div>
        </div>
        <div class="row g-3" id="students-grid"></div>
    </div>

    <!-- 3. CODES VIEW (Enhanced Printing) -->
    <div id="view-codes" class="view-section hidden">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="stat-card">
                    <h5 class="fw-bold mb-3 text-primary">ุชูููุฏ ุฃููุงุฏ ุฌุฏูุฏุฉ</h5>
                    <div class="mb-3">
                        <label>ุงูุนุฏุฏ:</label>
                        <input type="number" id="gen-count" class="form-control" value="10">
                    </div>
                    <div class="mb-3">
                        <label>ุงูุตู:</label>
                        <input type="text" id="gen-cls" class="form-control" placeholder="ูุซุงู: ุงูุนุงุดุฑ">
                    </div>
                    <div class="mb-3">
                        <label>ุงููุฏุฉ (ุฃูุงู):</label>
                        <select id="gen-days" class="form-select">
                            <option value="120">ูุตู (120 ููู)</option>
                            <option value="365">ุณูุฉ (365 ููู)</option>
                            <option value="7">ุชุฌุฑูุจู (7 ุฃูุงู)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="generateCodes()">ุชูููุฏ ูุญูุธ</button>
                </div>
            </div>
            
            <div class="col-lg-8">
                <div class="stat-card">
                    <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap gap-2">
                        <h5 class="fw-bold">ุงูุฃููุงุฏ</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            <select id="filter-code-cls" class="form-select form-select-sm" style="width: auto;" onchange="renderCodes()">
                                <option value="all">ูู ุงูุตููู</option>
                            </select>
                            <select id="filter-code-status" class="form-select form-select-sm" style="width: auto;" onchange="renderCodes()">
                                <option value="all">ูู ุงูุญุงูุงุช</option>
                                <option value="New">ุฌุฏูุฏ</option>
                                <option value="Used">ูุณุชุฎุฏู</option>
                            </select>
                            
                            <div class="dropdown">
                                <button class="btn btn-sm btn-dark dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-print"></i> ุทุจุงุนุฉ ุงูุจุทุงูุงุช
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="printFilteredCodes('selected')">ุทุจุงุนุฉ ุงููุญุฏุฏ ููุท</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="printFilteredCodes('view')">ุทุจุงุนุฉ ุงููุนุฑูุถ ุญุงููุงู</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="printFilteredCodes('new')">ุทุจุงุนุฉ ูู ุงูุฌุฏูุฏ</a></li>
                                </ul>
                            </div>
                            
                            <button class="btn btn-sm btn-success" onclick="exportCodesToExcel()"><i class="fas fa-file-excel"></i> ุชุตุฏูุฑ ุฅูุณู</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSelectedCodes()">ุญุฐู ุงููุญุฏุฏ</button>
                        </div>
                    </div>
                    
                    <div class="row g-2 mb-3 align-items-end p-2 border rounded bg-light">
                        <div class="col-md-5">
                            <label class="small text-muted">ุนููุงู ุงูุจุทุงูุฉ (ููุทุจุงุนุฉ):</label>
                            <input id="card-title-input" class="form-control form-control-sm" value="ููุตุฉ ูุจุฑุงุณ ุงูุชุนููููุฉ">
                        </div>
                        <div class="col-md-5">
                            <label class="small text-muted">ุชุนูููุงุช ุงูุชูุนูู:</label>
                            <input id="card-desc-input" class="form-control form-control-sm" value="ุงูุชุญ ุงููููุน: www.nebras.school ุซู ุงุฎุชุฑ 'ุชูุนูู ููุฏ'">
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center justify-content-between mb-2">
                         <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check-all-codes" onchange="toggleAllCodes(this)">
                            <label class="form-check-label user-select-none" for="check-all-codes">ุชุญุฏูุฏ ุงููู</label>
                        </div>
                        <span class="text-muted small" id="codes-count-badge">0 ููุฏ</span>
                    </div>

                    <div id="codes-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-height: 50vh; overflow-y: auto; padding: 5px;">
                        <!-- JS populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. RESULTS VIEW -->
    <div id="view-results" class="view-section hidden">
        <div class="d-flex justify-content-between mb-3 align-items-center">
            <h4 class="fw-bold">ุณุฌู ุงููุชุงุฆุฌ</h4>
            <button class="btn btn-success" onclick="exportToExcel('results-table')"><i class="fas fa-file-excel"></i> ุชุตุฏูุฑ Excel</button>
        </div>
        <div class="mb-3 row g-2">
            <div class="col-md-8"><input id="search-res" class="form-control" placeholder="ุจุญุซ ุจุงุณู ุงูุทุงูุจ ุฃู ุงูุงูุชุญุงู..." onkeyup="renderResults()"></div>
            <div class="col-md-4">
                <select id="filter-res-cls" class="form-select" onchange="renderResults()">
                    <option value="all">ุงููู</option>
                </select>
            </div>
        </div>
        <div class="pro-table-container">
            <div class="table-responsive" style="max-height: 70vh;">
                <table class="table table-hover mb-0" id="results-table">
                    <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูุทุงูุจ</th><th>ุงูุงูุชุญุงู</th><th>ุงูุฏุฑุฌุฉ</th><th>ุบุดุ</th><th>ุฅุฌุฑุงุก</th></tr></thead>
                    <tbody id="results-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. LIBRARY VIEW (Enhanced) -->
    <div id="view-library" class="view-section hidden">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <h5 class="fw-bold mb-3 text-primary">ุฅุถุงูุฉ ูุญุชูู ููููุชุจุฉ</h5>
                    <div class="mb-2">
                        <label class="small text-muted">ุนููุงู ุงูููู:</label>
                        <input id="lib-title" class="form-control" placeholder="ูุซุงู: ููุฎุต ุงููุญุฏุฉ ุงูุฃููู">
                    </div>
                    <div class="mb-2">
                        <label class="small text-muted">ุงููุงุฏุฉ:</label>
                        <input id="lib-subject" class="form-control" placeholder="ูุซุงู: ุงููุบุฉ ุงูุนุฑุจูุฉ">
                    </div>
                    <div class="mb-2">
                        <label class="small text-muted">ุงูุตู:</label>
                        <input id="lib-cls" class="form-control" placeholder="ูุซุงู: ุงูุนุงุดุฑ">
                    </div>
                    <div class="mb-2">
                        <label class="small text-muted">ุงูููุน:</label>
                        <select id="lib-type" class="form-select"><option value="PDF">ููู PDF</option><option value="Video">ููุฏูู</option></select>
                    </div>
                    <div class="mb-2">
                        <label class="small text-muted">ุฑุงุจุท ุงูููู/ุงูููุฏูู (ููุชุญููู):</label>
                        <input id="lib-link" class="form-control" placeholder="Google Drive Link...">
                        <small class="text-danger" style="font-size:10px">* ูุฐุง ุงูุฑุงุจุท ุณูุธูุฑ ููุทุงูุจ ุงููุดุชุฑู ููุท.</small>
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted">ูุตู ุงููุนุงููุฉ (SEO & Preview):</label>
                        <textarea id="lib-desc" class="form-control" rows="3" placeholder="ุงูุชุจ ูุจุฐุฉ ุชุธูุฑ ูู ูุญุฑูุงุช ุงูุจุญุซ ูููุทูุงุจ ุบูุฑ ุงููุดุชุฑููู..."></textarea>
                    </div>
                    <button class="btn btn-primary w-100" onclick="addToLib()">ูุดุฑ ูู ุงูููุชุจุฉ</button>
                </div>
            </div>
            <div class="col-md-8">
                <div class="pro-table-container">
                    <table class="table table-hover mb-0">
                        <thead><tr><th>ุงูุนููุงู</th><th>ุงููุงุฏุฉ</th><th>ุงูุตู</th><th>ุงููุตู</th><th>ุญุฐู</th></tr></thead>
                        <tbody id="lib-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. ASSIGNMENTS VIEW -->
    <div id="view-assignments" class="view-section hidden">
        <h4 class="fw-bold mb-3">ุงููุงุฌุจุงุช ุงููุฑุณูุฉ</h4>
        <div class="pro-table-container">
            <table class="table table-hover mb-0">
                <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูุทุงูุจ</th><th>ุงูููุน</th><th>ุงูููู</th><th>ุงูุฏุฑุฌุฉ</th><th>ุฑุตุฏ</th></tr></thead>
                <tbody id="assign-body"></tbody>
            </table>
        </div>
    </div>

    <!-- 7. COMPLAINTS VIEW -->
    <div id="view-complaints" class="view-section hidden">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold">ุตูุฏูู ุงูุดูุงูู</h4>
            <button class="btn btn-sm btn-light" onclick="refreshAll()"><i class="fas fa-sync"></i> ุชุญุฏูุซ</button>
        </div>
        <div class="pro-table-container">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูุงุณู</th><th>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th><th>ุงูุฑุณุงูุฉ</th><th>ุงูุฑุฏ</th></tr></thead>
                    <tbody id="comp-body">
                        <tr><td colspan="5" class="text-center text-muted">ุฌุงุฑู ุงูุชุญููู...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 8. SETTINGS VIEW -->
    <div id="view-settings" class="view-section hidden">
        <div class="row g-4">
            <!-- General Settings -->
            <div class="col-md-12 col-lg-4">
                <div class="stat-card mb-3">
                    <h5 class="fw-bold mb-3 text-primary"><i class="fas fa-sliders-h"></i> ุฅุนุฏุงุฏุงุช ุฃุณุงุณูุฉ</h5>
                    <div class="mb-3"><label>ุงุณู ุงููุนูู (ููุดูุงุฏุงุช):</label><input id="set-name" class="form-control"></div>
                    <div class="mb-3"><label>ุฑูู ุงููุงุชุณุงุจ (ููุชูุงุตู ุงูุนุงู):</label><input id="set-wa" class="form-control"></div>
                    <div class="mb-3"><label>ุญุงูุฉ ุงููุธุงู:</label>
                        <select id="set-maint" class="form-select"><option value="Off">ูุนูู</option><option value="On">ุตูุงูุฉ</option></select>
                    </div>
                </div>
            </div>

            <!-- Store & Packages Settings -->
            <div class="col-md-12 col-lg-8">
                <div class="stat-card mb-3">
                    <h5 class="fw-bold mb-3 text-warning"><i class="fas fa-store"></i> ุงููุชุฌุฑ ูุงูุจุงูุงุช</h5>
                    <div class="mb-3">
                        <label>ุฑูู ูุงุชุณุงุจ ุงููุชุฌุฑ/ุงูุงุดุชุฑุงู (ุจุฏูู +):</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fab fa-whatsapp text-success"></i></span>
                            <input id="soc-wa" class="form-control" placeholder="9627xxxxxxxx">
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <!-- Packages -->
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light">
                                <h6 class="fw-bold text-center">ุงูุจุงูุฉ ุงูุฃุณุงุณูุฉ</h6>
                                <input id="pkg-basic-name" class="form-control form-control-sm mb-2" placeholder="ุงูุงุณู">
                                <input id="price-basic" class="form-control form-control-sm mb-2" placeholder="ุงูุณุนุฑ">
                                <textarea id="pkg-basic-desc" class="form-control form-control-sm" rows="3" placeholder="ุงููููุฒุงุช"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light">
                                <h6 class="fw-bold text-center text-warning">ุงูุจุงูุฉ ุงูุฐูุจูุฉ</h6>
                                <input id="pkg-gold-name" class="form-control form-control-sm mb-2" placeholder="ุงูุงุณู">
                                <input id="price-gold" class="form-control form-control-sm mb-2" placeholder="ุงูุณุนุฑ">
                                <textarea id="pkg-gold-desc" class="form-control form-control-sm" rows="3" placeholder="ุงููููุฒุงุช"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light">
                                <h6 class="fw-bold text-center text-success">ุงูุจุงูุฉ ุงููุตููุฉ</h6>
                                <input id="pkg-term-name" class="form-control form-control-sm mb-2" placeholder="ุงูุงุณู">
                                <input id="price-term" class="form-control form-control-sm mb-2" placeholder="ุงูุณุนุฑ">
                                <textarea id="pkg-term-desc" class="form-control form-control-sm" rows="3" placeholder="ุงููููุฒุงุช"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Social & Danger Zone -->
            <div class="col-md-12 col-lg-4">
                <div class="stat-card mb-3">
                    <h5 class="fw-bold mb-3 text-success"><i class="fas fa-share-alt"></i> ุฑูุงุจุท ุงูุชูุงุตู</h5>
                    <div class="social-input-group mb-2 input-group">
                        <span class="input-group-text"><i class="fab fa-facebook text-primary"></i></span>
                        <input id="soc-fb" class="form-control" placeholder="ุฑุงุจุท ุงูููุณุจูู">
                    </div>
                    <div class="social-input-group mb-2 input-group">
                        <span class="input-group-text"><i class="fab fa-instagram text-danger"></i></span>
                        <input id="soc-ig" class="form-control" placeholder="ุฑุงุจุท ุงูุงูุณุชุฌุฑุงู">
                    </div>
                    <div class="social-input-group mb-2 input-group">
                        <span class="input-group-text"><i class="fab fa-youtube text-danger"></i></span>
                        <input id="soc-yt" class="form-control" placeholder="ุฑุงุจุท ุงูููุชููุจ">
                    </div>
                </div>

                <div class="stat-card border-danger border">
                    <h5 class="fw-bold text-danger mb-3"><i class="fas fa-exclamation-triangle"></i> ููุทูุฉ ุงูุฎุทุฑ ูุงูุตูุงูุฉ</h5>
                    <div class="row" id="reset-boxes">
                        <!-- JS populated -->
                    </div>
                    <button class="btn btn-danger w-100 mt-2" onclick="resetSystem()">ุชูููุฐ ุงูุญุฐู (ุฎุทุฑ)</button>
                    <button class="btn btn-warning w-100 mt-2 text-dark fw-bold" onclick="smartRepair()">๐๏ธ ุตูุงูุฉ ุงููุธุงู ูุฅุตูุงุญ ุงูุฌุฏุงูู</button>
                </div>
            </div>
            
            <!-- Class Groups -->
            <div class="col-md-12 col-lg-8"> 
                <div class="stat-card mb-3">
                    <h5 class="fw-bold mb-3 text-success"><i class="fab fa-whatsapp"></i> ุฑูุงุจุท ูุฌููุนุงุช ุงูุตููู</h5>
                    <div class="row g-3">
                        <div class="col-md-3"><label>ุงูุตู ุงูุซุงูุซ:</label><input id="set-group-3" class="form-control form-control-sm" placeholder="ุงูุฑุงุจุท"></div>
                        <div class="col-md-3"><label>ุงูุตู ุงูุฑุงุจุน:</label><input id="set-group-4" class="form-control form-control-sm" placeholder="ุงูุฑุงุจุท"></div>
                        <div class="col-md-3"><label>ุงูุตู ุงูุฎุงูุณ:</label><input id="set-group-5" class="form-control form-control-sm" placeholder="ุงูุฑุงุจุท"></div>
                        <div class="col-md-3"><label>ุงูุตู ุงูุณุงุฏุณ:</label><input id="set-group-6" class="form-control form-control-sm" placeholder="ุงูุฑุงุจุท"></div>
                        <div class="col-md-3"><label>ุงูุตู ุงูุณุงุจุน:</label><input id="set-group-7" class="form-control form-control-sm" placeholder="ุงูุฑุงุจุท"></div>
                        <div class="col-md-3"><label>ุงูุตู ุงูุซุงูู:</label><input id="set-group-8" class="form-control form-control-sm" placeholder="ุงูุฑุงุจุท"></div>
                        <div class="col-md-3"><label>ุงูุตู ุงูุชุงุณุน:</label><input id="set-group-9" class="form-control form-control-sm" placeholder="ุงูุฑุงุจุท"></div>
                        <div class="col-md-3"><label>ุงูุตู ุงูุนุงุดุฑ:</label><input id="set-group-10" class="form-control form-control-sm" placeholder="ุงูุฑุงุจุท"></div>
                        <div class="col-md-4"><label>ุงูุฃูู ุซุงููู:</label><input id="set-group-11" class="form-control form-control-sm" placeholder="ุงูุฑุงุจุท"></div>
                        <div class="col-md-4"><label>ุงูุชูุฌููู:</label><input id="set-group-12" class="form-control form-control-sm" placeholder="ุงูุฑุงุจุท"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-12">
                <button class="btn btn-primary w-100 btn-lg shadow" onclick="saveSettings()"><i class="fas fa-save"></i> ุญูุธ ูุงูุฉ ุงูุชุบููุฑุงุช</button>
            </div>
        </div>
    </div>

</main>

<script>
// ============================================
// โ๏ธ ูุงู: ุถุน ุฑุงุจุท ุงููุดุฑ (Web App URL) ููุง
let API_URL = "https://script.google.com/macros/s/AKfycbyJ8FX2Hd_OAakWU0Gbo35jcLq5b-tjwGdoGb4RimJtJCfgZqWnM4OSa7kGV-usUwgX/exec";
// ============================================

// Local State
let DB = { students: [], exams: [], codes: [], results: [], library: [], assignments: [], complaints: [] };
let CHARTS = {};
let loadTimer = null;

// Initialization
window.onload = function() {
    let savedUrl = localStorage.getItem('api_url');
    if(savedUrl) API_URL = savedUrl;
    
    // Check Theme
    if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    // Load Data
    refreshAll();
    
    // Init Danger Zone
    let tables = ['Students', 'Codes', 'Results', 'Library', 'Assignments', 'Complaints'];
    let h = '';
    tables.forEach(t => h+=`<div class="col-6"><div class="form-check"><input type="checkbox" class="form-check-input r-chk" value="${t}" id="r-${t}"><label class="form-check-label small" for="r-${t}">${t}</label></div></div>`);
    let rb = document.getElementById('reset-boxes');
    if(rb) rb.innerHTML = h;
};

// --- CORE FUNCTIONS ---
function showLoader(s) { 
    let l = document.getElementById('loader');
    let acts = document.getElementById('loader-actions');
    
    if(s) {
        l.style.display = 'flex';
        clearTimeout(loadTimer);
        acts.style.display = 'none';
        loadTimer = setTimeout(() => {
            if(l.style.display !== 'none') acts.style.display = 'block';
        }, 5000); 
    } else {
        l.style.display = 'none';
        clearTimeout(loadTimer);
    }
}

function forceChangeAPI() {
    let u = prompt('ุฃุฏุฎู ุฑุงุจุท ุงูุณูุฑูุจุช ุงูุฌุฏูุฏ (Web App URL):', API_URL);
    if(u && u.startsWith('http')) {
        localStorage.setItem('api_url', u);
        location.reload();
    }
}

async function callApi(action, payload={}) {
    showLoader(true);
    payload.action = action;
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); 

    try {
        let res = await fetch(API_URL, { 
            method: 'POST', 
            body: JSON.stringify(payload),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!res.ok) throw new Error("HTTP Error");
        
        let data = await res.json();
        showLoader(false);
        return data;
    } catch(e) {
        clearTimeout(timeoutId);
        showLoader(false);
        console.error(e);
        return null;
    }
}

async function refreshAll() {
    showLoader(true);
    try {
        let d = await callApi('getAdminData_V2'); 
        
        if (!d || !d.stats) {
            console.warn("V2 failed or missing stats, trying V1...");
            d = await callApi('getAdminData');
        }

        if(d && d.stats) {
            DB.codes = Array.isArray(d.codes) ? d.codes : [];
            
            // Parallel loading for better performance
            await Promise.all([
                loadSection('getStudentsForCards', d => { DB.students = Array.isArray(d) ? d : []; renderStudents(); }),
                loadSection('getAllResultsForAdmin', d => { DB.results = Array.isArray(d) ? d : []; renderResults(); }),
                loadSection('getComplaintsForAdmin', d => { DB.complaints = Array.isArray(d) ? d : []; renderComp(); })
            ]);
            
            updateCharts();

            document.getElementById('st-total-code').innerText = DB.codes.length;
            document.getElementById('st-total-exam').innerText = d.stats.exams || 0;
            document.getElementById('st-total-std').innerText = d.stats.students || 0;
            
            if(d.settings) {
                // Populate inputs logic (same as before)
                if(document.getElementById('set-name')) document.getElementById('set-name').value = d.settings['TeacherName'] || '';
                if(document.getElementById('set-wa')) document.getElementById('set-wa').value = d.settings['WhatsApp'] || '';
                if(document.getElementById('set-maint')) document.getElementById('set-maint').value = d.settings['Maintenance'] || 'Off';
                
                // ... (Populate other settings inputs like groups, packages etc.)
            }

            if(d.socials) {
                 if(document.getElementById('soc-wa')) document.getElementById('soc-wa').value = d.socials.whatsapp || '';
                 if(document.getElementById('soc-fb')) document.getElementById('soc-fb').value = d.socials.facebook || '';
                 if(document.getElementById('soc-ig')) document.getElementById('soc-ig').value = d.socials.instagram || '';
                 if(document.getElementById('soc-yt')) document.getElementById('soc-yt').value = d.socials.youtube || '';
            }

            renderCodes();
            populateFilters();
        }
    } catch(err) {
        console.error("Critical Error in refreshAll:", err);
    } finally {
        showLoader(false);
    }
}

async function loadSection(act, cb) {
    let d = await callApi(act);
    if(d) cb(d);
}

// --- NAVIGATION ---
function nav(view, el) {
    document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
    document.getElementById('view-'+view).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    
    // Lazy Load
    if(view === 'library') loadSection('getLibraryForAdmin', d => { DB.library = Array.isArray(d) ? d : []; renderLib(); });
    if(view === 'assignments') loadSection('getAssignmentsForAdmin', d => { DB.assignments = Array.isArray(d) ? d : []; renderAssign(); });
    
    if(window.innerWidth < 992) toggleSidebar();
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
    document.querySelector('.mobile-overlay').classList.toggle('active');
}

function toggleTheme() {
    let b = document.body;
    if(b.getAttribute('data-theme') === 'dark') {
        b.removeAttribute('data-theme'); localStorage.setItem('theme', 'light');
    } else {
        b.setAttribute('data-theme', 'dark'); localStorage.setItem('theme', 'dark');
    }
}

// --- CHARTS ---
function updateCharts() {
    let classes = {};
    if(DB.students) DB.students.forEach(s => { classes[s.cls] = (classes[s.cls]||0) + 1; });
    
    if(CHARTS.std) CHARTS.std.destroy();
    CHARTS.std = new Chart(document.getElementById('chart-students'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(classes),
            datasets: [{
                data: Object.values(classes),
                backgroundColor: ['#4361ee', '#3f37c9', '#4895ef', '#4cc9f0', '#f72585']
            }]
        }
    });

    let scores = {}; let counts = {};
    if(DB.results) DB.results.forEach(r => {
        let c = r.cls || 'ุบูุฑ ูุญุฏุฏ';
        scores[c] = (scores[c]||0) + parseFloat(r.score);
        counts[c] = (counts[c]||0) + 1;
    });
    let avgLabels = [], avgData = [];
    Object.keys(scores).forEach(k => {
        avgLabels.push(k);
        avgData.push(Math.round(scores[k] / counts[k]));
    });

    if(CHARTS.perf) CHARTS.perf.destroy();
    CHARTS.perf = new Chart(document.getElementById('chart-performance'), {
        type: 'bar',
        data: {
            labels: avgLabels,
            datasets: [{
                label: 'ูุชูุณุท ุงูุฏุฑุฌุงุช',
                data: avgData,
                backgroundColor: '#06d6a0',
                borderRadius: 5
            }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
    });
}

// --- RENDERERS ---

function renderStudents() {
    let s = document.getElementById('search-std').value.toLowerCase();
    let div = document.getElementById('students-grid');
    div.innerHTML = '';
    if(DB.students) DB.students.filter(x => String(x.name||'').toLowerCase().includes(s)).forEach(st => {
        div.innerHTML += `
        <div class="col-md-6 col-lg-4">
            <div class="stat-card d-flex align-items-center gap-3 p-3">
                <img src="${st.photo && st.photo.length > 20 ? st.photo : 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" 
                     style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--primary)">
                <div class="flex-grow-1 overflow-hidden">
                    <h6 class="fw-bold mb-1 text-truncate">${st.name}</h6>
                    <span class="badge bg-light text-dark border">${st.cls}</span>
                    <small class="d-block text-muted text-truncate mt-1">${st.email}</small>
                </div>
                
                <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-light text-warning" onclick="resetDev('${st.email}')" title="ูู ุญุธุฑ ุงูุฌูุงุฒ"><i class="fas fa-unlock"></i></button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item text-danger" onclick="delStudent('${st.email}')">ุญุฐู</a></li>
                            <li><a class="dropdown-item" onclick="changePass('${st.email}')">ุชุบููุฑ ุงูุณุฑ</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>`;
    });
}

function renderCodes() {
    let div = document.getElementById('codes-container');
    let fCls = document.getElementById('filter-code-cls').value;
    let fStats = document.getElementById('filter-code-status').value;
    
    div.innerHTML = '';
    
    let filtered = [];
    if(DB.codes) {
        filtered = DB.codes.filter(c => (fCls === 'all' || c.cls === fCls) && (fStats === 'all' || (fStats === 'New' && c.status === 'New') || (fStats === 'Used' && c.status !== 'New')));
        
        filtered.forEach(c => {
            let used = c.status !== 'New';
            div.innerHTML += `
            <div class="code-card ${used ? 'opacity-50' : ''}" onclick="selectCode(this)">
                <input type="checkbox" class="form-check-input position-absolute top-0 end-0 m-2 code-chk" value="${c.code}">
                <div class="code-num">${c.code}</div>
                <div class="d-flex justify-content-between mt-2 small">
                    <span class="badge ${used ? 'bg-secondary' : 'bg-success'}">${used ? 'ูุณุชุฎุฏู' : 'ุฌุฏูุฏ'}</span>
                    <span class="text-muted">${c.cls}</span>
                </div>
                ${c.days ? `<span class="badge bg-warning text-dark mt-1" style="font-size:10px">${c.days} ููู</span>` : ''}
            </div>`;
        });
    }
    document.getElementById('codes-count-badge').innerText = filtered.length + ' ููุฏ';
}

function renderResults() {
    let s = document.getElementById('search-res').value.toLowerCase();
    let f = document.getElementById('filter-res-cls').value;
    let tb = document.getElementById('results-body');
    tb.innerHTML = '';
    if(DB.results) DB.results.filter(r => (f==='all' || r.cls===f) && (String(r.name||'').toLowerCase().includes(s) || String(r.exam||'').toLowerCase().includes(s))).forEach(r => {
        tb.innerHTML += `
        <tr>
            <td>${r.date}</td>
            <td class="fw-bold">${r.name}</td>
            <td>${r.exam}</td>
            <td><span class="badge ${r.score>=50?'bg-success':'bg-danger'}">${r.score}%</span></td>
            <td>${r.cheats > 0 ? `<span class="text-danger fw-bold">${r.cheats}</span>` : '-'}</td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="delRes(${r.rowId})"><i class="fas fa-trash"></i></button></td>
        </tr>`;
    });
}

function renderLib() {
    let h=''; 
    // ุนุฑุถ ุงููุตู ุงููุฎุชุตุฑ ูู ุงูุฌุฏูู
    if(DB.library) DB.library.forEach(i => h+=`<tr><td>${i.title}</td><td>${i.subject}</td><td>${i.cls}</td><td><small class="text-muted text-truncate" style="max-width:150px;display:block">${i.desc || 'ูุง ููุฌุฏ ูุตู'}</small></td><td><button class="btn btn-sm btn-danger" onclick="delLib(${i.rowId})">ุญุฐู</button></td></tr>`);
    document.getElementById('lib-body').innerHTML = h || '<tr><td colspan="5" class="text-center text-muted">ูุง ููุฌุฏ ูุญุชูู</td></tr>';
}
function renderAssign() {
    let h=''; if(DB.assignments) DB.assignments.forEach(a => h+=`<tr><td>${a.date}</td><td>${a.name}</td><td>${a.type}</td><td><a href="${a.link}" target="_blank" class="btn btn-sm btn-info">ุนุฑุถ</a></td><td>${a.grade}</td><td><button class="btn btn-sm btn-primary" onclick="gradeAss(${a.rowId})">ุฑุตุฏ</button></td></tr>`);
    document.getElementById('assign-body').innerHTML = h || '<tr><td colspan="6" class="text-center text-muted">ูุง ุชูุฌุฏ ูุงุฌุจุงุช</td></tr>';
}
function renderComp() {
    let h=''; 
    if(DB.complaints && DB.complaints.length > 0) {
        DB.complaints.forEach(c => {
             h+=`<tr>
                <td>${c.date}</td>
                <td>${c.name}</td>
                <td>${c.email}</td>
                <td><div style="max-width:300px; white-space:normal;">${c.msg}</div></td>
                <td>${c.reply || `<button class="btn btn-sm btn-warning" onclick="replyComp(${c.rowId})">ุฑุฏ</button>`}</td>
             </tr>`;
        });
    } else {
        h = '<tr><td colspan="5" class="text-center text-muted">ูุง ุชูุฌุฏ ุฑุณุงุฆู</td></tr>';
    }
    document.getElementById('comp-body').innerHTML = h;
}

// --- ACTIONS ---

async function generateCodes() {
    let n = document.getElementById('gen-count').value;
    let c = document.getElementById('gen-cls').value;
    let d = document.getElementById('gen-days').value;
    if(!c) return Swal.fire('ุฎุทุฃ', 'ุฃุฏุฎู ุงูุตู', 'warning');
    await callApi('generateNewCodes', {count:n, cls:c, days:d});
    Swal.fire('ุชู', 'ุชู ุชูููุฏ ุงูุฃููุงุฏ', 'success');
    refreshAll();
}

function selectCode(el) {
    let chk = el.querySelector('.code-chk');
    chk.checked = !chk.checked;
    el.classList.toggle('selected', chk.checked);
}

function toggleAllCodes(source) {
    document.querySelectorAll('.code-chk').forEach(c => {
        c.checked = source.checked;
        c.parentElement.classList.toggle('selected', source.checked);
    });
}

async function deleteSelectedCodes() {
    let selected = [...document.querySelectorAll('.code-chk:checked')].map(c => c.value);
    if(selected.length == 0) return;
    if(confirm('ุญุฐู ุงูุฃููุงุฏ ุงููุญุฏุฏุฉุ')) {
        await callApi('deleteUsedCodes'); 
        Swal.fire('ุชู', 'ุชู ุชูุธูู ุงูุฃููุงุฏ ุงููุณุชุฎุฏูุฉ', 'info');
        refreshAll();
    }
}

async function addToLib() {
    let d = {
        title: document.getElementById('lib-title').value,
        subject: document.getElementById('lib-subject').value,
        type: document.getElementById('lib-type').value,
        cls: document.getElementById('lib-cls').value,
        link: document.getElementById('lib-link').value,
        desc: document.getElementById('lib-desc').value // New description field
    };
    if(!d.title || !d.link) return Swal.fire('ุฎุทุฃ', 'ุงูุนููุงู ูุงูุฑุงุจุท ูุทููุจุงู', 'warning');
    
    await callApi('addToLibrary', {d:d});
    Swal.fire('ุชู', 'ุชู ุงููุดุฑ ุจูุฌุงุญ', 'success');
    
    // Clear inputs
    document.getElementById('lib-title').value = '';
    document.getElementById('lib-link').value = '';
    document.getElementById('lib-desc').value = '';
    
    nav('library', document.querySelectorAll('.nav-item')[4]);
}

async function sendNotif() {
    let m = document.getElementById('notif-msg').value;
    let t = document.getElementById('notif-target').value;
    let email = document.getElementById('notif-email').value;
    let finalTarget = t;
    if(email && email.includes('@')) finalTarget = email;
    if(!m) return Swal.fire('ุชูุจูู', 'ุงูุฑุฌุงุก ูุชุงุจุฉ ูุต ุงูุฑุณุงูุฉ', 'warning');
    await callApi('sendTargetedMessage', {target:finalTarget, msg:m});
    Swal.fire('ุชู', 'ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจูุฌุงุญ', 'success');
}

async function delStudent(e) { if(confirm('ุญุฐูุ')) { await callApi('deleteStudent', {email:e}); refreshAll(); } }
async function resetDev(e) { await callApi('resetStudentDevice', {email:e}); Swal.fire('ุชู', 'ุชู ูู ุญุธุฑ ุงูุฌูุงุฒ ููุทุงูุจ', 'success'); }
async function changePass(e) { let p = prompt('ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ:'); if(p) await callApi('adminResetPass', {email:e, newPass:p}); }
async function delRes(id) { if(confirm('ุญุฐูุ')) { await callApi('deleteResultRow', {rowId:id}); refreshAll(); } }
async function delLib(id) { if(confirm('ุญุฐูุ')) { await callApi('deleteLibraryItem', {rowId:id}); nav('library', document.querySelectorAll('.nav-item')[4]); } }
async function gradeAss(id) { let g = prompt('ุงูุฏุฑุฌุฉ:'); if(g) { await callApi('gradeAssignment', {rowId:id, grade:g}); nav('assignments', document.querySelectorAll('.nav-item')[5]); } }
async function replyComp(id) { let r = prompt('ุงูุฑุฏ:'); if(r) { await callApi('replyToComplaint', {rowId:id, reply:r}); nav('complaints', document.querySelectorAll('.nav-item')[6]); } }

async function saveSettings() {
    let s = {
        'TeacherName': document.getElementById('set-name').value,
        'WhatsApp': document.getElementById('set-wa').value, 
        'Maintenance': document.getElementById('set-maint').value,
        
        'Pkg_Basic_Name': document.getElementById('pkg-basic-name').value,
        'Price_Basic': document.getElementById('price-basic').value,
        'Pkg_Basic_Desc': document.getElementById('pkg-basic-desc').value,
        
        'Pkg_Gold_Name': document.getElementById('pkg-gold-name').value,
        'Price_Gold': document.getElementById('price-gold').value,
        'Pkg_Gold_Desc': document.getElementById('pkg-gold-desc').value,

        'Pkg_Term_Name': document.getElementById('pkg-term-name').value,
        'Price_Term': document.getElementById('price-term').value,
        'Pkg_Term_Desc': document.getElementById('pkg-term-desc').value,
        
        'Group_ุงูุซุงูุซ': document.getElementById('set-group-3').value,
        'Group_ุงูุฑุงุจุน': document.getElementById('set-group-4').value,
        'Group_ุงูุฎุงูุณ': document.getElementById('set-group-5').value,
        'Group_ุงูุณุงุฏุณ': document.getElementById('set-group-6').value,
        'Group_ุงูุณุงุจุน': document.getElementById('set-group-7').value,
        'Group_ุงูุซุงูู': document.getElementById('set-group-8').value,
        'Group_ุงูุชุงุณุน': document.getElementById('set-group-9').value,
        'Group_ุงูุนุงุดุฑ': document.getElementById('set-group-10').value,
        'Group_ุงูุฃูู ุซุงููู': document.getElementById('set-group-11').value,
        'Group_ุงูุชูุฌููู': document.getElementById('set-group-12').value
    };
    
    let links = {
        'Facebook': document.getElementById('soc-fb').value,
        'Instagram': document.getElementById('soc-ig').value,
        'WhatsApp_Link': document.getElementById('soc-wa').value,
        'Youtube': document.getElementById('soc-yt').value
    };

    await Promise.all([
        callApi('saveGeneralSettings', {s:s}),
        callApi('saveSocialLinks', {links:links})
    ]);
    
    Swal.fire('ุชู', 'ุชู ุญูุธ ูุงูุฉ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ', 'success');
}

async function resetSystem() {
    let t = [...document.querySelectorAll('.r-chk:checked')].map(c => c.value);
    if(t.length === 0) return;
    let p = prompt('ุฃุฏุฎู ูููุฉ ูุฑูุฑ ุงููุณุคูู ููุชุฃููุฏ:');
    if(p === 'admin') { 
        await callApi('resetSpecificTables', {tables:t});
        Swal.fire('ุชู', 'ุชูุช ุฅุนุงุฏุฉ ุงูุถุจุท', 'success').then(()=>location.reload());
    }
}

async function smartRepair() {
    if(confirm('ูู ุชุฑูุฏ ุฅุฌุฑุงุก ูุญุต ูุตูุงูุฉ ุดุงููุฉ ูููุธุงูุ')) {
        await callApi('fullSystemSetup');
        Swal.fire('ุชู', 'ุชูุช ุตูุงูุฉ ุงููุธุงู ุจูุฌุงุญ ูุชุญุฏูุซ ุงููููููุฉ', 'success');
    }
}

// --- UTILS ---
function populateFilters() {
    let classes = [...new Set((DB.codes||[]).map(c => c.cls).filter(c => c))];
    let opts = '<option value="all">ูู ุงูุตููู</option>';
    classes.forEach(c => opts += `<option value="${c}">${c}</option>`);
    
    let cEl = document.getElementById('filter-code-cls');
    if(cEl) cEl.innerHTML = opts;

    let rEl = document.getElementById('filter-res-cls');
    if(rEl) rEl.innerHTML = opts.replace('ูู ุงูุตููู', 'ุงููู');
}

function exportToExcel(tableId) {
    let tbl = document.getElementById(tableId);
    let wb = XLSX.utils.table_to_book(tbl, {sheet:"Sheet1"});
    XLSX.writeFile(wb, 'Export_Data.xlsx');
}

function exportCodesToExcel() {
    let fCls = document.getElementById('filter-code-cls').value;
    let fStats = document.getElementById('filter-code-status').value;
    let selectedVals = [...document.querySelectorAll('.code-chk:checked')].map(c => c.value);

    let data = [];
    if (selectedVals.length > 0) {
         data = DB.codes.filter(c => selectedVals.includes(String(c.code)));
    } else {
         data = DB.codes.filter(c =>
            (fCls === 'all' || c.cls === fCls) &&
            (fStats === 'all' || (fStats === 'New' && c.status === 'New') || (fStats === 'Used' && c.status !== 'New'))
        );
    }

    if(data.length === 0) return Swal.fire('ุชูุจูู', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ', 'warning');

    let csvData = data.map(c => ({
        "ุงูููุฏ": c.code,
        "ุงูุตู": c.cls,
        "ุงููุฏุฉ (ุฃูุงู)": c.days,
        "ุงูุญุงูุฉ": c.status === 'New' ? 'ุฌุฏูุฏ' : 'ูุณุชุฎุฏู',
        "ุงููุณุชุฎุฏู": c.email || '-'
    }));

    let ws = XLSX.utils.json_to_sheet(csvData);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Codes");
    XLSX.writeFile(wb, "Codes_Export.xlsx");
}

function printIDCards() {
    let w = window.open('', '', 'width=900,height=600');
    let h = `<style>
        body { font-family: sans-serif; direction: rtl; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
        .card { border: 2px solid #333; border-radius: 10px; padding: 15px; display: flex; align-items: center; gap: 15px; page-break-inside: avoid; }
        img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
    </style>`;
    if(DB.students) DB.students.forEach(s => {
        let qr = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(s.email)}`;
        h += `<div class="card">
            <img src="${s.photo || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}">
            <div><h3>${s.name}</h3><p>${s.cls}</p><small>${s.email}</small></div>
            <img src="${qr}" style="border-radius:0; margin-right:auto">
        </div>`;
    });
    w.document.write(h);
    w.print();
}

function printFilteredCodes(mode) {
    let cardTitle = document.getElementById('card-title-input').value || 'ููุตุฉ ูุจุฑุงุณ ุงูุชุนููููุฉ';
    let cardDesc = document.getElementById('card-desc-input').value || 'ูุชูุนูู ุงูููุฏ: ุงูุชุญ ุงููููุน ูุงุฎุชุฑ ุงุดุชุฑุงู';

    // Modes: 'selected', 'view', 'new'
    let dataToPrint = [];
    
    if (mode === 'selected') {
        let selectedVals = [...document.querySelectorAll('.code-chk:checked')].map(c => c.value);
        if(selectedVals.length === 0) return Swal.fire('ุชูุจูู', 'ุญุฏุฏ ุฃููุงุฏ ุฃููุงู', 'warning');
        dataToPrint = DB.codes.filter(c => selectedVals.includes(String(c.code)));
    } 
    else if (mode === 'view') {
        let fCls = document.getElementById('filter-code-cls').value;
        let fStats = document.getElementById('filter-code-status').value;
        dataToPrint = DB.codes.filter(c => 
            (fCls === 'all' || c.cls === fCls) && 
            (fStats === 'all' || (fStats === 'New' && c.status === 'New') || (fStats === 'Used' && c.status !== 'New'))
        );
    }
    else if (mode === 'new') {
        dataToPrint = DB.codes.filter(c => c.status === 'New');
    }

    if(dataToPrint.length === 0) return Swal.fire('ุชูุจูู', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ููุทุจุงุนุฉ', 'info');

    let w = window.open('', '', 'width=900,height=600');
    
    // โ ุชุญุณูู ุชุตููู ุงูุทุจุงุนุฉ (ุจุทุงูุฉ ูุงููุฉ)
    let h = `
    <html>
    <head>
    <title>ุทุจุงุนุฉ ุงูุฃููุงุฏ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; direction: rtl; background: #fff; padding: 20px; }
        .grid-container { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 20px; 
        }
        .ticket { 
            border: 2px dashed #4361ee; 
            border-radius: 15px; 
            padding: 20px; 
            text-align: center; 
            page-break-inside: avoid; 
            background: #fff; 
            position: relative; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 200px;
        }
        .header {
            font-size: 18px;
            color: #4361ee;
            font-weight: 800;
            margin-bottom: 10px;
            text-transform: uppercase;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .code-box { 
            font-size: 32px; 
            font-weight: 900; 
            margin: 10px 0; 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 10px; 
            letter-spacing: 3px;
            border: 1px solid #ddd;
            font-family: monospace;
        }
        .details {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            color: #555;
            font-weight: bold;
            margin-top: 5px;
        }
        .footer {
            margin-top: 10px;
            font-size: 12px;
            color: #777;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 5px;
        }
        @media print {
            body { margin: 0; padding: 10px; }
            .ticket { box-shadow: none; border-color: #000; }
        }
    </style>
    </head>
    <body>
    <div class="grid-container">`;
    
    dataToPrint.forEach(c => {
        h += `
        <div class="ticket">
            <div class="header">๐ ${cardTitle}</div>
            <div class="code-box">${c.code}</div>
            <div class="details">
                <span><i class="fas fa-layer-group"></i> ${c.cls}</span>
                <span><i class="fas fa-clock"></i> ${c.days || 120} ููู</span>
            </div>
            <div class="footer">${cardDesc}</div>
        </div>`;
    });
    h += `</div></body></html>`;
    
    w.document.write(h);
    w.document.close();
    w.focus();
    setTimeout(() => { w.print(); }, 500);
}

function logout() {
    localStorage.removeItem('api_url');
    location.reload();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
