<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³ | Ø§Ù„Ù…Ø¯ÙŠØ± Pro</title>

<!-- =======================================================
     Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (CDN)
     ======================================================= -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<!-- SweetAlert2 Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Chart.js Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- SheetJS Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø§ÙƒØ³Ù„ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1e40af;
    --secondary: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #0f172a;
    --light: #f8fafc;
    --glass: rgba(255, 255, 255, 0.95);
    --sidebar-w: 280px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; color: #334155; overflow-x: hidden; font-size: 14px; }
  
  /* === Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ === */
  #global-loader {
    position: fixed; inset: 0; background: var(--glass); z-index: 99999;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    backdrop-filter: blur(5px); transition: opacity 0.3s;
  }
  .loader-spinner {
    width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: var(--primary);
    border-radius: 50%; animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* === Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¹Ø§Ù… === */
  .wrapper { display: flex; min-height: 100vh; }
  
  /* === Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ === */
  .sidebar {
    width: var(--sidebar-w); background: var(--dark); color: #fff;
    position: fixed; height: 100vh; right: 0; top: 0; z-index: 1000;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
  }
  .sidebar-header {
    padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center;
  }
  .logo-box img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--warning); object-fit: cover; box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
  .user-info { margin-top: 10px; }
  
  .nav-menu { flex: 1; padding: 15px 10px; overflow-y: auto; }
  .nav-item {
    padding: 12px 15px; margin-bottom: 5px; border-radius: 10px; cursor: pointer;
    color: #94a3b8; display: flex; align-items: center; gap: 12px; transition: all 0.2s;
    font-weight: 500; font-size: 15px;
  }
  .nav-item:hover, .nav-item.active { background: var(--primary); color: white; transform: translateX(-5px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
  .nav-item i { width: 24px; text-align: center; font-size: 1.1em; }
  
  .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.05); text-align: center; font-size: 12px; color: #64748b; }

  /* === Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ === */
  .main-content {
    flex: 1; margin-right: var(--sidebar-w); padding: 30px; transition: margin 0.3s; width: 100%;
  }
  .top-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
    background: white; padding: 15px 25px; border-radius: 15px; box-shadow: var(--shadow);
  }
  
  /* === Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© === */
  .stat-card {
    background: white; border-radius: 16px; padding: 25px; position: relative; overflow: hidden;
    box-shadow: var(--shadow); transition: transform 0.3s, box-shadow 0.3s; height: 100%; border: 1px solid #f1f5f9;
  }
  .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
  .stat-icon {
    width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-size: 28px; position: absolute; left: 20px; top: 50%; transform: translateY(-50%); opacity: 0.2;
  }
  .stat-info h3 { font-size: 2.5em; font-weight: 800; margin: 5px 0 0; color: #0f172a; }
  .stat-info p { color: #64748b; font-size: 14px; margin: 0; font-weight: 600; }
  
  /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
  .card-blue { border-bottom: 4px solid var(--primary); } .card-blue .stat-icon { background: var(--primary); color: var(--primary); opacity: 0.15; }
  .card-green { border-bottom: 4px solid var(--success); } .card-green .stat-icon { background: var(--success); color: var(--success); opacity: 0.15; }
  .card-orange { border-bottom: 4px solid var(--warning); } .card-orange .stat-icon { background: var(--warning); color: var(--warning); opacity: 0.15; }
  .card-purple { border-bottom: 4px solid #8b5cf6; } .card-purple .stat-icon { background: #8b5cf6; color: #8b5cf6; opacity: 0.15; }

  /* === Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© === */
  .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: var(--shadow); margin-bottom: 20px; }
  .table-header { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
  .table-responsive { overflow-x: auto; }
  .custom-table { width: 100%; border-collapse: collapse; white-space: nowrap; }
  .custom-table th { background: #f8fafc; padding: 15px 20px; text-align: right; font-weight: 700; color: #475569; border-bottom: 2px solid #e2e8f0; }
  .custom-table td { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
  .custom-table tr:hover td { background-color: #f8fafc; }
  
  /* === Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª === */
  .code-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; padding: 20px; max-height: 500px; overflow-y: auto; }
  .code-card {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; text-align: center;
    position: relative; transition: 0.2s; cursor: pointer; user-select: none;
  }
  .code-card:hover { border-color: var(--primary); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1); }
  .code-card.selected { background-color: #eff6ff; border-color: var(--primary); border-width: 2px; }
  .code-val { font-family: 'Courier New', monospace; font-size: 1.4em; font-weight: 900; letter-spacing: 2px; color: var(--dark); margin: 10px 0; }
  .code-meta { display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; }
  .code-chk { position: absolute; top: 10px; right: 10px; width: 18px; height: 18px; accent-color: var(--primary); }

  /* === Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª === */
  .form-control, .form-select { 
    padding: 12px 15px; border-radius: 10px; border: 1px solid #e2e8f0; font-size: 14px; transition: 0.3s; box-shadow: none; 
  }
  .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
  .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 14px; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
  .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
  .btn-primary { background: var(--primary); border: none; color: white; } .btn-primary:hover { background: var(--primary-dark); }
  .btn-success { background: var(--success); border: none; color: white; }
  .btn-danger { background: var(--danger); border: none; color: white; }
  .btn-warning { background: var(--warning); border: none; color: white; }

  /* === Ø§Ù„Ø´Ø§Ø±Ø§Øª (Badges) === */
  .badge-custom { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; }
  .bg-soft-success { background: #dcfce7; color: #166534; }
  .bg-soft-danger { background: #fee2e2; color: #991b1b; }
  .bg-soft-warning { background: #fef3c7; color: #92400e; }
  .bg-soft-primary { background: #dbeafe; color: #1e40af; }

  /* === Ø§Ù„ØªØ¬Ø§ÙˆØ¨ (Mobile) === */
  @media (max-width: 992px) {
    .sidebar { transform: translateX(100%); }
    .sidebar.active { transform: translateX(0); }
    .main-content { margin-right: 0; padding: 15px; }
    .top-header { padding: 15px; }
  }

  /* === Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© === */
  @media print {
    .sidebar, .top-header, .no-print, #global-loader { display: none !important; }
    .main-content { margin: 0; padding: 0; }
    body { background: white; -webkit-print-color-adjust: exact; }
  }
  
  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ø© -->
<div id="global-loader">
  <div class="loader-spinner"></div>
  <h4 class="mt-3 fw-bold" style="color:var(--primary)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h4>
  <p class="text-muted">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø§Øª</p>
  <div class="d-flex gap-2 mt-3">
    <button id="retry-btn" class="btn btn-outline-danger hidden" onclick="location.reload()">
        <i class="fas fa-sync-alt"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
    </button>
    <button id="change-url-btn" class="btn btn-outline-secondary hidden" onclick="changeApiUrl()">
        <i class="fas fa-link"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø·
    </button>
  </div>
</div>

<!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div class="wrapper">
  
  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo-box">
        <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" alt="Logo">
      </div>
      <div class="user-info">
        <h5 class="mb-0 fw-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h5>
        <small class="text-white-50">Admin Pro v3.0</small>
      </div>
    </div>
    
    <div class="nav-menu">
      <div class="nav-item active" onclick="navigate('home', this)">
        <i class="fas fa-home"></i> <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ù„Ø£ÙƒÙˆØ§Ø¯</span>
      </div>
      <div class="nav-item" onclick="navigate('students', this)">
        <i class="fas fa-user-graduate"></i> <span>Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø©</span>
      </div>
      <div class="nav-item" onclick="navigate('exams', this)">
        <i class="fas fa-file-alt"></i> <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</span>
      </div>
      <div class="nav-item" onclick="navigate('results', this)">
        <i class="fas fa-chart-bar"></i> <span>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
      </div>
      <div class="nav-item" onclick="navigate('library', this)">
        <i class="fas fa-book"></i> <span>Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</span>
      </div>
      <div class="nav-item" onclick="navigate('assignments', this)">
        <i class="fas fa-tasks"></i> <span>Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</span>
      </div>
      <div class="nav-item" onclick="navigate('complaints', this)">
        <i class="fas fa-envelope-open-text"></i> <span>Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</span>
      </div>
      <div class="nav-item" onclick="navigate('settings', this)">
        <i class="fas fa-cog"></i> <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</span>
      </div>
    </div>
    
    <div class="sidebar-footer">
      &copy; 2024 Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©
    </div>
  </nav>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <main class="main-content">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="top-header no-print">
      <div>
        <h4 class="mb-1 fw-bold">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø§Ù„Ù…Ø¯ÙŠØ± ğŸ‘‹</h4>
        <p class="text-muted mb-0">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ÙŠÙˆÙ…</p>
      </div>
      <div class="d-flex gap-2">
        <button onclick="loadAllData()" class="btn btn-light text-primary border shadow-sm">
          <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <button class="btn btn-primary d-lg-none" onclick="document.getElementById('sidebar').classList.toggle('active')">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 1. Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ (Home & Codes) -->
    <!-- ============================================ -->
    <div id="view-home" class="view-section">
      <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
      <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
          <div class="stat-card card-blue">
            <div class="stat-info">
              <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
              <h3 id="stat-students">0</h3>
            </div>
            <div class="stat-icon"><i class="fas fa-users"></i></div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="stat-card card-green">
            <div class="stat-info">
              <p>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù†Ø´Ø·Ø©</p>
              <h3 id="stat-active-codes">0</h3>
            </div>
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="stat-card card-orange">
            <div class="stat-info">
              <p>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©</p>
              <h3 id="stat-sales">$0</h3>
            </div>
            <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="stat-card card-purple">
            <div class="stat-info">
              <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</p>
              <h3 id="stat-exams">0</h3>
            </div>
            <div class="stat-icon"><i class="fas fa-file-contract"></i></div>
          </div>
        </div>
      </div>

      <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
      <div class="row g-4 mb-4">
        <div class="col-lg-8">
           <div class="table-container p-3 h-100">
              <h6 class="fw-bold mb-3">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ (Ø¬Ø¯ÙŠØ¯ vs Ù…Ø³ØªØ®Ø¯Ù…)</h6>
              <div style="height: 250px;"><canvas id="chart-codes"></canvas></div>
           </div>
        </div>
        <div class="col-lg-4">
           <div class="table-container p-3 h-100">
              <h6 class="fw-bold mb-3">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„</h6>
              <div style="height: 250px; display:flex; justify-content:center"><canvas id="chart-users"></canvas></div>
           </div>
        </div>
      </div>

      <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ -->
      <div class="row g-4">
        <!-- Ø§Ù„ØªÙˆÙ„ÙŠØ¯ -->
        <div class="col-lg-12">
          <div class="table-container">
            <div class="table-header">
               <h5 class="m-0 fw-bold text-primary"><i class="fas fa-barcode"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h5>
            </div>
            <div class="p-4">
               <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ -->
               <div class="row g-3 align-items-end mb-4 bg-light p-3 rounded">
                  <div class="col-md-3">
                     <label class="form-label fw-bold">Ø§Ù„Ø¹Ø¯Ø¯:</label>
                     <input type="number" id="gen-count" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹ 50">
                  </div>
                  <div class="col-md-3">
                     <label class="form-label fw-bold">Ø§Ù„ØµÙ:</label>
                     <input type="text" id="gen-cls" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø¹Ø§Ø´Ø±">
                  </div>
                  <div class="col-md-3">
                     <label class="form-label fw-bold">Ø§Ù„Ù…Ø¯Ø©:</label>
                     <select id="gen-days" class="form-select">
                        <option value="120" selected>ÙØµÙ„ Ø¯Ø±Ø§Ø³ÙŠ (120 ÙŠÙˆÙ…)</option>
                        <option value="365">Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø© (365 ÙŠÙˆÙ…)</option>
                        <option value="30">Ø´Ù‡Ø± ÙˆØ§Ø­Ø¯</option>
                        <option value="7">ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø£Ø³Ø¨ÙˆØ¹)</option>
                     </select>
                  </div>
                  <div class="col-md-3">
                     <button onclick="generateCodes()" class="btn btn-primary w-100">
                        <i class="fas fa-magic"></i> ØªÙˆÙ„ÙŠØ¯ ÙˆØ­ÙØ¸
                     </button>
                  </div>
               </div>

               <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… -->
               <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
                  <div class="d-flex gap-2 align-items-center">
                     <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="select-all-codes" onchange="toggleAllCodes(this)">
                        <label class="form-check-label fw-bold">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</label>
                     </div>
                     <span class="text-muted mx-2">|</span>
                     <button onclick="printCodes('cards')" class="btn btn-dark btn-sm"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø§Øª</button>
                     <button onclick="printCodes('list')" class="btn btn-secondary btn-sm"><i class="fas fa-list"></i> Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø§Ø¦Ù…Ø©</button>
                     <button onclick="deleteSelectedCodes()" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                  </div>
                  <div class="d-flex gap-2">
                     <input id="search-codes" class="form-control form-control-sm" placeholder="Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯..." onkeyup="renderCodes()">
                     <select id="filter-codes-cls" class="form-select form-select-sm" onchange="renderCodes()"><option value="all">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option></select>
                     <select id="filter-codes-st" class="form-select form-select-sm" onchange="renderCodes()">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                        <option value="New" selected>Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·</option>
                        <option value="Used">Ù…Ø³ØªØ®Ø¯Ù…Ø©</option>
                     </select>
                  </div>
               </div>
               
               <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ -->
               <div id="codes-grid" class="code-grid bg-light rounded border">
                  <!-- Ø³ÙŠØªÙ… Ø§Ù„Ù…Ù„Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
               </div>
            </div>
          </div>
        </div>

        <!-- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
        <div class="col-lg-12">
            <div class="table-container p-4 bg-dark text-white" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);">
               <h5 class="mb-3"><i class="fas fa-bullhorn text-warning"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h5>
               <div class="row g-3">
                  <div class="col-md-3">
                     <select id="notif-target" class="form-select"><option value="All">Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</option></select>
                  </div>
                  <div class="col-md-3">
                     <input id="notif-email" class="form-control" placeholder="Ø£Ùˆ Ù„Ø·Ø§Ù„Ø¨ Ù…Ø­Ø¯Ø¯ (Ø§Ù„Ø¨Ø±ÙŠØ¯)">
                  </div>
                  <div class="col-md-4">
                     <input id="notif-msg" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§...">
                  </div>
                  <div class="col-md-2">
                     <button onclick="sendNotification()" class="btn btn-warning w-100 fw-bold">Ø¥Ø±Ø³Ø§Ù„</button>
                  </div>
               </div>
            </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 2. Ø§Ù„Ø·Ù„Ø§Ø¨ (Students) -->
    <!-- ============================================ -->
    <div id="view-students" class="view-section hidden">
       <div class="table-container">
          <div class="table-header">
             <h5 class="m-0 fw-bold"><i class="fas fa-user-graduate"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h5>
             <div class="d-flex gap-2">
                <input id="search-std" class="form-control form-control-sm" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." onkeyup="renderStudents()">
                <button onclick="printStudentIDs()" class="btn btn-success btn-sm"><i class="fas fa-id-card"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‡ÙˆÙŠØ§Øª</button>
             </div>
          </div>
          <div class="table-responsive">
             <table class="custom-table table-hover">
                <thead>
                   <tr>
                      <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                      <th>Ø§Ù„Ø§Ø³Ù…</th>
                      <th>Ø§Ù„ØµÙ</th>
                      <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                      <th>Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±</th>
                      <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                      <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                   </tr>
                </thead>
                <tbody id="students-body"></tbody>
             </table>
          </div>
       </div>
    </div>

    <!-- ============================================ -->
    <!-- 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª (Exams) -->
    <!-- ============================================ -->
    <div id="view-exams" class="view-section hidden">
       <div class="table-container">
          <div class="table-header">
             <h5 class="m-0 fw-bold"><i class="fas fa-file-alt"></i> Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h5>
          </div>
          <div class="table-responsive">
             <table class="custom-table table-hover">
                <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                <tbody id="exams-body"></tbody>
             </table>
          </div>
       </div>
    </div>

    <!-- ============================================ -->
    <!-- 4. Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Results) -->
    <!-- ============================================ -->
    <div id="view-results" class="view-section hidden">
       <div class="table-container">
          <div class="table-header">
             <h5 class="m-0 fw-bold"><i class="fas fa-poll"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</h5>
             <div class="d-flex gap-2">
                <input id="search-res" class="form-control form-control-sm" placeholder="Ø¨Ø­Ø«..." onkeyup="renderResults()">
                <button onclick="exportToExcel()" class="btn btn-success btn-sm"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel</button>
             </div>
          </div>
          <div class="table-responsive">
             <table class="custom-table table-hover">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th><th>Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØºØ´</th><th>Ø­Ø°Ù</th></tr></thead>
                <tbody id="results-body"></tbody>
             </table>
          </div>
       </div>
    </div>

    <!-- ============================================ -->
    <!-- 5. Ø§Ù„Ù…ÙƒØªØ¨Ø© (Library) -->
    <!-- ============================================ -->
    <div id="view-library" class="view-section hidden">
       <div class="row g-4">
          <div class="col-md-4">
             <div class="table-container p-4">
                <h5 class="fw-bold mb-3 text-primary">Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰</h5>
                <div class="mb-3"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label><input id="lib-title" class="form-control"></div>
                <div class="mb-3"><label>Ø§Ù„Ù†ÙˆØ¹:</label><select id="lib-type" class="form-select"><option value="PDF">Ù…Ù„Ù PDF</option><option value="Video">ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨</option></select></div>
                <div class="mb-3"><label>Ø§Ù„ØµÙ:</label><input id="lib-cls" class="form-control" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ÙƒÙ„"></div>
                <div class="mb-3"><label>Ø§Ù„Ø±Ø§Ø¨Ø·:</label><input id="lib-link" class="form-control" placeholder="https://..."></div>
                <button onclick="addToLibrary()" class="btn btn-primary w-100">Ù†Ø´Ø±</button>
             </div>
          </div>
          <div class="col-md-8">
             <div class="table-container">
                <div class="table-header"><h5 class="m-0">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</h5></div>
                <table class="custom-table"><thead><tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØµÙ</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="library-body"></tbody></table>
             </div>
          </div>
       </div>
    </div>

    <!-- ============================================ -->
    <!-- 6. Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª (Assignments) -->
    <!-- ============================================ -->
    <div id="view-assignments" class="view-section hidden">
       <div class="table-container">
          <div class="table-header"><h5 class="m-0 fw-bold">ØªØ³Ù„ÙŠÙ…Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</h5></div>
          <div class="table-responsive">
             <table class="custom-table table-hover">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ§Ø¬Ø¨</th><th>Ø§Ù„Ù…Ù„Ù</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø±ØµØ¯</th></tr></thead>
                <tbody id="assignments-body"></tbody>
             </table>
          </div>
       </div>
    </div>

    <!-- ============================================ -->
    <!-- 7. Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ (Complaints) -->
    <!-- ============================================ -->
    <div id="view-complaints" class="view-section hidden">
       <div class="table-container">
          <div class="table-header"><h5 class="m-0 fw-bold">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯</h5></div>
          <div class="table-responsive">
             <table class="custom-table">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th><th>Ø§Ù„Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="complaints-body"></tbody>
             </table>
          </div>
       </div>
    </div>

    <!-- ============================================ -->
    <!-- 8. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Settings) -->
    <!-- ============================================ -->
    <div id="view-settings" class="view-section hidden">
       <div class="row g-4">
          <div class="col-md-6">
             <div class="table-container p-4">
                <h5 class="fw-bold mb-3 text-primary">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ©</h5>
                <div class="mb-3"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… (Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª):</label><input id="set-name" class="form-control"></div>
                <div class="mb-3"><label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù„Ù„Ø¯Ø¹Ù…):</label><input id="set-wa" class="form-control"></div>
                <div class="mb-3"><label>ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©:</label>
                   <select id="set-maint" class="form-select">
                      <option value="Off">ğŸŸ¢ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„</option>
                      <option value="On">ğŸ”´ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ØºÙ„Ù‚ Ù„Ù„ØµÙŠØ§Ù†Ø©</option>
                   </select>
                </div>
                <button onclick="saveSettings()" class="btn btn-primary w-100">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
             </div>
          </div>
          <div class="col-md-6">
             <div class="table-container p-4 border-danger" style="border-right: 5px solid #ef4444;">
                <h5 class="fw-bold text-danger">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø± (ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</h5>
                <p class="text-muted small">Ø­Ø¯Ø¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:</p>
                <div class="row g-2 mb-3" id="reset-checkboxes">
                   <!-- Checkboxes generated via JS -->
                </div>
                <button onclick="resetSystem()" class="btn btn-outline-danger w-100">ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙ‡ÙŠØ¦Ø© (Ø­Ø°Ù)</button>
             </div>
          </div>
       </div>
    </div>

  </main>
</div>

<!-- ======================= -->
<!-- JS Logic (Backend Connection) -->
<!-- ======================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// =======================================================
// âš ï¸ Ù‡Ø§Ù…: Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø´Ø± (Web App URL) Ù‡Ù†Ø§
// =======================================================
let API_URL = "https://script.google.com/macros/s/AKfycbyJ8FX2Hd_OAakWU0Gbo35jcLq5b-tjwGdoGb4RimJtJCfgZqWnM4OSa7kGV-usUwgX/exec"; 
// =======================================================

// Ù…Ø®Ø²Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠ
let db = { codes:[], students:[], exams:[], results:[], library:[], assignments:[], complaints:[] };

// Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
window.onload = function() {
    let savedUrl = localStorage.getItem('api_url');
    if(savedUrl) API_URL = savedUrl;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ checkboxes Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    let tables = ['Students', 'Exams', 'Questions', 'Results', 'Codes', 'Assignments', 'Library', 'Complaints'];
    let h = '';
    tables.forEach(t => h += `<div class="col-6"><div class="form-check"><input class="form-check-input chk-reset" type="checkbox" value="${t}"><label class="form-check-label small">${t}</label></div></div>`);
    document.getElementById('reset-checkboxes').innerHTML = h;

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© (Direct Call)
    loadAllData();
};

function updateStatus(msg, type, details) {
    let el = document.getElementById('global-loader');
    let txt = el.querySelector('h4');
    let subTxt = el.querySelector('p');
    let btnRetry = document.getElementById('retry-btn');
    let btnChange = document.getElementById('change-url-btn');

    txt.innerText = msg;
    
    if(type=='success') {
        el.style.display = 'none';
        btnRetry.classList.add('hidden');
        btnChange.classList.add('hidden');
    } else if(type=='error') {
        el.style.display = 'flex';
        subTxt.innerText = details || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø¥Ù†ØªØ±Ù†Øª";
        btnRetry.classList.remove('hidden');
        btnChange.classList.remove('hidden');
    } else {
        el.style.display = 'flex';
        btnRetry.classList.add('hidden');
        btnChange.classList.add('hidden');
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ HTML Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
document.getElementById('retry-btn').insertAdjacentHTML('afterend', 
    `<button id="change-url-btn" class="btn btn-outline-secondary mt-3 hidden" onclick="changeApiUrl()" style="margin-right:10px">
        <i class="fas fa-link"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø·
    </button>`
);

function changeApiUrl() {
    let newUrl = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Web App URL Ø§Ù„Ø¬Ø¯ÙŠØ¯:", API_URL);
    if (newUrl && newUrl.trim() !== "") {
        localStorage.setItem('api_url', newUrl.trim());
        location.reload();
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ø¨Ø³Ø·Ø© Ù„ØªØ¹Ù…Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©)
async function api(action, payload={}) {
    payload.action = action;
    try {
        // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚Øª Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ±Ù†Øª Ø§Ù„Ø¨Ø·ÙŠØ¡
        const response = await fetch(API_URL, { 
            method: 'POST', 
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
        return await response.json();
    } catch(e) {
        console.error(e);
        return { success: false, message: "Network Error" };
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„Ø©
async function loadAllData() {
    updateStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...", "connecting");
    
    if(API_URL.includes("/dev")) {
        updateStatus("Ø®Ø·Ø£: Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ /dev", "error", "Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· /exec");
        return;
    }

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø± Ø¯ÙˆÙ† ÙØ­ÙˆØµØ§Øª Ù…Ø³Ø¨Ù‚Ø©
    let data = await api('getAdminData');
    
    if(data && data.codes) {
        db.codes = data.codes;
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        document.getElementById('stat-students').innerText = data.stats.students;
        document.getElementById('stat-exams').innerText = data.stats.exams;
        document.getElementById('stat-active-codes').innerText = data.stats.codes;
        
        let used = db.codes.filter(c => c.status === 'Used').length;
        document.getElementById('stat-sales').innerText = '$' + (used * 5); // ØªÙ‚Ø¯ÙŠØ±ÙŠ 5$

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        if(data.settings) {
            if(document.getElementById('set-name')) document.getElementById('set-name').value = data.settings['TeacherName']||'';
            if(document.getElementById('set-wa')) document.getElementById('set-wa').value = data.settings['WhatsApp']||'';
            if(document.getElementById('set-maint')) document.getElementById('set-maint').value = data.settings['Maintenance']||'Off';
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ±
        updateFilters();
        
        // Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù…Ø®Ø·Ø·Ø§Øª
        renderCodes();
        initCharts(used, db.codes.length - used);
        
        updateStatus("ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„", "success");
    } else {
        let errorMsg = data && data.message ? data.message : "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©";
        updateStatus("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„!", "error", errorMsg);
    }
}

// Ø§Ù„ØªÙ†Ù‚Ù„
function navigate(view, el) {
    document.querySelectorAll('.view-section').forEach(d => d.classList.add('hidden'));
    document.getElementById('view-'+view).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    
    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¶ØºØ· Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    if(view === 'students') api('getStudentsForCards').then(d => { db.students = d; renderStudents(); });
    if(view === 'exams') api('getExamsForAdminControl').then(d => { db.exams = d; renderExams(); });
    if(view === 'results') api('getAllResultsForAdmin').then(d => { db.results = d; renderResults(); });
    if(view === 'library') api('getLibraryForAdmin').then(d => { db.library = d; renderLibrary(); });
    if(view === 'assignments') api('getAssignmentsForAdmin').then(d => { db.assignments = d; renderAssignments(); });
    if(view === 'complaints') api('getComplaintsForAdmin').then(d => { db.complaints = d; renderComplaints(); });
    
    if(window.innerWidth < 992) document.getElementById('sidebar').classList.remove('active');
}

// === Charts ===
function initCharts(used, brandNew) {
    const ctx1 = document.getElementById('chart-codes').getContext('2d');
    new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: ['Ø¬Ø¯ÙŠØ¯Ø©', 'Ù…Ø³ØªØ®Ø¯Ù…Ø©'],
            datasets: [{ label: 'Ø§Ù„Ø£ÙƒÙˆØ§Ø¯', data: [brandNew, used], backgroundColor: ['#10b981', '#64748b'] }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
    
    const ctx2 = document.getElementById('chart-users').getContext('2d');
    new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['Ù…ÙØ¹Ù„', 'ØºÙŠØ± Ù…ÙØ¹Ù„'],
            datasets: [{ data: [used, brandNew], backgroundColor: ['#2563eb', '#cbd5e1'] }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

// === 1. Codes Management ===
function updateFilters() {
    let classes = [...new Set(db.codes.map(c=>c.cls).filter(c=>c))];
    let opts = '<option value="all">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>';
    classes.forEach(c => opts += `<option value="${c}">${c}</option>`);
    
    ['filter-codes-cls', 'notif-target'].forEach(id => {
        let el = document.getElementById(id);
        if(el) {
             if(id==='notif-target') el.innerHTML = '<option value="All">Ù„Ù„Ø¬Ù…ÙŠØ¹</option>' + opts.replace('ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ','');
             else el.innerHTML = opts;
        }
    });
}

function renderCodes() {
    let s = document.getElementById('search-codes').value.toLowerCase();
    let cls = document.getElementById('filter-codes-cls').value;
    let st = document.getElementById('filter-codes-st').value;
    
    let filtered = db.codes.filter(c => {
        return (cls === 'all' || c.cls === cls) &&
               (st === 'all' || c.status === st) &&
               (c.code.toString().includes(s) || (c.email && c.email.includes(s)));
    });

    let h = '';
    if(filtered.length === 0) h = '<div class="text-center p-3 w-100">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
    
    filtered.forEach(c => {
        let badge = c.status === 'New' ? '<span class="badge bg-soft-success">Ø¬Ø¯ÙŠØ¯</span>' : '<span class="badge bg-secondary">Ù…Ø³ØªØ®Ø¯Ù…</span>';
        let dayBadge = c.days < 30 ? '<span class="badge bg-soft-danger">ØªØ¬Ø±ÙŠØ¨ÙŠ</span>' : `<span class="badge bg-soft-primary">${c.days} ÙŠÙˆÙ…</span>`;
        
        h += `
        <div class="code-card ${c.status==='Used'?'bg-light':''}" onclick="toggleCode(this)">
           <input type="checkbox" class="code-chk form-check-input" value="${c.code}" onclick="event.stopPropagation()">
           <div class="code-meta">
              <span>${c.cls}</span>
              <span>${c.status}</span>
           </div>
           <div class="code-val">${c.code}</div>
           <div class="d-flex justify-content-center gap-1 mb-2">${badge} ${dayBadge}</div>
           ${c.email ? `<div class="small text-truncate text-muted" title="${c.email}">${c.email}</div>` : ''}
        </div>`;
    });
    document.getElementById('codes-grid').innerHTML = h;
}

function toggleCode(el) {
    let chk = el.querySelector('.code-chk');
    chk.checked = !chk.checked;
    el.classList.toggle('selected', chk.checked);
}
function toggleAllCodes(m) {
    document.querySelectorAll('.code-chk').forEach(c => {
        c.checked = m.checked;
        c.closest('.code-card').classList.toggle('selected', m.checked);
    });
}

async function generateCodes() {
    let count = document.getElementById('gen-count').value;
    let cls = document.getElementById('gen-cls').value;
    let days = document.getElementById('gen-days').value;
    
    if(!count || !cls) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯ ÙˆØ§Ù„ØµÙ','warning');
    
    Swal.fire({title:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...', didOpen:()=>Swal.showLoading()});
    let res = await api('generateNewCodes', {count:count, cls:cls, days:days});
    Swal.close();
    if(res.success !== false) { Swal.fire('ØªÙ…',res,'success').then(loadAllData); }
    else Swal.fire('Ø®Ø·Ø£',res.message,'error');
}

async function deleteSelectedCodes() {
    let sel = Array.from(document.querySelectorAll('.code-chk:checked')).map(c=>c.value);
    if(!sel.length) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø­Ø¯Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù„Ù„Ø­Ø°Ù','info');
    
    if(confirm(`Ø­Ø°Ù ${sel.length} ÙƒÙˆØ¯ØŸ`)) {
        Swal.fire({title:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...', didOpen:()=>Swal.showLoading()});
        await api('cleanDatabase', {tables:['Codes']}); 
        Swal.close();
        Swal.fire('ØªÙ…','ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©','success').then(loadAllData);
    }
}

// === Printing ===
function printCodes(mode) {
    let sel = Array.from(document.querySelectorAll('.code-chk:checked')).map(c=>c.value);
    let list = sel.length ? db.codes.filter(c=>sel.includes(String(c.code))) : db.codes.filter(c=>c.status==='New'); 
    
    if(!list.length) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª','info');
    
    let content = '';
    if(mode === 'cards') {
        content = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-family:Tajawal">';
        list.forEach(c => {
            content += `
            <div style="border:2px dashed #333; padding:15px; text-align:center; height:140px; page-break-inside:avoid; display:flex; flex-direction:column; justify-content:center; border-radius:10px; background:#f8fafc">
               <h4 style="margin:0; color:#2563eb">Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h4>
               <div style="font-size:24px; font-weight:900; letter-spacing:2px; margin:5px 0; border:1px solid #ccc; background:white">${c.code}</div>
               <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:bold">
                  <span>${c.cls}</span> <span>${c.days} ÙŠÙˆÙ…</span>
               </div>
               <div style="font-size:10px; color:#666">Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</div>
            </div>`;
        });
        content += '</div>';
    } else {
        content = '<table style="width:100%; border-collapse:collapse; text-align:center; font-family:Tajawal" border="1"><thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>';
        list.forEach(c => content += `<tr><td>${c.code}</td><td>${c.cls}</td><td>${c.status}</td></tr>`);
        content += '</tbody></table>';
    }
    
    let w = window.open('','','width=900,height=700');
    w.document.write(`<html><head><title>Ø·Ø¨Ø§Ø¹Ø©</title></head><body dir="rtl">${content}</body></html>`);
    w.document.close();
    setTimeout(()=>w.print(), 500);
}

// === 2. Students & Devices ===
function renderStudents() {
    let s = document.getElementById('search-std').value.toLowerCase();
    let body = document.getElementById('students-body');
    let h = '';
    
    db.students.forEach(st => {
        if(st.name.toLowerCase().includes(s) || st.email.includes(s)) {
            let statusBadge = st.deviceId ? '<span class="badge bg-success">Ù…Ø±ØªØ¨Ø·</span>' : '<span class="badge bg-secondary">ØºÙŠØ± Ù…Ø±ØªØ¨Ø·</span>';
            h += `<tr>
                <td><img src="${st.photo||'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" width="40" height="40" style="border-radius:50%"></td>
                <td class="fw-bold">${st.name}</td>
                <td><span class="badge bg-soft-primary">${st.cls}</span></td>
                <td class="text-muted small">${st.email}</td>
                <td class="small">Active</td>
                <td>${statusBadge}</td>
                <td>
                   <div class="btn-group">
                      <button onclick="resetPass('${st.email}')" class="btn btn-sm btn-light border" title="ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><i class="fas fa-key"></i></button>
                      <button onclick="resetDevice('${st.email}')" class="btn btn-sm btn-warning text-white" title="ÙÙƒ Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²"><i class="fas fa-mobile-alt"></i></button>
                      <button onclick="delStd('${st.email}')" class="btn btn-sm btn-danger" title="Ø­Ø°Ù"><i class="fas fa-trash"></i></button>
                   </div>
                </td>
            </tr>`;
        }
    });
    body.innerHTML = h;
}

// Actions
async function resetDevice(email) {
    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ÙÙƒ Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯ØŸ')) {
        let r = await api('resetStudentDevice', {email:email});
        Swal.fire(r.success?'ØªÙ…':'Ø®Ø·Ø£', r.message, r.success?'success':'error');
    }
}
async function resetPass(email) {
    let p = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
    if(p) await api('adminResetPass', {email:email, newPass:p}).then(r=>Swal.fire('ØªÙ…',r,'success'));
}
async function delStd(email) {
    if(confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) { await api('deleteStudent', {email:email}); navTo('students', document.querySelectorAll('.nav-item')[1]); }
}

function printStudentIDs() {
    let h = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; font-family:Tajawal; direction:rtl">';
    db.students.forEach(s => {
        h += `<div style="border:2px solid #000; padding:10px; display:flex; align-items:center; gap:15px; border-radius:10px; page-break-inside:avoid">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(s.email)}" width="80">
                <div>
                   <h3 style="margin:0">${s.name}</h3>
                   <p style="margin:5px 0">Ø§Ù„ØµÙ: ${s.cls}</p>
                   <small>${s.email}</small>
                </div>
              </div>`;
    });
    h += '</div>';
    let w = window.open('','','width=900'); w.document.write(h); w.document.close(); setTimeout(()=>w.print(), 500);
}

// === 3. Exams Control ===
function renderExams() {
    let body = document.getElementById('exams-body');
    let h = '';
    if(db.exams) {
        db.exams.forEach(ex => {
            let btnClass = ex.status === 'Hidden' ? 'btn-secondary' : 'btn-success';
            let btnText = ex.status === 'Hidden' ? 'Ù…Ø®ÙÙŠ (Ø¥Ø¸Ù‡Ø§Ø±)' : 'Ù†Ø´Ø· (Ø¥Ø®ÙØ§Ø¡)';
            let newStatus = ex.status === 'Hidden' ? 'Active' : 'Hidden';
            
            h += `<tr>
                    <td class="fw-bold">${ex.title}</td>
                    <td>${ex.cls || 'Ø¹Ø§Ù…'}</td>
                    <td><span class="badge ${ex.status==='Hidden'?'bg-secondary':'bg-success'}">${ex.status||'Active'}</span></td>
                    <td><button onclick="toggleExam('${ex.title}', '${newStatus}')" class="btn btn-sm ${btnClass}">${btnText}</button></td>
                  </tr>`;
        });
    }
    body.innerHTML = h || '<tr><td colspan="4" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</td></tr>';
}
async function toggleExam(t, s) {
    await api('toggleExamVisibility', {title:t, status:s});
    navTo('exams', document.querySelectorAll('.nav-item')[2]);
}

// === 4. Results ===
function renderResults() {
    let s = document.getElementById('search-res').value.toLowerCase();
    let h = '';
    db.results.forEach(r => {
        if(r.name.toLowerCase().includes(s) || r.exam.toLowerCase().includes(s)) {
            h += `<tr>
                <td>${r.date}</td>
                <td class="fw-bold">${r.name}</td>
                <td><span class="badge bg-light text-dark border">${r.cls}</span></td>
                <td>${r.exam}</td>
                <td><span class="badge ${parseInt(r.score)>=50?'bg-success':'bg-danger'}">${r.score}</span></td>
                <td>${r.cheats || 0}</td>
                <td><button onclick="delRes(${r.rowId})" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        }
    });
    document.getElementById('results-body').innerHTML = h;
}
async function delRes(id) { if(confirm('Ø­Ø°ÙØŸ')) { await api('deleteResultRow',{rowId:id}); navTo('results', document.querySelectorAll('.nav-item')[3]); } }

function exportToExcel() {
    let data = db.results.map(r => ({ "Ø§Ù„ØªØ§Ø±ÙŠØ®":r.date, "Ø§Ù„Ø·Ø§Ù„Ø¨":r.name, "Ø§Ù„ØµÙ":r.cls, "Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†":r.exam, "Ø§Ù„Ø¯Ø±Ø¬Ø©":r.score }));
    let ws = XLSX.utils.json_to_sheet(data);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Results");
    XLSX.writeFile(wb, "Ø§Ù„Ù†ØªØ§Ø¦Ø¬.xlsx");
}

// === 5. Library ===
function renderLibrary() {
    let h = '';
    db.library.forEach(i => {
        h += `<tr><td>${i.title}</td><td>${i.type}</td><td>${i.cls}</td><td><button onclick="delLib(${i.rowId})" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></td></tr>`;
    });
    document.getElementById('library-body').innerHTML = h;
}
async function addToLibrary() {
    let d = {
        title: document.getElementById('lib-title').value,
        type: document.getElementById('lib-type').value,
        cls: document.getElementById('lib-cls').value,
        link: document.getElementById('lib-link').value
    };
    if(!d.title) return;
    await api('addToLibrary', {d:d});
    Swal.fire('ØªÙ…','','success');
    navTo('library', document.querySelectorAll('.nav-item')[4]);
}
async function delLib(id) { if(confirm('Ø­Ø°ÙØŸ')) { await api('deleteLibraryItem', {rowId:id}); navTo('library', document.querySelectorAll('.nav-item')[4]); } }

// === 6. Assignments ===
function renderAssignments() {
    let h = '';
    db.assignments.forEach(a => {
        h += `<tr>
            <td>${a.date}</td>
            <td class="fw-bold">${a.name}</td>
            <td>${a.type}</td>
            <td><a href="${a.link}" target="_blank" class="btn btn-sm btn-outline-primary">Ø¹Ø±Ø¶</a></td>
            <td>${a.grade}</td>
            <td><button onclick="gradeAss(${a.rowId})" class="btn btn-sm btn-primary">Ø±ØµØ¯</button></td>
        </tr>`;
    });
    document.getElementById('assignments-body').innerHTML = h;
}
async function gradeAss(id) { let g=prompt('Ø§Ù„Ø¯Ø±Ø¬Ø©:'); if(g) await api('gradeAssignment',{rowId:id, grade:g}); }

// === 7. Complaints ===
function renderComplaints() {
    let h = '';
    db.complaints.forEach(c => {
        h += `<tr>
            <td>${c.date}</td>
            <td class="fw-bold">${c.name}</td>
            <td>${c.msg}</td>
            <td>${c.reply || '<span class="text-muted">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯</span>'}</td>
            <td><button onclick="replyComp(${c.rowId})" class="btn btn-sm btn-info text-white">Ø±Ø¯</button></td>
        </tr>`;
    });
    document.getElementById('complaints-body').innerHTML = h;
}
async function replyComp(id) { let r=prompt('Ø§Ù„Ø±Ø¯:'); if(r) await api('replyToComplaint',{rowId:id, reply:r}); }

// === 8. Settings & Notification ===
async function saveSettings() {
    let s = { 
        'TeacherName': document.getElementById('set-name').value, 
        'WhatsApp': document.getElementById('set-wa').value, 
        'Maintenance': document.getElementById('set-maint').value 
    };
    await api('saveGeneralSettings', {s:s});
    Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸','','success');
}

async function sendNotification() {
    let t = document.getElementById('notif-target').value;
    let e = document.getElementById('notif-email').value;
    let m = document.getElementById('notif-msg').value;
    if(!m) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©','warning');
    
    await api('sendTargetedMessage', {target: e||t, msg:m});
    Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„','','success');
}

async function resetSystem() {
    let selected = Array.from(document.querySelectorAll('.chk-reset:checked')).map(c => c.value);
    if(selected.length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ø®ØªØ± Ø¬Ø¯ÙˆÙ„Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
    
    let {value:pass} = await Swal.fire({title:'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', input:'password'});
    
    if(pass === 'admin') {
        Swal.fire({title:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...', didOpen:()=>Swal.showLoading()});
        await api('resetSpecificTables', {tables:selected});
        Swal.close();
        Swal.fire('ØªÙ…','ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©','success').then(() => location.reload());
    } else {
        Swal.fire('Ø®Ø·Ø£','ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©','error');
    }
}
</script>
</body>
</html>
