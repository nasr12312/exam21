<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base target="_top">
    
    <title><?= pageTitle ?> | منصة نبراس التعليمية</title>
    <meta name="description" content="<?= pageDesc ?>">
    <meta name="keywords" content="<?= pageKeywords ?>">
    
    <!-- الخطوط -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- المكتبات الخارجية -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- مكتبات الكتاب التفاعلي (Flipbook & PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.js"></script>

<style>
  /* =========================================
     1. المتغيرات والتنسيق الأساسي (Global CSS)
     ========================================= */
  :root { 
    --bg: #0f172a; 
    --glass: rgba(30, 41, 59, 0.95); 
    --glass-hover: rgba(51, 65, 85, 0.95);
    --border: rgba(255, 255, 255, 0.1);
    --blue: #3b82f6; 
    --blue-dark: #1d4ed8;
    --gold: #f59e0b; 
    --red: #ef4444; 
    --green: #10b981; 
    --text: #f8fafc;
    --text-muted: #94a3b8;
  }
  
  [data-theme="light"] {
    --bg: #f8fafc; 
    --glass: rgba(255, 255, 255, 0.95); 
    --glass-hover: rgba(241, 245, 249, 0.95);
    --border: rgba(0, 0, 0, 0.1); 
    --text: #0f172a; 
    --text-muted: #64748b;
    --blue: #2563eb;
  }
  
  * { box-sizing: border-box; }
  
  body { 
    background: var(--bg); 
    color: var(--text); 
    font-family: 'Tajawal', sans-serif; 
    margin: 0; padding: 0; 
    min-height: 100vh;
    transition: background 0.5s, color 0.5s;
    background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,0.5) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,0.5) 0, transparent 50%);
    scroll-behavior: smooth;
    overflow-x: hidden;
  }
  
  .container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; }
  .hidden { display: none !important; }
  
  /* =========================================
     2. عناصر الواجهة المشتركة (UI Components)
     ========================================= */
  
  /* الأزرار */
  .btn { 
    padding: 12px 24px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; 
    font-family: 'Tajawal'; font-size: 16px; transition: all 0.3s ease; 
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    text-decoration: none;
  }
  .btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
  .btn:active { transform: scale(0.98); }
  
  .btn-p { background: linear-gradient(135deg, var(--blue), var(--blue-dark)); color: white; }
  .btn-g { background: linear-gradient(135deg, var(--gold), #d97706); color: white; }
  .btn-r { background: linear-gradient(135deg, var(--red), #b91c1c); color: white; }
  .btn-o { background: transparent; border: 1px solid var(--border); color: var(--text); }
  .btn-o:hover { background: var(--border); }
  
  /* البطاقات */
  .card { 
    background: var(--glass); border: 1px solid var(--border); border-radius: 20px; 
    padding: 30px; margin-bottom: 25px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1); 
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); transition: 0.3s;
  }
  
  /* حقول الإدخال */
  input, select, textarea { 
    width: 100%; padding: 15px; margin-bottom: 15px; background: rgba(128,128,128,0.1); 
    border: 1px solid var(--border); border-radius: 12px; color: var(--text); 
    font-family: 'Tajawal'; font-size: 16px; outline: none; transition: 0.3s;
  }
  input:focus, select:focus, textarea:focus { 
    border-color: var(--blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); 
  }
  
  /* الشبكة */
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  
  /* =========================================
     3. القائمة العلوية (Navbar)
     ========================================= */
  .landing-nav {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 0; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 1000; background: var(--bg);
      backdrop-filter: blur(20px);
  }
  .nav-logo { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1.4em; color: var(--text); cursor:pointer; }
  .nav-logo img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--gold); }
  
  .nav-links { display: flex; gap: 25px; }
  .nav-links a { color: var(--text); text-decoration: none; font-weight: 500; transition: 0.3s; position: relative; }
  .nav-links a:hover { color: var(--blue); }
  .nav-links a::after { content:''; position: absolute; bottom:-5px; left:0; width:0; height:2px; background:var(--blue); transition:0.3s; }
  .nav-links a:hover::after { width:100%; }
  
  .nav-buttons { display: flex; gap: 10px; align-items: center; }
  
  @media (max-width: 768px) { 
      .nav-links { display: none; } 
      .nav-logo span { display: none; }
  }

  /* =========================================
     4. الصفحة الرئيسية (Landing Page)
     ========================================= */
  .hero-section { text-align: center; padding: 80px 0 100px; animation: fadeIn 1s; }
  .hero-logo { width: 180px; height: 180px; border-radius: 50%; border: 4px solid var(--gold); margin-bottom: 30px; animation: float 6s infinite ease-in-out; box-shadow: 0 0 50px rgba(245, 158, 11, 0.3); }
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  
  .hero-title { font-family: 'Amiri'; font-size: 3.5em; color: var(--blue); margin-bottom: 15px; text-shadow: 0 0 30px rgba(59, 130, 246, 0.3); }
  .hero-subtitle { font-size: 1.4em; color: var(--text-muted); max-width: 700px; margin: 0 auto 40px; line-height: 1.6; }
  
  .section-header { text-align: center; margin: 80px 0 40px; position: relative; }
  .section-header h2 { font-family: 'Amiri'; font-size: 2.8em; color: var(--gold); }
  .section-header::after { content:''; display: block; width: 60px; height: 4px; background: var(--blue); margin: 10px auto; border-radius: 2px; }
  
  .feature-box { background: var(--glass); padding: 40px 30px; border-radius: 20px; border: 1px solid var(--border); text-align: center; transition: 0.3s; }
  .feature-box:hover { transform: translateY(-10px); border-color: var(--blue); }
  .feature-icon { font-size: 3.5em; color: var(--gold); margin-bottom: 20px; }
  
  /* الأسعار */
  .price-card { background: var(--glass); padding: 40px; border-radius: 20px; border: 1px solid var(--border); text-align: center; transition: 0.3s; position: relative; }
  .price-card:hover { transform: scale(1.03); border-color: var(--blue); }
  .price-card.popular { border: 2px solid var(--gold); transform: scale(1.05); z-index: 1; }
  .price-card.popular::before { content:'الأكثر طلباً'; position:absolute; top:15px; right:-35px; background:var(--gold); color:#000; padding:5px 40px; transform:rotate(45deg); font-weight:bold; font-size:12px; }
  .plan-price { font-size: 3em; font-family: 'Amiri'; color: var(--blue); font-weight: bold; margin: 20px 0; }
  .plan-features { list-style: none; padding: 0; text-align: right; margin-bottom: 30px; }
  .plan-features li { padding: 8px 0; color: var(--text-muted); border-bottom: 1px solid var(--border); }
  .plan-features li i { color: var(--green); margin-left: 10px; }
  
  /* =========================================
     5. المكتبة العامة والكتاب التفاعلي (Flipbook)
     ========================================= */
  #public-library-ui { animation: fadeIn 0.5s; }
  .search-box { display: flex; gap: 10px; background: var(--glass); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid var(--border); flex-wrap: wrap; }
  
  .file-card { background: var(--glass); border: 1px solid var(--border); padding: 25px; border-radius: 15px; text-align: center; transition: 0.3s; cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
  .file-card:hover { transform: translateY(-5px); border-color: var(--blue); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .file-icon { font-size: 4em; color: var(--gold); margin-bottom: 15px; transition: 0.3s; }
  .file-card:hover .file-icon { transform: scale(1.1); }
  .file-meta { display: flex; justify-content: space-between; font-size: 0.85em; color: var(--text-muted); margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
  
  /* عارض الكتاب */
  #book-view { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
  .book-header { width: 100%; max-width: 1000px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .book-stage { width: 100%; height: 85vh; max-width: 1200px; display: flex; justify-content: center; align-items: center; position: relative; perspective: 1500px; }
  .flip-book { display: none; background-color: #f8fafc; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
  
  .page { padding: 0; background-color: white; color: black; border: 1px solid #ddd; overflow: hidden; display: flex; flex-direction: column; }
  .page-content { flex: 1; display: flex; justify-content: center; align-items: flex-start; width: 100%; overflow: hidden; position: relative; }
  canvas.pdf-canvas { max-width: 100%; height: 100% !important; object-fit: contain; }
  .page-footer { position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 12px; color: #888; background: rgba(255,255,255,0.8); }
  
  /* صفحة الغلاف */
  .page-cover { 
    background: linear-gradient(135deg, #1e3a8a, var(--blue)); color: white; height: 100%; 
    display: flex; flex-direction: column; justify-content: center; align-items: center; 
    text-align: center; border: 8px solid var(--gold); padding: 40px;
  }
  /* صفحة القفل */
  .page-lock { 
    background: #f1f5f9; height: 100%; display: flex; flex-direction: column; 
    justify-content: center; align-items: center; text-align: center; 
    border: 10px double var(--red); color: #333; padding: 40px;
  }
  
  /* Iframe Fallback (Google Drive) */
  .iframe-container { width: 100%; height: 100%; background: white; border-radius: 10px; overflow: hidden; position: relative; }
  .doc-iframe { width: 100%; height: 100%; border: none; }
  .iframe-overlay { 
    position: absolute; bottom: 0; left: 0; width: 100%; height: 200px; 
    background: linear-gradient(to top, rgba(255,255,255,1) 20%, rgba(255,255,255,0.8) 60%, transparent 100%); 
    display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 40px; 
  }
  
  /* =========================================
     6. لوحة الطالب (Student Dashboard)
     ========================================= */
  #v-dash { animation: fadeIn 0.5s; }
  .dash-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
  .user-info { display: flex; align-items: center; gap: 20px; }
  .user-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--blue); object-fit: cover; }
  .user-details h2 { margin: 0; font-size: 1.5em; color: var(--text); }
  .user-details span { color: var(--gold); font-size: 0.9em; background: rgba(245, 158, 11, 0.1); padding: 2px 10px; border-radius: 10px; }
  
  /* التبويبات */
  .nav-tabs { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; background: var(--glass); padding: 5px; border-radius: 15px; border: 1px solid var(--border); }
  .nav-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 10px; font-weight: bold; color: var(--text-muted); transition: 0.3s; min-width: 100px; }
  .nav-tab:hover { background: rgba(255,255,255,0.05); }
  .nav-tab.active { background: var(--blue); color: white; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3); }
  
  /* الامتحانات */
  .exam-item { display: flex; align-items: center; justify-content: space-between; padding: 20px; background: var(--glass); border: 1px solid var(--border); border-radius: 15px; cursor: pointer; transition: 0.3s; }
  .exam-item:hover { border-color: var(--blue); background: var(--glass-hover); transform: translateX(-5px); }
  .exam-info h3 { margin: 0; font-size: 1.2em; }
  .exam-info p { margin: 5px 0 0; font-size: 0.9em; color: var(--text-muted); }
  
  /* واجهة الامتحان */
  #v-exam { max-width: 900px; margin: 0 auto; }
  .exam-progress { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 15px; }
  .progress-bar { height: 100%; background: var(--green); width: 0%; transition: 0.5s; }
  .question-box { margin-top: 30px; }
  .q-text { font-size: 1.3em; font-weight: bold; margin-bottom: 25px; line-height: 1.6; }
  .q-option { padding: 18px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.03); }
  .q-option:hover { background: rgba(255,255,255,0.05); }
  .q-option.selected { border-color: var(--blue); background: rgba(59, 130, 246, 0.1); }
  .q-circle { width: 24px; height: 24px; border: 2px solid var(--text-muted); border-radius: 50%; transition: 0.2s; }
  .q-option.selected .q-circle { border-color: var(--blue); background: var(--blue); }
  
  /* الجداول */
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th { text-align: right; padding: 15px; color: var(--gold); border-bottom: 1px solid var(--border); }
  td { padding: 15px; border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  
  /* =========================================
     7. الإضافات (Loader, Modals, etc)
     ========================================= */
  #loader { position: fixed; inset: 0; background: rgba(15,23,42,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
  .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top-color: var(--blue); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  #wa-btn { position: fixed; bottom: 30px; right: 30px; background: #25D366; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 5000; transition: 0.3s; }
  #wa-btn:hover { transform: scale(1.1) rotate(10deg); }
  
  #theme-toggle { position: fixed; top: 30px; left: 30px; z-index: 5000; background: var(--glass); border: 1px solid var(--border); padding: 10px; border-radius: 50%; cursor: pointer; }
  
  /* مودال الشهادة */
  #cert-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display: none; justify-content: center; align-items: center; overflow: auto; padding: 20px; }
  .cert-container { background: white; padding: 50px; width: 900px; max-width: 100%; border-radius: 20px; text-align: center; color: #000; position: relative; border: 10px double #1e3a8a; }
  .cert-header h1 { font-family: 'Amiri'; font-size: 4em; color: #1e3a8a; margin: 0; }
  .cert-body { margin: 40px 0; font-size: 1.5em; }
  .cert-name { font-size: 2.5em; color: #d97706; font-family: 'Amiri'; margin: 20px 0; border-bottom: 2px solid #eee; display: inline-block; padding: 0 50px 10px; }
  .stamp { position: absolute; bottom: 40px; left: 50px; width: 150px; opacity: 0.8; transform: rotate(-15deg); }
</style>
</head>
<body>

<!-- Loader -->
<div id="loader">
  <div class="spinner"></div>
  <p style="margin-top:20px; color:white">جاري التحميل...</p>
</div>

<!-- Floating Buttons -->
<a id="wa-btn" href="#" target="_blank" class="hidden"><i class="fab fa-whatsapp"></i></a>
<button id="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>

<!-- ==================== 1. LANDING PAGE ==================== -->
<div id="landing-page" class="hidden">
  <div class="container">
    <nav class="landing-nav">
       <div class="nav-logo" onclick="goHome()">
          <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" alt="Logo">
          <span>نبراس التعليمية</span>
       </div>
       <div class="nav-links">
          <a onclick="goHome()">الرئيسية</a>
          <a onclick="showPublicLibrary()">المكتبة</a>
          <a onclick="navTo('features')">المميزات</a>
          <a onclick="navTo('store')">الباقات</a>
          <a onclick="navTo('reviews')">الآراء</a>
       </div>
       <div class="nav-buttons">
           <button class="btn btn-o" onclick="showAuth('register')">تفعيل كود</button>
           <button class="btn btn-p" onclick="showAuth('login')">دخول</button>
       </div>
    </nav>
    
    <div id="home-view">
        <div class="hero-section">
           <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" class="hero-logo">
           <h1 class="hero-title">منصة مدرسة نبراس التعليمية</h1>
           <p class="hero-subtitle">المنصة الأقوى لطلاب المنهاج الأردني. شروحات تفاعلية، امتحانات محوسبة، ومتابعة مستمرة.</p>
           <div class="action-buttons">
              <button class="btn btn-p btn-hero" onclick="showAuth('register')">ابدأ رحلتك الآن</button>
              <button class="btn btn-o btn-hero" onclick="showPublicLibrary()">تصفح المكتبة مجاناً</button>
           </div>
        </div>
        
        <div id="features">
           <div class="section-header"><h2>لماذا نبراس؟</h2></div>
           <div class="grid feature-grid">
              <div class="feature-box">
                 <div class="feature-icon"><i class="fas fa-brain"></i></div>
                 <h3>تعلم ذكي</h3>
                 <p>نظام ذكي يحلل نقاط ضعفك ويقترح عليك خطط دراسية.</p>
              </div>
              <div class="feature-box">
                 <div class="feature-icon"><i class="fas fa-file-signature"></i></div>
                 <h3>امتحانات وزارية</h3>
                 <p>بنك أسئلة ضخم يحاكي امتحانات الوزارة مع تصحيح فوري.</p>
              </div>
              <div class="feature-box">
                 <div class="feature-icon"><i class="fas fa-award"></i></div>
                 <h3>تحفيز مستمر</h3>
                 <p>احصل على شهادات تقدير وجوائز قيمة عند التفوق.</p>
              </div>
           </div>
        </div>

        <div id="store">
           <div class="section-header"><h2>الباقات الدراسية</h2></div>
           <div class="grid pricing-grid">
              <div class="price-card">
                 <h3>الباقة الفضية</h3>
                 <div class="plan-price">10 JD</div>
                 <ul class="plan-features">
                    <li><i class="fas fa-check"></i> وصول للملخصات</li>
                    <li><i class="fas fa-check"></i> 5 امتحانات تجريبية</li>
                 </ul>
                 <button class="btn btn-o" onclick="buyPlan('Silver')">اشترك</button>
              </div>
              <div class="price-card popular">
                 <h3>الباقة الذهبية</h3>
                 <div class="plan-price">25 JD</div>
                 <ul class="plan-features">
                    <li><i class="fas fa-check"></i> وصول كامل للمحتوى</li>
                    <li><i class="fas fa-check"></i> امتحانات غير محدودة</li>
                    <li><i class="fas fa-check"></i> شهادات معتمدة</li>
                 </ul>
                 <button class="btn btn-p" onclick="buyPlan('Gold')">اشترك الآن</button>
              </div>
              <div class="price-card">
                 <h3>باقة الفصلين</h3>
                 <div class="plan-price">40 JD</div>
                 <ul class="plan-features">
                    <li><i class="fas fa-check"></i> توفير 20%</li>
                    <li><i class="fas fa-check"></i> متابعة خاصة</li>
                 </ul>
                 <button class="btn btn-o" onclick="buyPlan('Full')">اشترك</button>
              </div>
           </div>
        </div>
        
        <div id="faq" style="margin-bottom: 50px;">
           <div class="section-header"><h2>الأسئلة الشائعة</h2></div>
           <div class="faq-container">
              <div class="faq-item card" onclick="this.classList.toggle('active')">
                 <div class="faq-question">كيف يمكنني الحصول على كود التفعيل؟ <i class="fas fa-chevron-down"></i></div>
                 <div class="faq-answer">يمكنك شراء بطاقات التفعيل من المكتبات المعتمدة أو التواصل معنا عبر الواتساب للدفع الإلكتروني.</div>
              </div>
              <div class="faq-item card" onclick="this.classList.toggle('active')">
                 <div class="faq-question">هل يمكنني تجربة المنصة مجاناً؟ <i class="fas fa-chevron-down"></i></div>
                 <div class="faq-answer">نعم، نوفر حساباً تجريبياً لمدة 24 ساعة يتيح لك الوصول لعينات من الامتحانات والشروحات.</div>
              </div>
           </div>
        </div>

        <footer style="text-align: center; padding: 40px; border-top: 1px solid var(--border); color: var(--text-muted);">
            <p>&copy; 2024 منصة مدرسة نبراس التعليمية. جميع الحقوق محفوظة.</p>
            <div style="margin-top: 10px; font-size: 1.5em;">
                <i class="fab fa-facebook margin-10"></i>
                <i class="fab fa-instagram margin-10"></i>
                <i class="fab fa-youtube margin-10"></i>
            </div>
        </footer>
    </div>

    <!-- Public Library UI -->
    <div id="public-library-ui" class="hidden">
       <div class="section-header">
          <div style="display:flex; justify-content:space-between; align-items:center">
              <h2>المكتبة العامة</h2>
              <button class="btn btn-o" onclick="goHome()">عودة للرئيسية</button>
          </div>
          <p style="color:var(--text-muted)">تصفح أحدث الملفات والكتب الدراسية</p>
       </div>
       <div class="search-box">
          <select id="lib-filter-cls" style="flex:1"><option value="All">كل الصفوف</option></select>
          <select id="lib-filter-subj" style="flex:1"><option value="All">كل المواد</option></select>
          <button class="btn btn-p" style="width:auto" onclick="loadPublicLibrary()">بحث <i class="fas fa-search"></i></button>
       </div>
       <div id="public-lib-grid" class="grid">
          <!-- Library Items Injected Here -->
       </div>
    </div>
  </div>
</div>

<!-- ==================== 2. FLIPBOOK VIEWER ==================== -->
<div id="book-view" class="hidden">
    <div class="book-header">
        <h3 id="book-title-display" style="color:white; margin:0">عنوان الكتاب</h3>
        <button class="btn btn-r" style="width:auto" onclick="closeBook()">❌ إغلاق</button>
    </div>
    <div class="book-stage">
        <div id="my-book" class="flip-book"></div>
    </div>
    <div style="color:#aaa; margin-top:20px; text-align:center">
        <i class="fas fa-hand-pointer"></i> استخدم الماوس أو اللمس لتقليب الصفحات من الزوايا
    </div>
</div>

<!-- ==================== 3. AUTHENTICATION ==================== -->
<div id="auth-container" class="container hidden" style="display:flex; justify-content:center; align-items:center; min-height:80vh">
  <div class="auth-card" style="width:100%; max-width:450px">
    <div style="text-align:center; margin-bottom:30px">
       <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" style="width:80px; margin-bottom:10px">
       <h2 id="auth-title">تسجيل الدخول</h2>
    </div>
    
    <div id="f-login">
       <input id="le" type="email" placeholder="البريد الإلكتروني" dir="ltr">
       <input id="lp" type="password" placeholder="كلمة المرور" dir="ltr">
       <button class="btn btn-p" onclick="login()">دخول</button>
       <div style="text-align:center; margin-top:15px">
           <a href="#" onclick="showAuth('register')" style="color:var(--gold)">تفعيل اشتراك جديد</a>
           <span style="margin:0 10px; color:var(--text-muted)">|</span>
           <a href="#" onclick="showAuth('trial')" style="color:var(--green)">تجربة مجانية</a>
       </div>
    </div>
    
    <div id="f-reg" class="hidden">
       <input id="rc" placeholder="كود التفعيل (من البطاقة)">
       <input id="rn" placeholder="الاسم الرباعي الكامل">
       <input id="rph" placeholder="رقم الهاتف (07xxxxxxxx)">
       <input id="re" type="email" placeholder="البريد الإلكتروني">
       <input id="rpa" type="password" placeholder="كلمة المرور">
       <button class="btn btn-g" onclick="reg()">تفعيل الاشتراك</button>
       <button class="btn btn-o" onclick="showAuth('login')">عودة</button>
    </div>
    
    <div id="f-trial" class="hidden">
       <p style="text-align:center; color:var(--green); margin-bottom:20px">تجربة كاملة لمدة 24 ساعة!</p>
       <input id="tn" placeholder="الاسم الرباعي">
       <input id="tph" placeholder="رقم الهاتف">
       <select id="tcl"><option disabled selected>اختر الصف...</option></select>
       <input id="te" placeholder="البريد الإلكتروني">
       <button class="btn btn-p" onclick="createTrial()">ابدأ التجربة</button>
       <button class="btn btn-o" onclick="showAuth('login')">إلغاء</button>
    </div>
  </div>
</div>

<!-- ==================== 4. STUDENT DASHBOARD ==================== -->
<div id="v-dash" class="container hidden">
  <div class="card dash-header">
    <div class="user-info">
        <img id="u-img" src="" class="user-avatar">
        <div class="user-details">
            <h2 id="u-name">اسم الطالب</h2>
            <span id="u-cls">الصف الدراسي</span>
        </div>
    </div>
    <div style="display:flex; gap:10px">
        <button class="btn btn-o" onclick="editProfile()"><i class="fas fa-cog"></i> إعدادات</button>
        <button class="btn btn-r" onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</button>
    </div>
  </div>
  
  <div class="nav-tabs">
      <div class="nav-tab active" onclick="switchTab('exams', this)"><i class="fas fa-file-alt"></i> الامتحانات</div>
      <div class="nav-tab" onclick="switchTab('library', this)"><i class="fas fa-book"></i> مكتبتي</div>
      <div class="nav-tab" onclick="switchTab('assign', this)"><i class="fas fa-upload"></i> الواجبات</div>
      <div class="nav-tab" onclick="switchTab('leader', this)"><i class="fas fa-crown"></i> الأوائل</div>
      <div class="nav-tab" onclick="switchTab('history', this)"><i class="fas fa-history"></i> سجلي</div>
      <div class="nav-tab" onclick="switchTab('notes', this)"><i class="fas fa-sticky-note"></i> مفكرتي</div>
  </div>
  
  <!-- Tab Contents -->
  <div id="tab-exams">
      <div id="exams-container" class="grid"></div>
  </div>
  
  <div id="tab-library" class="hidden">
      <div class="card">
         <h3 style="color:var(--gold)">مكتبة الصف والمواد</h3>
         <div id="std-lib-list" class="grid"></div>
      </div>
  </div>
  
  <div id="tab-assign" class="hidden">
      <div class="card">
        <h3 style="color:var(--green)">تسليم الواجبات</h3>
        <label>نوع الواجب</label>
        <select id="as-type"><option>ورقة عمل</option><option>واجب منزلي</option><option>مشروع</option></select>
        <label>الوصف أو الملاحظات</label>
        <textarea id="as-desc" rows="3"></textarea>
        <label>إرفاق ملف (صورة أو PDF)</label>
        <input type="file" id="as-file" onchange="readAsFile(this)">
        <button class="btn btn-p" onclick="uploadAss()">تسليم الواجب <i class="fas fa-paper-plane"></i></button>
      </div>
  </div>

  <div id="tab-leader" class="hidden">
      <div class="card">
         <h3 style="color:var(--gold)"><i class="fas fa-trophy"></i> لوحة الشرف</h3>
         <table>
             <thead><tr><th>الترتيب</th><th>الطالب</th><th>النقاط</th></tr></thead>
             <tbody id="leader-body"></tbody>
         </table>
      </div>
  </div>
  
  <div id="tab-history" class="hidden">
      <div class="card">
         <div style="display:flex; justify-content:space-between; align-items:center">
             <h3>سجل العلامات</h3>
             <button class="btn btn-g" style="width:auto" onclick="genReport()">تحميل التقرير</button>
         </div>
         <div id="perf-chart" class="chart-box" style="margin:20px 0;"></div>
         <table>
             <thead><tr><th>الامتحان</th><th>النتيجة</th><th>الشهادة</th></tr></thead>
             <tbody id="res-list"></tbody>
         </table>
      </div>
  </div>
  
  <div id="tab-notes" class="hidden">
      <div class="card">
          <h3>مفكرتي الخاصة</h3>
          <textarea id="my-notes" rows="15" placeholder="اكتب ملاحظاتك هنا..."></textarea>
          <button class="btn btn-p" onclick="saveNotes()">حفظ التغييرات</button>
      </div>
  </div>
</div>

<!-- ==================== 5. EXAM INTERFACE ==================== -->
<div id="v-exam" class="container hidden">
  <div class="card" style="position:sticky; top:10px; z-index:100; border-color:var(--blue)">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div>
          <h3 id="xt" style="margin:0; color:var(--blue)"></h3>
          <small id="q-count" style="color:var(--text-muted)"></small>
      </div>
      <button class="btn btn-r" style="width:auto" onclick="exitExam()">خروج</button>
    </div>
    <div class="exam-progress"><div id="exam-progress" class="progress-bar"></div></div>
  </div>
  
  <div class="card question-box">
    <div id="q-box"></div>
    
    <div style="display:flex; justify-content:space-between; margin-top:30px">
      <button class="btn btn-o" style="width:auto" onclick="nav(-1)">السابق</button>
      <div id="qs-ind" style="font-weight:bold; color:var(--gold)"></div>
      <button class="btn btn-p" style="width:auto" onclick="nav(1)">التالي</button>
    </div>
    
    <button id="s-btn" class="btn btn-g hidden" style="margin-top:30px; width:100%" onclick="sub()">إنهاء وتسليم الامتحان</button>
  </div>
</div>

<!-- ==================== MODALS ==================== -->
<div id="cert-modal">
  <div class="cert-container" id="cert-node">
      <div class="cert-header">
          <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" style="width:100px; margin-bottom:10px">
          <h1>شهادة تفوق</h1>
      </div>
      <div class="cert-body">
          <p>تشهد إدارة منصة نبراس التعليمية بأن الطالب/ة:</p>
          <div class="cert-name" id="c-name"></div>
          <p>قد اجتاز امتحان <b id="c-ex" style="color:#1e3a8a"></b> بنجاح باهر.</p>
          <p>النتيجة النهائية: <b id="c-sc" style="color:#d97706; font-size:1.5em"></b></p>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:50px; padding:0 50px">
          <div style="text-align:right">
              <p>التاريخ: <span id="c-date"></span></p>
              <h3>المدير العام</h3>
          </div>
          <img id="stamp-img" src="" class="stamp">
      </div>
  </div>
  <div style="position:absolute; bottom:20px; left:0; right:0; text-align:center; pointer-events:none;">
      <button class="btn btn-g" style="pointer-events:auto; width:auto; margin:0 10px" onclick="dlCert()">حفظ الشهادة</button>
      <button class="btn btn-o" style="pointer-events:auto; width:auto; background:white; color:black" onclick="document.getElementById('cert-modal').style.display='none'">إغلاق</button>
  </div>
</div>

<!-- Review Modal -->
<div id="review-modal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:6000; overflow-y:auto; padding:20px;">
    <div class="container" style="max-width:800px;">
        <div class="card">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--blue)">مراجعة الإجابات</h2>
            <div id="review-content"></div>
            <button class="btn btn-o" onclick="document.getElementById('review-modal').classList.add('hidden')">إغلاق</button>
        </div>
    </div>
</div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const API_URL = "https://script.google.com/macros/s/AKfycbyJ8FX2Hd_OAakWU0Gbo35jcLq5b-tjwGdoGb4RimJtJCfgZqWnM4OSa7kGV-usUwgX/exec"; 
const STAMP_URL = "https://i.ibb.co/Cs658hNV/Gemini-Generated-Image-7gpx1j7gpx1j7gpx.png";
const DEF_IMG = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';

let token = localStorage.getItem('tk');
let deviceId = localStorage.getItem('did');
if (!deviceId) {
    deviceId = 'dev_' + Math.random().toString(36).substr(2, 9) + Date.now();
    localStorage.setItem('did', deviceId);
}

// Global State
let st = { exam:[], ans:{}, idx:0, title:'', cheats:0, assignFile:null, assignName:'' };
let allSubjects = [];
let bookInstance = null;
let publicSettings = {};

const ld = (s) => document.getElementById('loader').style.display = s ? 'flex' : 'none';

// ============================================
// INITIALIZATION
// ============================================
window.onload = function() {
    document.getElementById('stamp-img').src = STAMP_URL;
    
    // URL Params
    const urlParams = new URLSearchParams(window.location.search);
    const viewMode = urlParams.get('view');
    const fileId = urlParams.get('id');

    fetchPublicData(); // Get classes, settings

    if (viewMode === 'library') {
        showPublicLibrary();
    } else if (viewMode === 'file' && fileId) {
        openBook(fileId);
    } else {
        if (token) loadDash(); else goHome();
    }
    
    // Anti-Cheat Monitor
    document.addEventListener("visibilitychange", () => {
        if(document.hidden && !document.getElementById('v-exam').classList.contains('hidden')){
            st.cheats++;
        }
    });
};

function safePushState(data, title, url) {
    try { history.pushState(data, title, url); } catch(e) {}
}

async function callApi(action, data = {}) {
    data.action = action;
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(data)
        });
        return await response.json();
    } catch (e) {
        return { success: false, message: 'خطأ في الاتصال بالخادم' };
    }
}

// ============================================
// NAVIGATION
// ============================================
function goHome() {
    safePushState({}, '', window.location.pathname);
    // Hide all main views
    ['landing-page', 'v-dash', 'auth-container', 'v-exam', 'book-view', 'public-library-ui'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
    });
    // Show Landing
    document.getElementById('landing-page').classList.remove('hidden');
    document.getElementById('home-view').classList.remove('hidden');
}

function navTo(id) {
    goHome();
    setTimeout(() => {
        const el = document.getElementById(id);
        if(el) el.scrollIntoView({ behavior: 'smooth' });
    }, 100);
}

// ============================================
// LIBRARY & FLIPBOOK (SMART PREVIEW)
// ============================================
function showPublicLibrary() {
    document.getElementById('home-view').classList.add('hidden');
    document.getElementById('book-view').classList.add('hidden');
    document.getElementById('public-library-ui').classList.remove('hidden');
    loadPublicLibrary();
    safePushState({view:'library'}, '', '?view=library');
}

async function loadPublicLibrary() {
    const div = document.getElementById('public-lib-grid');
    if(!div) return;
    div.innerHTML = '<div style="grid-column:1/-1;text-align:center">جاري التحميل...</div>';
    
    let cls = document.getElementById('lib-filter-cls').value;
    let subj = document.getElementById('lib-filter-subj').value;
    
    const r = await callApi('getPublicLibraryData', {filterClass: cls, filterSubject: subj});
    div.innerHTML = '';
    
    if(r.success && r.list && r.list.length > 0) {
        r.list.forEach(f => {
            let icon = f.type === 'Video' ? 'fa-play-circle' : 'fa-book-open';
            div.innerHTML += `
            <div class="file-card" onclick="openBook('${f.id}')">
                <i class="fas ${icon} file-icon"></i>
                <h3>${f.title}</h3>
                <div class="file-meta">
                    <span>${f.cls}</span>
                    <span>${f.subject}</span>
                </div>
                <button class="btn btn-p" style="margin-top:10px; font-size:0.9em">تصفح</button>
            </div>`;
        });
    } else {
        div.innerHTML = '<div style="grid-column:1/-1;text-align:center">لا توجد نتائج</div>';
    }
}

async function openBook(id) {
    ld(1);
    const r = await callApi('getPublicFileDetails', {fileId: id});
    ld(0);
    
    if(!r.success || !r.data.link) return Swal.fire('خطأ', 'الملف غير متاح حالياً', 'error');

    safePushState({view:'file', id:id}, '', '?view=file&id='+id);
    
    // Switch View
    ['landing-page', 'public-library-ui'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById('book-view').classList.remove('hidden');
    
    const titleEl = document.getElementById('book-title-display');
    if(titleEl) titleEl.innerText = r.data.title;
    
    const bookEl = document.getElementById('my-book');
    if(!bookEl) return;
    
    // Reset Book
    bookEl.innerHTML = ''; 
    bookEl.style.display = 'none'; 
    bookEl.className = 'flip-book'; 

    let pdfUrl = r.data.link;
    let isDrive = false;
    let driveId = "";

    // Handle Google Drive Links
    if(pdfUrl.includes('drive.google.com') || pdfUrl.includes('docs.google.com')) {
        const m = pdfUrl.match(/[-\w]{25,}/);
        if(m) { 
            isDrive = true; 
            driveId = m[0]; 
            pdfUrl = "https://drive.google.com/uc?export=download&id=" + driveId; 
        }
    }

    try {
        if(typeof pdfUrl !== 'string') throw new Error("Invalid URL");

        // Try PDF.js render (Only for direct links)
        const loadingTask = pdfjsLib.getDocument({ url: pdfUrl });
        const pdf = await loadingTask.promise;
        
        const totalPages = pdf.numPages;
        const percent = r.data.previewPercent || 30;
        let allowed = Math.ceil(totalPages * (percent/100));
        if(allowed < 2) allowed = 2;

        // Cover Page
        addPage(bookEl, `
            <div class="page-cover">
                <h1 style="font-family:'Amiri'; font-size:3em; margin-bottom:10px">${r.data.title}</h1>
                <h3 style="color:#fbbf24">${r.data.subject}</h3>
                <p style="margin-top:20px; font-size:1.2em">${r.data.cls}</p>
                <i class="fas fa-book-reader fa-4x" style="margin-top:40px; opacity:0.8"></i>
            </div>
        `);

        // Content Pages
        for(let i=1; i<=allowed; i++) {
            const pDiv = document.createElement('div');
            pDiv.className = 'page';
            pDiv.innerHTML = `<div class="page-content"><canvas id="cv-${i}" class="pdf-canvas"></canvas></div><div class="page-footer">- ${i} -</div>`;
            bookEl.appendChild(pDiv);
            
            pdf.getPage(i).then(p => {
                const cv = document.getElementById(`cv-${i}`);
                if(cv) {
                    const vp = p.getViewport({scale: 1}); 
                    const ctx = cv.getContext('2d');
                    cv.width = vp.width; cv.height = vp.height; 
                    cv.style.width = '100%'; cv.style.height = '100%';
                    p.render({canvasContext: ctx, viewport: vp});
                }
            });
        }

        // Lock Page
        addPage(bookEl, `
            <div class="page-lock">
                <i class="fas fa-lock fa-4x" style="margin-bottom:20px; color:#ef4444"></i>
                <h2 style="font-family:'Amiri'">نهاية المعاينة المجانية</h2>
                <p style="margin:20px 0; color:#666">لقد تصفحت ${allowed} صفحات من أصل ${totalPages}.</p>
                <button class="btn btn-p" onclick="showAuth('register')">اشترك الآن لإكمال القراءة</button>
            </div>
        `);

        bookEl.style.display = 'block';
        if(bookInstance) { try { bookInstance.destroy(); } catch(e){} }

        setTimeout(() => {
            // Initialize PageFlip
            const PageFlipClass = (window.St && window.St.PageFlip && window.St.PageFlip.PageFlip) || window.PageFlip;
            if(PageFlipClass) {
                bookInstance = new PageFlipClass(bookEl, {
                    width: 450, height: 650, size: "stretch", minWidth: 300, maxWidth: 1000, minHeight: 400, maxHeight: 1200, showCover: true, maxShadowOpacity: 0.5
                });
                bookInstance.loadFromHTML(document.querySelectorAll('#my-book > div'));
            }
        }, 500);

    } catch(e) {
        console.warn("Falling back to Iframe mode", e);
        // Fallback to Iframe if PDF.js fails (CORS)
        if(bookEl) {
            bookEl.innerHTML = '';
            bookEl.style.display = 'block';
            bookEl.style.background = 'transparent';
            bookEl.style.boxShadow = 'none';
            bookEl.className = ""; 
            bookEl.style.width = "100%"; bookEl.style.height = "100%";
            
            let embedUrl = isDrive ? `https://drive.google.com/file/d/${driveId}/preview` : pdfUrl;
            
            bookEl.innerHTML = `
                <div class="iframe-container">
                    <iframe src="${embedUrl}" class="doc-iframe" allow="autoplay"></iframe>
                    <div class="iframe-overlay">
                        <div class="lock-message-box">
                            <i class="fas fa-lock"></i>
                            <h3>المعاينة محدودة</h3>
                            <button class="btn btn-p" onclick="showAuth('register')">اشترك لعرض الملف كاملاً</button>
                        </div>
                    </div>
                </div>`;
        }
    }
}

function addPage(c, h) { if(c) { const d=document.createElement('div'); d.innerHTML=h; c.appendChild(d); } }
function closeBook() { 
    document.getElementById('book-view').classList.add('hidden');
    document.getElementById('landing-page').classList.remove('hidden');
    if(document.getElementById('public-lib-grid').innerHTML !== '') {
        document.getElementById('public-library-ui').classList.remove('hidden');
    } else {
        document.getElementById('home-view').classList.remove('hidden');
    }
}

// ============================================
// AUTHENTICATION
// ============================================
function showAuth(type) {
    document.getElementById('landing-page').classList.add('hidden');
    document.getElementById('auth-container').classList.remove('hidden');
    
    ['f-login', 'f-reg', 'f-trial'].forEach(id => document.getElementById(id).classList.add('hidden'));
    
    if(type === 'login') {
        document.getElementById('auth-title').innerText = 'تسجيل الدخول';
        document.getElementById('f-login').classList.remove('hidden');
    } else if(type === 'register') {
        document.getElementById('auth-title').innerText = 'تفعيل اشتراك جديد';
        document.getElementById('f-reg').classList.remove('hidden');
    } else {
        document.getElementById('auth-title').innerText = 'تجربة مجانية';
        document.getElementById('f-trial').classList.remove('hidden');
    }
}

async function login() {
    const e = document.getElementById('le').value;
    const p = document.getElementById('lp').value;
    if(!e || !p) return Swal.fire('تنبيه', 'يرجى ملء الحقول', 'warning');
    
    ld(1);
    const r = await callApi('loginUser', {email:e, pass:p, deviceId:deviceId});
    ld(0);
    
    if(r.success) {
        localStorage.setItem('tk', r.token);
        localStorage.setItem('nm', r.name);
        localStorage.setItem('cl', r.classLevel);
        if(r.photo) localStorage.setItem('ph', r.photo);
        token = r.token;
        loadDash();
    } else {
        Swal.fire('خطأ', r.message, 'error');
    }
}

async function reg() {
    const d = {
        code: document.getElementById('rc').value,
        name: document.getElementById('rn').value,
        phone: document.getElementById('rph').value,
        email: document.getElementById('re').value,
        password: document.getElementById('rpa').value,
        deviceId: deviceId
    };
    ld(1);
    const r = await callApi('registerStudent', {d:d});
    ld(0);
    if(r.success) {
        localStorage.setItem('tk', r.token);
        token = r.token;
        Swal.fire('تم التفعيل', 'أهلاً بك في منصة نبراس', 'success').then(loadDash);
    } else {
        Swal.fire('خطأ', r.message, 'error');
    }
}

async function createTrial() {
    const d = {
        name: document.getElementById('tn').value,
        phone: document.getElementById('tph').value,
        classLevel: document.getElementById('tcl').value,
        email: document.getElementById('te').value,
        deviceId: deviceId
    };
    ld(1);
    const r = await callApi('createTrialAccount', {d:d});
    ld(0);
    if(r.success) {
        localStorage.setItem('tk', r.token);
        token = r.token;
        Swal.fire('تم', `كلمة المرور المؤقتة: ${r.tempPass}`, 'success').then(loadDash);
    } else {
        Swal.fire('خطأ', r.message, 'error');
    }
}

function logout() {
    localStorage.clear();
    location.reload();
}

// ============================================
// STUDENT DASHBOARD LOGIC
// ============================================
function loadDash() {
    ['landing-page', 'auth-container', 'v-exam'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById('v-dash').classList.remove('hidden');
    
    document.getElementById('u-name').innerText = localStorage.getItem('nm');
    document.getElementById('u-cls').innerText = localStorage.getItem('cl');
    const ph = localStorage.getItem('ph');
    if(ph) document.getElementById('u-img').src = ph;
    
    // Load Exams
    callApi('getExamsList', {token:token}).then(r => {
        allSubjects = r.subjects || [];
        renderSubjects();
    });
    
    // Load Other Data (Lazy)
    callApi('getStudentStats', {token:token}).then(r => {
        if(r.success) {
            publicSettings = r.socials || {};
            // Render Chart
            const chartHtml = `
                <div class="chart-bar chart-me" style="height:${r.myAvg}%">${r.myAvg}%</div>
                <div class="chart-bar chart-cls" style="height:${r.classAvg}%">${r.classAvg}%</div>
                <div style="width:100%; display:flex; justify-content:space-between; position:absolute; bottom:-25px; font-size:12px"><span>أنا</span><span>الصف</span></div>
            `;
            const chartBox = document.getElementById('perf-chart');
            if(chartBox) chartBox.innerHTML = chartHtml;
            
            if(publicSettings.whatsapp) {
                document.getElementById('wa-btn').href = publicSettings.whatsapp;
                document.getElementById('wa-btn').classList.remove('hidden');
            }
        }
    });
}

function renderSubjects() {
    const cont = document.getElementById('exams-container');
    if(!cont) return;
    let h = '';
    allSubjects.forEach((sub, idx) => {
        h += `
        <div class="exam-item folder-item" onclick="openSubject(${idx})">
            <div>
                <i class="fas fa-folder exam-icon"></i>
                <h3 style="margin:0">${sub.name}</h3>
            </div>
            <span style="background:rgba(0,0,0,0.1); padding:2px 8px; border-radius:10px">${sub.exams.length}</span>
        </div>`;
    });
    cont.innerHTML = h || '<p>لا توجد امتحانات</p>';
}

function openSubject(idx) {
    let sub = allSubjects[idx];
    let h = `<div style="grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
               <h3 style="color:var(--gold); margin:0">${sub.name}</h3>
               <button class="btn btn-o" style="width:auto" onclick="renderSubjects()">عودة</button>
             </div>`;
    
    sub.exams.forEach(x => {
        h += `<div class="exam-item" onclick="start('${x.title}')">
                <i class="fas fa-file-alt exam-icon"></i>
                <b>${x.title}</b>
              </div>`;
    });
    document.getElementById('exams-container').innerHTML = h;
}

function switchTab(t, el) {
    ['exams', 'library', 'assign', 'leader', 'history', 'notes'].forEach(id => {
        document.getElementById('tab-'+id).classList.add('hidden');
    });
    document.getElementById('tab-'+t).classList.remove('hidden');
    
    document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
    el.classList.add('active');
    
    if(t==='library') loadStudentLib();
    if(t==='leader') loadLeader();
    if(t==='history') loadHistory();
    if(t==='notes') loadNotes();
}

// Student Library
function loadStudentLib() {
    const cont = document.getElementById('std-lib-list');
    cont.innerHTML = 'جاري التحميل...';
    callApi('getLibraryContent', {token:token}).then(r => {
        let h = '';
        if(r.library) r.library.forEach(f => {
            h += `<div class="exam-item" onclick="window.open('${f.link}','_blank')">
                    <i class="fas ${f.type==='Video'?'fa-play-circle':'fa-file-pdf'} exam-icon"></i>
                    <div><b>${f.title}</b><br><small>${f.subject}</small></div>
                  </div>`;
        });
        cont.innerHTML = h || 'المكتبة فارغة';
    });
}

// Student History
function loadHistory() {
    const tb = document.getElementById('res-list');
    tb.innerHTML = '';
    callApi('getStudentResults', {token:token}).then(r => {
        if(r.results) r.results.forEach(x => {
            tb.innerHTML += `<tr><td>${x.exam}</td><td style="color:${x.percent>=50?'var(--green)':'var(--red)'}">${x.percent}%</td><td>${x.percent>=50?`<button class="btn btn-sm btn-g" onclick="cert('${x.exam}','${x.percent}')">📜</button>`:'-'}</td></tr>`;
        });
    });
}

// Leaderboard
function loadLeader() {
    const tb = document.getElementById('leader-body');
    tb.innerHTML = '';
    callApi('getLeaderboard', {token:token}).then(r => {
        if(r.list) r.list.forEach((l, i) => {
            let icon = i===0 ? '🥇' : (i===1 ? '🥈' : (i===2 ? '🥉' : `#${i+1}`));
            tb.innerHTML += `<tr><td>${icon}</td><td>${l.name}</td><td>${l.score}</td></tr>`;
        });
    });
}

// Notes
function loadNotes() {
    callApi('getStudentNote', {token:token}).then(r => {
        if(r.success) document.getElementById('my-notes').value = r.note;
    });
}
function saveNotes() {
    callApi('saveStudentNote', {token:token, text:document.getElementById('my-notes').value});
    Swal.fire('تم', 'تم حفظ الملاحظات', 'success');
}

// Assignments
function readAsFile(input) {
    if(input.files && input.files[0]) {
        let f = input.files[0];
        let r = new FileReader();
        r.onload = e => { st.assignFile = e.target.result; st.assignName = f.name; };
        r.readAsDataURL(f);
    }
}
function uploadAss() {
    if(!st.assignFile) return Swal.fire('تنبيه', 'يرجى اختيار ملف', 'warning');
    ld(1);
    let d = {
        type: document.getElementById('as-type').value,
        desc: document.getElementById('as-desc').value,
        fileData: st.assignFile,
        fileName: st.assignName
    };
    callApi('uploadStudentAssignment', {token:token, d:d}).then(r => {
        ld(0);
        if(r.success) Swal.fire('تم', 'تم تسليم الواجب', 'success');
        else Swal.fire('خطأ', r.message, 'error');
    });
}

// ============================================
// EXAM SYSTEM
// ============================================
function start(t) {
    ld(1);
    callApi('getExamQuestions', {token:token, name:t}).then(r => {
        ld(0);
        if(!r.success) return Swal.fire('تنبيه', r.message, 'warning');
        
        st.exam = r.questions; st.title = t; st.idx = 0; st.ans = {}; st.cheats=0;
        
        document.getElementById('v-dash').classList.add('hidden');
        document.getElementById('v-exam').classList.remove('hidden');
        document.getElementById('xt').innerText = t;
        document.getElementById('q-count').innerText = st.exam.length + ' سؤال';
        rendQ();
    });
}

function rendQ() {
    const q = st.exam[st.idx];
    const qBox = document.getElementById('q-box');
    
    let h = `<div class="q-text">${st.idx+1}. ${q.text}</div>`;
    if(q.img) h += `<img src="${q.img}" style="max-width:100%; border-radius:15px; margin-bottom:20px; box-shadow:0 5px 15px rgba(0,0,0,0.2)">`;
    
    q.opts.forEach(opt => {
        let sel = st.ans[q.id] === opt ? 'selected' : '';
        h += `<div class="q-option ${sel}" onclick="sl('${opt}')">
                <div class="q-circle"></div>
                <span>${opt}</span>
              </div>`;
    });
    
    qBox.innerHTML = h;
    document.getElementById('qs-ind').innerText = `${st.idx+1} / ${st.exam.length}`;
    
    // Progress
    document.getElementById('exam-progress').style.width = ((st.idx+1)/st.exam.length)*100 + '%';
    
    // Buttons
    document.getElementById('s-btn').classList.toggle('hidden', st.idx !== st.exam.length-1);
}

function sl(v) { 
    st.ans[st.exam[st.idx].id] = v; 
    rendQ(); 
}

function nav(d) {
    if(st.idx+d >= 0 && st.idx+d < st.exam.length) {
        st.idx += d;
        rendQ();
    }
}

function sub() {
    Swal.fire({
        title: 'تسليم الامتحان؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم، تسليم',
        cancelButtonText: 'مراجعة'
    }).then(r => {
        if(r.isConfirmed) {
            ld(1);
            callApi('submitExam', {token:token, n:st.title, a:st.ans, cheats:st.cheats}).then(res => {
                ld(0);
                exitExam();
                if(res.percent >= 50) {
                    Swal.fire('مبروك!', `النتيجة: ${res.percent}%`, 'success').then(() => cert(st.title, res.percent));
                } else {
                    Swal.fire('حظاً أوفر', `النتيجة: ${res.percent}%`, 'error').then(() => showReview(st.title));
                }
            });
        }
    });
}

function showReview(title) {
    ld(1);
    callApi('getReviewData', {token:token, title:title}).then(r => {
        ld(0);
        document.getElementById('review-modal').classList.remove('hidden');
        let h = '';
        st.exam.forEach((q, i) => {
            let correct = r.answers[q.id];
            let my = st.ans[q.id];
            let isCorrect = my === correct;
            h += `<div style="background:white; padding:15px; border-radius:10px; margin-bottom:10px; color:black; border-right:5px solid ${isCorrect?'green':'red'}">
                    <b>س${i+1}: ${q.text}</b><br>
                    <span style="color:${isCorrect?'green':'red'}">إجابتك: ${my||'لم تجب'}</span><br>
                    <span style="color:green">الصحيحة: ${correct}</span>
                  </div>`;
        });
        document.getElementById('review-content').innerHTML = h;
    });
}

function exitExam() {
    document.getElementById('v-exam').classList.add('hidden');
    document.getElementById('v-dash').classList.remove('hidden');
    loadDash();
}

// ============================================
// HELPERS
// ============================================
function fetchPublicData() {
    callApi('getPublicData').then(r => {
        if(r.success && r.classes) {
            let ops = '<option value="All">كل الصفوف</option>';
            r.classes.forEach(c => ops += `<option value="${c}">${c}</option>`);
            const filterEl = document.getElementById('lib-filter-cls');
            if(filterEl) filterEl.innerHTML = ops;
            
             let tops = '<option disabled selected>الصف...</option>';
             r.classes.forEach(c => tops += `<option value="${c}">${c}</option>`);
             const tclEl = document.getElementById('tcl');
             if(tclEl) tclEl.innerHTML = tops;
        }
    });
}

function cert(e, s) {
    document.getElementById('c-name').innerText = localStorage.getItem('nm');
    document.getElementById('c-ex').innerText = e;
    document.getElementById('c-sc').innerText = s + '%';
    document.getElementById('c-date').innerText = new Date().toLocaleDateString();
    document.getElementById('cert-modal').style.display = 'flex';
}
function dlCert() {
    html2canvas(document.getElementById('cert-node')).then(c => {
        let a = document.createElement('a'); a.download = 'Certificate.png'; a.href = c.toDataURL(); a.click();
    });
}

function toggleTheme() {
    let b = document.body;
    let icon = document.querySelector('.fa-moon') || document.querySelector('.fa-sun');
    if(b.getAttribute('data-theme') == 'light') { 
        b.setAttribute('data-theme', 'dark'); 
        if(icon) icon.className = 'fas fa-moon'; 
    } else { 
        b.setAttribute('data-theme', 'light'); 
        if(icon) icon.className = 'fas fa-sun'; 
    }
}

function editProfile() {
    Swal.fire({
        title: 'تغيير كلمة المرور',
        input: 'password',
        showCancelButton: true,
        confirmButtonText: 'حفظ'
    }).then(r => {
        if(r.value) {
            callApi('updateProfile', {token:token, newPass:r.value}).then(res => Swal.fire(res.message));
        }
    });
}

function joinClassGroup() {
    let cls = localStorage.getItem('cl');
    let link = publicSettings[`Group_${cls}`] || publicSettings['WhatsApp_Link'];
    if(link) window.open(link.includes('http') ? link : 'https://wa.me/' + link.replace(/\D/g,''));
    else Swal.fire('تنبيه', 'لا يوجد رابط مجموعة لهذا الصف حالياً', 'info');
}

function genReport() {
    html2canvas(document.getElementById('tab-history')).then(c => {
       let a = document.createElement('a'); a.download = 'Report.png'; a.href = c.toDataURL(); a.click();
    });
}

function buyPlan(plan) {
    let num = publicSettings.WhatsApp_Link ? publicSettings.WhatsApp_Link.replace(/\D/g,'') : '96270000000';
    window.open(`https://wa.me/${num}?text=مرحباً، أريد الاشتراك في ${plan}`);
}
</script>
</body>
</html>
