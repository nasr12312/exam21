<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base target="_top">
    
    <!-- =================================================================================
         منصة نبراس التعليمية | الإصدار الشامل (V18.2 - Full Integration)
         تم دمج كافة الواجهات القديمة مع ميزات:
         1. الهرمية (Hierarchy)
         2. الدخول كزائر (Honey Pot)
         3. جدار الدفع (Paywall)
         4. التحليلات (Analytics)
         ================================================================================= -->
    <title>منصة نبراس التعليمية | المنهاج الأردني</title>
    
    <!-- وصف دقيق وشامل -->
    <meta name="description" content="منصة نبراس التعليمية: أقوى موقع تعليمي للمنهاج الأردني. شروحات مصورة، امتحانات إلكترونية محوسبة، دوسيات، وأوراق عمل من الصف الأول حتى التوجيهي. تجربة تعليمية تفاعلية مع نخبة من المعلمين. سجل الآن وابدأ رحلة التفوق.">
    
    <!-- كلمات مفتاحية (SEO Injection) -->
    <meta name="keywords" content="
    منصة نبراس, مدرسة نبراس, تعليم الكتروني, المنهاج الأردني, توجيهي 2007, توجيهي 2008, امتحانات محوسبة, اختبارات الكترونية, أوراق عمل, دوسيات pdf,
    شرح لغة عربية, شرح رياضيات, شرح فيزياء, شرح كيمياء, شرح احياء, شرح علوم ارض, شرح انجليزي, شرح تاريخ اردن, شرح تربية اسلامية,
    الصف الاول, الصف الثاني, الصف الثالث, الصف الرابع, الصف الخامس, الصف السادس, الصف السابع, الصف الثامن, الصف التاسع, الصف العاشر, الاول ثانوي,
    تأسيس توجيهي, مكثفات توجيهي, اسئلة سنوات سابقة, اسئلة وزارية, متوقع, مقترح, وتد, جو اكاديمي, ابواب, منهاجي, درسك, اوبن ايمس
    ">
    
    <meta name="author" content="منصة نبراس التعليمية">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph -->
    <meta property="og:title" content="منصة نبراس التعليمية | طريقك نحو التفوق">
    <meta property="og:description" content="انضم لأضخم منصة تعليمية للمنهاج الأردني. امتحانات، شروحات، وملفات حصرية.">
    <meta property="og:image" content="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png">
    
    <!-- الخطوط والأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Amiri:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    
    <!-- المكتبات الخارجية -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

<style>
  :root { 
    --bg: #0f172a; 
    --glass: rgba(30, 41, 59, 0.95); 
    --border: rgba(255, 255, 255, 0.1);
    --blue: #3b82f6; 
    --gold: #f59e0b; 
    --red: #ef4444; 
    --green: #10b981; 
    --text: #f8fafc;
    --shadow-card: 0 10px 30px rgba(0,0,0,0.3);
  }
  [data-theme="light"] {
    --bg: #f8fafc; --glass: rgba(255, 255, 255, 0.95); --border: rgba(0, 0, 0, 0.1); --text: #0f172a; --blue: #2563eb; --shadow-card: 0 10px 30px rgba(0,0,0,0.1);
  }
  
  /* الأساسيات */
  body { 
    background: var(--bg); color: var(--text); font-family: 'Tajawal'; margin: 0; padding: 0; min-height: 100vh;
    transition: background 0.5s, color 0.5s;
    background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,0.5) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,0.5) 0, transparent 50%);
    scroll-behavior: smooth;
    -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Anti-Theft */
    -webkit-touch-callout: none;
  }
  
  .container { max-width: 1100px; margin: 0 auto; padding: 20px; transition: 0.5s; }
  .hidden { display: none !important; }
  
  /* تأثيرات الدخول */
  .fade-in { animation: fadeIn 0.8s ease-in-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  /* === Landing Page Navigation === */
  .landing-nav {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 0; margin-bottom: 40px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 1000; background: var(--bg);
      backdrop-filter: blur(10px);
  }
  .nav-logo { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.2em; color: var(--text); cursor:pointer; }
  .nav-links { display: flex; gap: 20px; }
  .nav-links a { color: var(--text); text-decoration: none; font-weight: 500; transition: 0.3s; cursor: pointer; }
  .nav-links a:hover { color: var(--blue); }
  .nav-buttons { display: flex; gap: 12px; align-items: center; }
  .nav-btn-sep { padding: 8px 20px; border-radius: 50px; font-weight: bold; font-size: 0.9em; cursor: pointer; transition: 0.3s; border: 1px solid transparent; display: flex; align-items: center; gap: 5px; }
  .btn-login-nav { background: var(--blue); color: white; }
  .btn-reg-nav { background: transparent; border-color: var(--gold); color: var(--gold); }
  .btn-reg-nav:hover { background: var(--gold); color: black; }
  @media (max-width: 768px) { .nav-links { display: none !important; } }

  /* === Hero Section === */
  .hero-section { text-align: center; padding: 60px 0 100px; }
  .hero-logo { width: 160px; height: 160px; border-radius: 50%; border: 4px solid var(--gold); box-shadow: 0 0 40px rgba(245, 158, 11, 0.4); margin-bottom: 25px; animation: float 6s ease-in-out infinite; }
  @keyframes float { 0%{transform:translateY(0px)} 50%{transform:translateY(-20px)} 100%{transform:translateY(0px)} }
  .hero-title { font-family: 'Amiri'; font-size: 3.5em; margin: 0; color: var(--blue); text-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
  .hero-subtitle { color: #94a3b8; font-size: 1.3em; margin-bottom: 40px; max-width: 700px; margin-left: auto; margin-right: auto; line-height: 1.6; }
  
  /* === Sections Headers === */
  .section-header { text-align: center; margin-bottom: 50px; position: relative; padding-bottom: 15px; padding-top: 40px; }
  .section-header h2 { font-family: 'Amiri'; font-size: 2.5em; color: var(--gold); margin: 0; }
  .section-header::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 3px; background: var(--blue); border-radius: 2px; }

  /* === Features & Cards === */
  .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; margin-bottom: 80px; }
  .feature-box { background: var(--glass); padding: 30px; border-radius: 20px; border: 1px solid var(--border); transition: 0.3s; text-align: center; }
  .feature-box:hover { transform: translateY(-10px); border-color: var(--blue); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .feature-icon { font-size: 3em; color: var(--gold); margin-bottom: 20px; background: rgba(245, 158, 11, 0.1); width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin: 0 auto 20px; }

  /* === Store & Pricing === */
  .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 80px; justify-content: center; }
  .price-card { background: var(--glass); padding: 40px 30px; border-radius: 20px; border: 1px solid var(--border); text-align: center; transition: 0.3s; position: relative; }
  .price-card:hover { transform: translateY(-5px); border-color: var(--blue); }
  .price-card.popular { border: 2px solid var(--gold); transform: scale(1.05); z-index: 1; box-shadow: 0 0 20px rgba(245, 158, 11, 0.2); }
  .plan-price { font-size: 3em; font-weight: 800; color: var(--blue); margin: 20px 0; font-family: 'Amiri'; }
  .plan-features { list-style: none; padding: 0; margin: 30px 0; text-align: right; }
  .plan-features li { margin-bottom: 12px; color: #cbd5e1; display: flex; align-items: center; gap: 10px; }
  .plan-features li i { color: var(--green); }

  /* === Reviews & FAQ === */
  .reviews-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 80px; }
  .review-card { background: rgba(255,255,255,0.03); padding: 25px; border-radius: 15px; border: 1px solid var(--border); }
  .stars { color: var(--gold); margin-bottom: 15px; }
  
  .faq-container { max-width: 800px; margin: 0 auto 80px; }
  .faq-item { background: var(--glass); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; overflow: hidden; transition: 0.3s; }
  .faq-question { padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
  .faq-answer { padding: 0 20px 20px; display: none; color: #94a3b8; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px; }
  .faq-item.active .faq-answer { display: block; }

  /* === General Components === */
  .card, .auth-card { 
    background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--border); 
    border-radius: 20px; padding: 30px; margin-bottom: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
  }
  .auth-card { max-width: 400px; margin: 50px auto; }
  input, select, textarea { 
    width: 100%; padding: 15px; margin-bottom: 15px; background: rgba(128,128,128,0.1); 
    border: 1px solid var(--border); border-radius: 12px; color: var(--text); box-sizing: border-box; 
  }
  .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 5px; }
  .btn:hover { transform: translateY(-3px); }
  .btn-p { background: linear-gradient(135deg, var(--blue), #2563eb); color: white; } 
  .btn-g { background: linear-gradient(135deg, var(--gold), #d97706); color: white; }
  .btn-o { background: rgba(128,128,128,0.1); border: 1px solid var(--border); color: var(--text); }
  .btn-r { background: linear-gradient(135deg, var(--red), #b91c1c); color: white; }
  
  /* === [NEW] HIERARCHY / FOLDER STYLES === */
  .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
  .folder-item { 
      background: rgba(59, 130, 246, 0.08); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; 
      padding: 25px; cursor: pointer; text-align: center; transition: 0.3s; position: relative; overflow: hidden;
  }
  .folder-item:hover { transform: translateY(-5px); background: rgba(59, 130, 246, 0.2); border-color: var(--blue); }
  .folder-icon { font-size: 45px; color: var(--gold); margin-bottom: 15px; display: block; transition: 0.3s; }
  .folder-item:hover .folder-icon { transform: scale(1.1); }
  .folder-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
  .folder-meta { font-size: 0.8em; color: #94a3b8; }
  
  /* Exam Node (Leaf) */
  .exam-node { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); }
  .exam-node .folder-icon { color: var(--green); font-size: 35px; }

  /* Breadcrumbs */
  .breadcrumb { 
      display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding: 10px 20px; 
      background: rgba(255,255,255,0.05); border-radius: 50px; font-size: 0.9em; color: #cbd5e1; 
  }
  .bread-item { cursor: pointer; transition: 0.2s; }
  .bread-item:hover { color: var(--blue); text-decoration: underline; }
  .bread-active { color: var(--gold); font-weight: bold; cursor: default; }
  
  /* === [NEW] PAYWALL MODAL === */
  #paywall-modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 99999;
      display: none; flex-direction: column; justify-content: center; align-items: center;
      backdrop-filter: blur(15px); padding: 20px;
  }
  .paywall-content {
      background: linear-gradient(145deg, #1e293b, #0f172a);
      border: 2px solid var(--gold); border-radius: 25px; padding: 40px;
      max-width: 500px; width: 100%; text-align: center; position: relative;
      box-shadow: 0 0 60px rgba(245, 158, 11, 0.2); animation: bounceIn 0.6s;
  }
  @keyframes bounceIn { 0%{transform:scale(0.8);opacity:0} 60%{transform:scale(1.05)} 100%{transform:scale(1);opacity:1} }
  .pw-icon { font-size: 60px; color: var(--red); margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(239,68,68,0.5)); }
  .pw-title { font-size: 1.8em; color: white; margin-bottom: 10px; font-weight: 800; }
  .pw-desc { color: #cbd5e1; font-size: 1.1em; line-height: 1.6; margin-bottom: 25px; }
  .pw-price-tag { 
      background: rgba(245, 158, 11, 0.15); color: var(--gold); padding: 10px 20px; 
      border-radius: 10px; font-weight: bold; display: inline-block; margin-bottom: 25px; border: 1px dashed var(--gold);
  }

  /* === Exam UI === */
  .q-option { padding: 18px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; cursor: pointer; background: rgba(128,128,128,0.05); display: flex; align-items: center; gap: 10px; }
  .q-option.selected { background: rgba(59,130,246,0.2); border-color: var(--blue); }
  .opt-circle { width:20px; height:20px; border-radius:50%; border:2px solid #555; }
  .q-option.selected .opt-circle { background: var(--blue); border-color: var(--blue); }

  /* === Loader & Cert === */
  #loader { position: fixed; inset: 0; background: rgba(15,23,42,0.98); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
  .loader-spinner { width: 60px; height: 60px; border: 5px solid rgba(59, 130, 246, 0.3); border-top: 5px solid var(--blue); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  #cert-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: none; justify-content: center; align-items: center; overflow: auto; }
  .cert-box { background: white; color: black; width: 800px; padding: 40px; border-radius: 15px; text-align: center; border: 10px double #1e3a8a; }
</style>
</head>

<body oncontextmenu="return false;">

<!-- LOADER -->
<div id="loader">
  <div class="loader-spinner"></div>
  <div style="color:white; font-size:1.2em; font-weight:bold; margin-top:15px">جاري المعالجة...</div>
</div>

<!-- [NEW] PAYWALL MODAL -->
<div id="paywall-modal">
    <div class="paywall-content">
        <i class="fas fa-lock pw-icon"></i>
        <div class="pw-title">عفواً، المحتوى مقفل</div>
        <div class="pw-desc">
            لقد وصلت للحد الأقصى للزوار (7 أسئلة).
            <br>لإكمال الامتحان ومعرفة نتيجتك، يرجى الاشتراك في المنصة.
        </div>
        <div class="pw-price-tag">اشتراك كامل: 3.00 JOD</div>
        
        <button class="btn btn-g" onclick="subscribeNow()">
            <i class="fab fa-whatsapp"></i> اشترك الآن عبر واتساب
        </button>
        <button class="btn btn-o" onclick="location.reload()" style="margin-top:10px; border:none; color:#94a3b8">
            عودة للرئيسية
        </button>
    </div>
</div>

<!-- ================= 1. LANDING PAGE ================= -->
<div id="landing-page" class="">
  <div class="container">
    <nav class="landing-nav">
       <div class="nav-logo" onclick="goHome()">
          <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" style="width:40px; height:40px; border-radius:50%; border:2px solid var(--gold)">
          <span>نبراس التعليمية</span>
       </div>
       <div class="nav-links">
          <a onclick="goHome()">الرئيسية</a>
          <a onclick="showPublicLibrary()">المكتبة العامة</a>
          <a onclick="navToSection('features')">المميزات</a>
          <a onclick="navToSection('store')">المتجر</a>
       </div>
       <div class="nav-buttons">
           <button class="nav-btn-sep btn-reg-nav" onclick="showLogin('register')">تفعيل كود</button>
           <button class="nav-btn-sep btn-login-nav" onclick="showLogin('login')">دخول</button>
       </div>
    </nav>
    
    <div id="home-view">
        <div class="hero-section">
           <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" class="hero-logo">
           <h1 class="hero-title">منصة مدرسة نبراس التعليمية</h1>
           <p class="hero-subtitle">انطلق في رحلة تعليمية متكاملة. اختبارات تفاعلية ذكية وتقييم مستمر لمستواك في المنهاج الأردني.</p>
           
           <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap">
              <button class="btn btn-p" style="width:auto; padding:12px 30px" onclick="showLogin('register')"><i class="fas fa-user-plus"></i> اشترك الآن</button>
              
              <!-- [NEW] GUEST BUTTON -->
              <button class="btn btn-o" style="width:auto; padding:12px 30px; border-color:var(--green); color:var(--green)" onclick="guestLogin()">
                  <i class="fas fa-user-secret"></i> جرب كزائر (مجاناً)
              </button>
           </div>
        </div>

        <div id="features">
           <div class="section-header"><h2>مميزات المنصة</h2></div>
           <div class="feature-grid">
              <div class="feature-box"><div class="feature-icon"><i class="fas fa-laptop-code"></i></div><h3>نظام امتحانات ذكي</h3><p style="color:#94a3b8">اختبارات تفاعلية متنوعة مع تصحيح تلقائي.</p></div>
              <div class="feature-box"><div class="feature-icon"><i class="fas fa-chart-pie"></i></div><h3>تحليل أداء</h3><p style="color:#94a3b8">رسوم بيانية توضح نقاط القوة والضعف.</p></div>
              <div class="feature-box"><div class="feature-icon"><i class="fas fa-certificate"></i></div><h3>شهادات تقدير</h3><p style="color:#94a3b8">احصل على شهادات موثقة عند التفوق.</p></div>
           </div>
        </div>

        <div id="store">
           <div class="section-header"><h2>باقات الاشتراك</h2></div>
           <div class="pricing-grid">
              <div class="price-card popular">
                 <h3>الباقة الذهبية</h3>
                 <div class="plan-price">15 JD</div>
                 <ul class="plan-features"><li><i class="fas fa-check-circle"></i> وصول كامل للامتحانات</li><li><i class="fas fa-check-circle"></i> بنك أسئلة شامل</li></ul>
                 <button class="btn btn-p" onclick="subscribeNow()">اشترك الآن</button>
              </div>
           </div>
        </div>

        <div id="faq">
           <div class="section-header"><h2>أسئلة شائعة</h2></div>
           <div class="faq-container">
              <div class="faq-item" onclick="toggleFaq(this)">
                 <div class="faq-question">هل يمكنني التجربة قبل الدفع؟ <i class="fas fa-chevron-down"></i></div>
                 <div class="faq-answer">نعم، استخدم زر "دخول كزائر" لتجربة الامتحانات حتى السؤال السابع مجاناً.</div>
              </div>
              <div class="faq-item" onclick="toggleFaq(this)">
                 <div class="faq-question">كيف أحصل على كود التفعيل؟ <i class="fas fa-chevron-down"></i></div>
                 <div class="faq-answer">يمكنك شراؤه من نقاط البيع أو التواصل معنا عبر واتساب.</div>
              </div>
           </div>
        </div>
    </div>
    
    <!-- Public Library Placeholder -->
    <div id="public-library-ui" class="hidden">
       <button class="btn btn-o" onclick="goHome()" style="width:auto; margin-bottom:20px">عودة</button>
       <div class="section-header"><h2>المكتبة العامة</h2></div>
       <div id="public-lib-grid" class="folder-grid"></div>
    </div>
    
    <footer class="landing-footer">
       <div style="margin-bottom:20px; font-size:1.5em">
           <a href="#" style="color:#94a3b8; margin:0 10px"><i class="fab fa-facebook"></i></a>
           <a href="#" style="color:#94a3b8; margin:0 10px"><i class="fab fa-instagram"></i></a>
       </div>
       <p>&copy; 2024 منصة نبراس التعليمية.</p>
    </footer>
  </div>
</div>

<!-- ================= 2. AUTHENTICATION ================= -->
<div id="auth-container" class="container hidden" style="max-width:400px; margin-top:60px">
  <div class="auth-card">
    <div style="text-align:center; margin-bottom:20px">
       <i class="fas fa-arrow-right" style="float:right; cursor:pointer; color:var(--text)" onclick="goHome()"></i>
       <h2 id="auth-title">تسجيل الدخول</h2>
    </div>
    <div id="f-login">
       <input id="le" placeholder="البريد الإلكتروني" dir="ltr">
       <input id="lp" type="password" placeholder="كلمة المرور" dir="ltr">
       <button class="btn btn-p" onclick="login()">دخول <i class="fas fa-sign-in-alt"></i></button>
       <button class="btn btn-o" onclick="switchAuth('register')" style="margin-top:10px">تفعيل كود جديد</button>
    </div>
    <div id="f-reg" class="hidden">
       <input id="rc" placeholder="كود التفعيل" required>
       <input id="rn" placeholder="الاسم الرباعي" required>
       <input id="rph" placeholder="رقم الهاتف" required>
       <input id="re" type="email" placeholder="البريد الإلكتروني" required>
       <input id="rpa" type="password" placeholder="كلمة المرور" required>
       <button class="btn btn-g" onclick="reg()">تفعيل</button>
       <button class="btn btn-o" onclick="switchAuth('login')">عودة للدخول</button>
    </div>
  </div>
</div>

<!-- ================= 3. STUDENT DASHBOARD ================= -->
<div id="v-dash" class="container hidden">
  <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
    <div style="display:flex; align-items:center; gap:15px">
         <div style="width:60px; height:60px; border-radius:50%; background:var(--blue); display:flex; justify-content:center; align-items:center; font-size:25px; color:white; border:3px solid var(--border)">
             <i class="fas fa-user-graduate"></i>
         </div>
         <div>
            <h3 id="u-name" style="margin:0; color:var(--text)"></h3>
            <span id="u-cls" style="color:var(--gold); font-size:0.9em"></span>
         </div>
    </div>
    <button class="btn btn-o" style="width:auto; color:var(--red); border-color:var(--red)" onclick="logout()">
        <i class="fas fa-power-off"></i> خروج
    </button>
  </div>
  
  <!-- Tabs -->
  <div style="display:flex; gap:10px; margin-bottom:20px; overflow-x:auto; padding-bottom:10px">
      <button class="btn btn-p" onclick="switchTab('exams')"><i class="fas fa-file-alt"></i> الامتحانات</button>
      <button class="btn btn-o" onclick="switchTab('library')"><i class="fas fa-book"></i> المكتبة</button>
      <button class="btn btn-o" onclick="switchTab('history')"><i class="fas fa-history"></i> سجلي</button>
  </div>
  
  <!-- [MODIFIED] Exams View supports Hierarchy -->
  <div id="tab-exams">
      <div class="card" style="min-height:400px">
          <!-- Breadcrumbs -->
          <div id="exam-breadcrumbs" class="breadcrumb hidden">
              <span class="bread-item" onclick="resetHierarchy()">الرئيسية</span>
              <span class="bread-sep">/</span>
              <span id="bread-current" class="bread-active">...</span>
          </div>
          
          <!-- Folder Grid -->
          <div id="folders-container" class="folder-grid">
              <!-- Content injected by JS -->
          </div>
      </div>
  </div>
  
  <div id="tab-library" class="hidden">
      <div class="card"><h3 style="color:var(--gold)">مكتبة الصف</h3><div id="std-lib-list"></div></div>
  </div>
  <div id="tab-history" class="hidden">
      <div class="card"><h3>سجلي الدراسي</h3><table id="res-tbl"><thead><tr><th>الامتحان</th><th>النتيجة</th></tr></thead><tbody id="res-list"></tbody></table></div>
  </div>
</div>

<!-- ================= 4. EXAM INTERFACE (Paywall & Honey Pot) ================= -->
<div id="v-exam" class="container hidden">
  <div class="card" style="position:sticky; top:10px; z-index:100; backdrop-filter:blur(20px); background:rgba(15, 23, 42, 0.95); border:1px solid var(--blue)">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h3 id="xt" style="margin:0; color:var(--blue)"></h3>
      <div id="exam-timer" style="font-family:'Amiri'; font-weight:bold; color:var(--text); font-size:1.2em">00:00</div>
    </div>
    <div style="height:4px; background:#444; margin-top:10px; border-radius:2px; overflow:hidden">
         <div id="exam-progress" style="height:100%; width:0%; background:var(--green); transition:0.3s"></div>
    </div>
  </div>
  
  <div class="card" id="q-card">
    <div id="q-box" style="text-align:right"></div>
    <hr style="border-color:var(--border); margin:20px 0">
    
    <div style="display:flex; gap:10px; justify-content:space-between">
      <button class="btn btn-o" style="width:auto" onclick="nav(-1)"><i class="fas fa-arrow-right"></i> السابق</button>
      <button class="btn btn-p" style="width:auto" onclick="nav(1)">التالي <i class="fas fa-arrow-left"></i></button>
    </div>
    
    <button id="s-btn" class="btn btn-g hidden" onclick="sub()" style="margin-top:20px">إنهاء وتسليم الامتحان <i class="fas fa-check-circle"></i></button>
    <button class="btn btn-o" onclick="exitExam()" style="margin-top:10px; border:none; color:#94a3b8">خروج من الامتحان</button>
  </div>
</div>

<!-- ================= CERTIFICATE MODAL ================= -->
<div id="cert-modal">
  <div class="cert-box" id="cert-node">
      <img src="https://i.ibb.co/VrJsk41/Gemini-Generated-Image-u0u4kwu0u4kwu0u4.png" style="width:80px; margin-bottom:10px">
      <h1 style="color:#1e3a8a; font-family:'Amiri'">شهادة تفوق</h1>
      <p>تشهد منصة نبراس بأن الطالب:</p>
      <h2 id="c-name" style="color:black; border-bottom:1px solid #ccc; display:inline-block; padding:0 30px"></h2>
      <p>قد اجتاز امتحان <b id="c-ex"></b> بنتيجة:</p>
      <h1 id="c-sc" style="color:#d97706; font-size:50px"></h1>
  </div>
  <button class="btn btn-o" onclick="document.getElementById('cert-modal').style.display='none'" style="position:absolute; bottom:20px; width:auto; background:white; color:black">إغلاق</button>
</div>

<!-- ================= JAVASCRIPT LOGIC ================= -->
<script>
// ================= CONFIGURATION =================
const API_URL = "https://script.google.com/macros/s/AKfycbyJ8FX2Hd_OAakWU0Gbo35jcLq5b-tjwGdoGb4RimJtJCfgZqWnM4OSa7kGV-usUwgX/exec"; 
let token = localStorage.getItem('tk');

// State Variables for Hierarchy & Exam
let hierarchyData = {}; 
let st = { 
    exam: [], idx: 0, ans: {}, title: '', 
    isGuest: false, // HONEY POT FLAG
    startTime: 0, timerInterval: null
};

// ================= INITIALIZATION =================
window.onload = function() {
    if(token) {
        if(token === 'GUEST') {
            document.getElementById('u-name').innerText = "زائر";
            document.getElementById('u-cls').innerText = "تجربة مجانية";
        } else {
            document.getElementById('u-name').innerText = localStorage.getItem('nm');
            document.getElementById('u-cls').innerText = localStorage.getItem('cl');
        }
        loadDashboard();
    }
};

// ================= NAVIGATION & AUTH =================
function goHome() {
    ['landing-page'].forEach(i => document.getElementById(i).classList.remove('hidden'));
    ['auth-container', 'v-dash', 'v-exam'].forEach(i => document.getElementById(i).classList.add('hidden'));
}

function showAuth(type) {
    document.getElementById('landing-page').classList.add('hidden');
    document.getElementById('auth-container').classList.remove('hidden');
    if(type === 'login') {
        document.getElementById('f-login').classList.remove('hidden');
        document.getElementById('f-reg').classList.add('hidden');
        document.getElementById('auth-title').innerText = "تسجيل الدخول";
    } else {
        document.getElementById('f-login').classList.add('hidden');
        document.getElementById('f-reg').classList.remove('hidden');
        document.getElementById('auth-title').innerText = "تفعيل اشتراك جديد";
    }
}
function switchAuth(type) { showAuth(type); }

function navToSection(id) {
    goHome();
    document.getElementById(id).scrollIntoView({behavior:'smooth'});
}

// [NEW] GUEST LOGIN Logic
function guestLogin() {
    token = "GUEST";
    localStorage.setItem('tk', "GUEST");
    callApi('trackEvent', {metric: 'Guest_Login', details: 'User started guest session'});
    
    document.getElementById('u-name').innerText = "زائر";
    document.getElementById('u-cls').innerText = "تجربة مجانية";
    loadDashboard();
}

function login() {
    let e = document.getElementById('le').value, p = document.getElementById('lp').value;
    callApi('loginUser', {email:e, pass:p}).then(r => {
        if(r.success) { saveSession(r); loadDashboard(); } 
        else Swal.fire('خطأ', r.message, 'error');
    });
}

function reg() {
    let d = {
        code: document.getElementById('rc').value,
        name: document.getElementById('rn').value,
        email: document.getElementById('re').value,
        password: document.getElementById('rpa').value,
        phone: document.getElementById('rph').value
    };
    callApi('registerStudent', {d:d}).then(r => {
        if(r.success) { saveSession(r); loadDashboard(); }
        else Swal.fire('خطأ', r.message, 'error');
    });
}

function saveSession(r) {
    localStorage.setItem('tk', r.token);
    localStorage.setItem('nm', r.name);
    localStorage.setItem('cl', r.classLevel);
    token = r.token;
}

function logout() { localStorage.clear(); location.reload(); }

// ================= DASHBOARD & HIERARCHY SYSTEM =================
function loadDashboard() {
    document.getElementById('landing-page').classList.add('hidden');
    document.getElementById('auth-container').classList.add('hidden');
    document.getElementById('v-dash').classList.remove('hidden');
    
    // Load Hierarchy from Backend
    document.getElementById('folders-container').innerHTML = '<p style="text-align:center">جاري تحميل المواد...</p>';
    callApi('getExamsList', {token: token}).then(r => {
        if(r.success) {
            hierarchyData = r.hierarchy; // Store Tree
            renderHierarchyRoot();
        }
    });
}

function switchTab(tab) {
    ['tab-exams', 'tab-library', 'tab-history'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById('tab-'+tab).classList.remove('hidden');
    if(tab==='library') loadLib();
    if(tab==='history') loadHist();
}

// --- HIERARCHY RENDERING ---
function renderHierarchyRoot() {
    const container = document.getElementById('folders-container');
    const bread = document.getElementById('exam-breadcrumbs');
    container.innerHTML = '';
    bread.classList.add('hidden');
    
    let classes = Object.keys(hierarchyData);
    if(classes.length === 0) { container.innerHTML = 'لا توجد بيانات.'; return; }
    
    classes.forEach(cls => {
        let count = Object.keys(hierarchyData[cls]).length;
        container.innerHTML += `
        <div class="folder-item animate__animated animate__fadeIn" onclick="openClass('${cls}')">
            <i class="fas fa-graduation-cap folder-icon"></i>
            <div class="folder-title">${cls}</div>
            <div class="folder-meta">${count} مواد</div>
        </div>`;
    });
}

function openClass(clsName) {
    const container = document.getElementById('folders-container');
    const bread = document.getElementById('exam-breadcrumbs');
    container.innerHTML = '';
    
    bread.classList.remove('hidden');
    bread.innerHTML = `<span class="bread-item" onclick="renderHierarchyRoot()">الرئيسية</span> <span class="bread-sep">/</span> <span class="bread-active">${clsName}</span>`;
    
    let subjects = hierarchyData[clsName];
    Object.keys(subjects).forEach(sub => {
        let count = subjects[sub].length;
        container.innerHTML += `
        <div class="folder-item animate__animated animate__fadeIn" onclick="openSubject('${clsName}', '${sub}')">
            <i class="fas fa-book folder-icon" style="color:var(--blue)"></i>
            <div class="folder-title">${sub}</div>
            <div class="folder-meta">${count} امتحانات</div>
        </div>`;
    });
}

function openSubject(clsName, subName) {
    const container = document.getElementById('folders-container');
    const bread = document.getElementById('exam-breadcrumbs');
    container.innerHTML = '';
    
    bread.innerHTML = `
        <span class="bread-item" onclick="renderHierarchyRoot()">الرئيسية</span> 
        <span class="bread-sep">/</span> 
        <span class="bread-item" onclick="openClass('${clsName}')">${clsName}</span>
        <span class="bread-sep">/</span> 
        <span class="bread-active">${subName}</span>
    `;
    
    let exams = hierarchyData[clsName][subName];
    exams.forEach(ex => {
        container.innerHTML += `
        <div class="folder-item exam-node animate__animated animate__zoomIn" onclick="startExam('${ex.title}')">
            <i class="fas fa-file-alt folder-icon"></i>
            <div class="folder-title">${ex.title}</div>
            <div class="folder-meta">اضغط للبدء</div>
        </div>`;
    });
}
function resetHierarchy() { renderHierarchyRoot(); }

// ================= EXAM ENGINE (HONEY POT & PAYWALL) =================
function startExam(title) {
    Swal.fire({title: 'جاري التحميل...', didOpen: () => Swal.showLoading()});
    
    callApi('getExamQuestions', {token: token, name: title}).then(r => {
        Swal.close();
        if(r.success) {
            st.exam = r.questions;
            st.idx = 0;
            st.ans = {};
            st.title = title;
            // [IMPORTANT] Set Guest Flag from Backend
            st.isGuest = r.isGuest;
            
            // UI Switch
            document.getElementById('v-dash').classList.add('hidden');
            document.getElementById('v-exam').classList.remove('hidden');
            document.getElementById('xt').innerText = title;
            
            // Timer
            st.startTime = Date.now();
            if(st.timerInterval) clearInterval(st.timerInterval);
            st.timerInterval = setInterval(() => {
                let diff = Math.floor((Date.now() - st.startTime)/1000);
                let m = Math.floor(diff/60).toString().padStart(2,'0');
                let s = (diff%60).toString().padStart(2,'0');
                document.getElementById('exam-timer').innerText = m + ":" + s;
            }, 1000);
            
            rendQ();
        } else {
            Swal.fire('خطأ', r.message, 'warning');
        }
    });
}

function rendQ() {
    let q = st.exam[st.idx];
    let h = `<h3>سؤال ${st.idx + 1}: ${q.text}</h3>`;
    if(q.img) h += `<img src="${q.img}" style="max-width:100%; border-radius:10px; margin-bottom:15px">`;
    
    q.opts.forEach(opt => {
        let sel = st.ans[q.id] === opt ? 'selected' : '';
        h += `<div class="q-option ${sel}" onclick="answer('${opt}')">
                <div class="opt-circle"></div> ${opt}
              </div>`;
    });
    
    document.getElementById('q-box').innerHTML = h;
    
    // Progress
    let pct = ((st.idx + 1) / st.exam.length) * 100;
    document.getElementById('exam-progress').style.width = pct + '%';
    
    // Buttons
    if(st.idx === st.exam.length - 1) document.getElementById('s-btn').classList.remove('hidden');
    else document.getElementById('s-btn').classList.add('hidden');
}

function answer(val) {
    st.ans[st.exam[st.idx].id] = val;
    rendQ();
}

// [CRITICAL] PAYWALL LOGIC
function nav(dir) {
    let nextIdx = st.idx + dir;
    if(nextIdx < 0 || nextIdx >= st.exam.length) return;
    
    // CHECK PAYWALL: Guest cannot go past Question index 6 (i.e., Question 7)
    if(st.isGuest && nextIdx > 6) {
        document.getElementById('paywall-modal').style.display = 'flex';
        callApi('trackEvent', {metric: 'Paywall_Hit', details: st.title + ' - Stop at Q7'});
        return; // STOP
    }
    
    st.idx = nextIdx;
    rendQ();
}

function sub() {
    if(st.isGuest) {
        Swal.fire({
            title: 'نسخة تجريبية',
            text: 'يجب الاشتراك لحفظ النتائج والحصول على الشهادة.',
            icon: 'info',
            confirmButtonText: 'اشتراك'
        }).then((r) => { if(r.isConfirmed) subscribeNow(); });
        return;
    }
    
    if(!confirm('تسليم الامتحان؟')) return;
    clearInterval(st.timerInterval);
    
    callApi('submitExam', {token:token, n:st.title, a:st.ans, cheats:0}).then(r => {
        if(r.success) {
            if(r.percent >= 50) confetti();
            Swal.fire(`النتيجة: ${r.percent}%`, '', r.percent>=50?'success':'error').then(()=>exitExam());
        } else {
            Swal.fire('خطأ', r.message, 'error');
        }
    });
}

function exitExam() {
    clearInterval(st.timerInterval);
    document.getElementById('v-exam').classList.add('hidden');
    document.getElementById('v-dash').classList.remove('hidden');
    loadDashboard();
}

// ================= UTILS & API =================
function subscribeNow() {
    callApi('trackEvent', {metric: 'WhatsApp_Click', details: 'From Paywall/Landing'});
    window.open("https://wa.me/96270000000?text=" + encodeURIComponent("مرحباً، أرغب بالاشتراك في منصة نبراس"), "_blank");
}

function toggleFaq(el) {
    el.classList.toggle('active');
}

function loadLib() {
    callApi('getLibraryContent', {token:token}).then(r=>{
        let h=''; if(r.library) r.library.forEach(l=> h+=`<div style="padding:10px; border-bottom:1px solid #ccc"><a href="${l.link}" target="_blank">${l.title}</a></div>`);
        document.getElementById('std-lib-list').innerHTML = h || 'لا توجد ملفات';
    });
}

function loadHist() {
    callApi('getStudentResults', {token:token}).then(r=>{
        let h=''; if(r.results) r.results.forEach(x=> h+=`<tr><td>${x.exam}</td><td>${x.percent}%</td></tr>`);
        document.getElementById('res-list').innerHTML = h;
    });
}

function showPublicLibrary() {
    goHome();
    document.getElementById('home-view').classList.add('hidden');
    document.getElementById('public-library-ui').classList.remove('hidden');
    
    callApi('getPublicLibraryData', {filterClass:'All', filterSubject:'All'}).then(r => {
        let h = '';
        if(r.list) r.list.forEach(f => {
            h += `<div class="folder-item"><i class="fas fa-file-pdf folder-icon"></i><div class="folder-title">${f.title}</div><a href="${f.link}" target="_blank" class="btn btn-o btn-sm" style="margin-top:10px">معاينة</a></div>`;
        });
        document.getElementById('public-lib-grid').innerHTML = h;
    });
}

async function callApi(action, data) {
    document.getElementById('loader').style.display = 'flex';
    data.action = action;
    try {
        let r = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(data)
        });
        let j = await r.json();
        document.getElementById('loader').style.display = 'none';
        return j;
    } catch(e) {
        document.getElementById('loader').style.display = 'none';
        console.error(e);
        return {success:false, message: "Connection Error"};
    }
}
</script>
</body>
</html>
```
