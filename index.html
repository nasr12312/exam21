ØªÙ…Ø§Ù…Ø§Ù‹ØŒ Ø³Ø£Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„.

Ù‡Ø°Ø§ Ù‡Ùˆ **ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Ø¯Ù… (Backend - Code.gs)** Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.
**Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª:**
1.  ØªØ­Ø¯ÙŠØ« `doGet` Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª **SEO** ÙˆØµÙØ­Ø§Øª **Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©**.
2.  ØªØ­Ø¯ÙŠØ« `doPost` Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Public Exams).
3.  Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© `getPublicExamsList` Ù„Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù„Ù„Ø²ÙˆØ§Ø±.
4.  Ø¥Ø¶Ø§ÙØ©----------------------------------------------------
    // [A] Ù‚Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Student API)
    // ---------------------------------------------------- Ø¯Ø§Ù„Ø© `getPublicExamPreview` Ù„Ø¬Ù„Ø¨ **3 Ø£Ø³Ø¦Ù„Ø© ÙÙ‚Ø·** Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.


    if (action === 'loginUser') {
      output = loginUser(data.email, data.pass, data.deviceId);
    } 
    else if (action === 'registerStudent') {
      ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ ÙˆÙˆØ¶Ø¹Ù‡ ÙÙŠ Ù…Ù„Ù `Code.gs`:

```javascript
// =================================output = registerStudent(data.d);
    }
    else if (action === 'createTrialAccount')===========================================
// ğŸ“ Ù†Ø¸Ø§Ù… Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ (Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ V {
      output = createTrialAccount(data.d);
    } 
    else if (action === 'getExamsList') {
      output = getExamsList(data.token);
    }
16 - SEO & Preview Lock)
// ============================================================================
// Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© Â© 2024
// âš ï¸ Ù‡Ø§Ù…: Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ (Backend) Ù„Ù„Ù…Ù†ØµØ©.

var WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyJ8FX2Hd_OAakWU0Gbo35jcLq5b-tjwGdoGb4RimJtJCfgZqWnM4OSa7kGV-usUwgX/exec"; 

/* ============================================================================
   ğŸš€ 1. Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Main Router) - doPost
       else if (action === 'getExamQuestions') {
      output = getExamQuestions(data.token, data.name); 
    }
    else if (action === 'submitExam') {
      output = submitExam(data.token, data.n, data.a, data.cheats);
    }
    else if (action === 'getReviewData') {
      output = getReviewData(data.token, data.title);
    }
    else if (action === 'getStudentResults') {
      output = getStudentResults(data.token);
    }
    else if (action === 'getLeaderboard') {ÙŠØ³ØªÙ‚Ø¨Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (JSON) ÙˆÙŠÙˆØ¬Ù‡Ù‡Ø§ Ù„Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©.
   ================================================================
      output = getLeaderboard(data.token);
    }
    else if (action === 'get============
*/
function doPost(e) {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£LibraryContent') {
      output = getLibraryContent(data.token);
    }
    else if (Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
  if (!e || !e.postData || !e.postData.contents) {
      return ContentServiceaction === 'uploadStudentAssignment') {
      output = uploadStudentAssignment(data.token, data.d);
    }
    else if (action === 'sendComplaint') {
      output = sendComplaint(data.token, data.msg);
    }
    else if (action === 'getStudentStats') {
      .createTextOutput(JSON.stringify({
        success: false, 
        message: "No Data Received or Invalid Request Format"
      })).setMimeType(ContentService.MimeType.JSON);
  }
  var output = {success: false, message: "Invalid Request Action"};
  
  try {output = getStudentStats(data.token);
    }
    else if (action === 'saveStudentNote
    // 2. Ø§Ù„ÙØ­Øµ Ø§Ù„Ø°Ø§ØªÙŠ Ù„Ù„Ù†Ø¸Ø§Ù… (Auto-Fix)
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¬Ø¯ÙˆÙ„') {
      output = saveStudentNote(data.token, data.text);
    }
    else Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙˆØ±Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ù†Ù‡ÙŠØ§Ø±
    var ss = Spreadsheet if (action === 'getStudentNote') {
      output = getStudentNote(data.token);
    App.getActiveSpreadsheet();
    if (!ss.getSheetByName('Students')) {
       setupDatabase();
}
    else if (action === 'updateProfile') {
      output = updateProfile(data.token,    }
    var jsonString = e.postData.contents;
    var data = JSON.parse(jsonString);
    var action = data.action;

    // ----------------------------------------------------
    // [ data.newPass, data.newPhoto);
    }
    else if (action === 'getStudentMessagesA] Ù‚Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Student API)
    // ----------------------------------------------------
    if (action === 'login') {
      output = getStudentMessages(data.token);
    }
    else if (action ===User') {
      output = loginUser(data.email, data.pass, data.deviceId);
    } 
    else if (action === 'registerStudent') {
      output = registerStudent(data.d);
    }
    else if (action === 'createTrialAccount') {
      output = createTrialAccount 'softDeleteAccount') {
      output = softDeleteAccount(data.token);
    }
    else if (action === 'getPublicData') {
      output = getPublicData(); 
    }
    (data.d);
    } 
    else if (action === 'getExamsList') {
// === [NEW] Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (SEO & Preview) ===
    else if (action === 'getPublic      output = getExamsList(data.token);
    }
    else if (action === 'getLibraryData') {
       output = getPublicLibraryData(data.filterClass, data.filterSubject);
ExamQuestions') {
      output = getExamQuestions(data.token, data.name); 
    }    }
    else if (action === 'getPublicFileDetails') {
       output = getPublicFileDetails
    else if (action === 'submitExam') {
      output = submitExam(data.token, data(data.fileId);
    }
    else if (action === 'getPublicExamsList') {.n, data.a, data.cheats);
    }
    else if (action === 'get
       output = getPublicExamsList(data.filterClass, data.filterSubject);
    }
    else if (action === 'getPublicExamPreview') {
       output = getPublicExamPreview(data.title);
    }
    // ===============================================================

    // ----------------------------------------------------
    // [B] Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±ReviewData') {
      output = getReviewData(data.token, data.title);
    }
    else if (action === 'getStudentResults') {
      output = getStudentResults(data.token);
    }
    else if (action === 'getLeaderboard') {
      output = getLeaderboard(data.token);
    }
    else if (action === 'getLibraryContent') {
      output = (Admin API)
    // ----------------------------------------------------
    else if (action === 'getAdminData') getLibraryContent(data.token);
    }
    else if (action === 'uploadStudentAssignment') { {
      output = getAdminData_V2(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    } 

      output = uploadStudentAssignment(data.token, data.d);
    }
    else if (action === 'sendComplaint') {
      output = sendComplaint(data.token, data.msg);
        else if (action === 'getAdminData_V2') { 
      output = getAdminData_V2();
    }
    else if (action === 'generateNewCodes') {
      output = generate}
    else if (action === 'getStudentStats') {
      output = getStudentStats(data.NewCodes(data.count, data.cls, data.days);
    }
    else if (actiontoken);
    }
    else if (action === 'saveStudentNote') {
      output = saveStudentNote(data.token, data.text);
    }
    else if (action === 'getStudentNote === 'deleteUsedCodes') {
      output = deleteUsedCodes();
    }
    else if (action === 'getAllResultsForAdmin') {
      output = getAllResultsForAdmin();
    }
    else if (action === 'deleteResultRow') {
      output = deleteResultRow(data.rowId);
    ') {
      output = getStudentNote(data.token);
    }
    else if (action === 'updateProfile') {
      output = updateProfile(data.token, data.newPass, data.newPhoto);
    }
    else if (action === 'getStudentMessages') {
      output = getStudent}
    else if (action === 'getLibraryForAdmin') {
      output = getLibraryForAdmin();Messages(data.token);
    }
    else if (action === 'softDeleteAccount') {
      
    }
    else if (action === 'addToLibrary') {
      output = addToLibrary(data.d);
    }
    else if (action === 'deleteLibraryItem') {
      output = deleteLibraryoutput = softDeleteAccount(data.token);
    }
    else if (action === 'getPublicDataItem(data.rowId);
    }
    else if (action === 'getAssignmentsForAdmin') {') {
      output = getPublicData(); 
    }
    // === Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„
      output = getAssignmentsForAdmin();
    }
    else if (action === 'gradeAssignment') {Ù€ SEO ===
    else if (action === 'getPublicLibraryData') {
       output = getPublicLibraryData(data
      output = gradeAssignment(data.rowId, data.grade);
    }
    else if (.filterClass, data.filterSubject);
    }
    else if (action === 'getPublicFileDetailsaction === 'getComplaintsForAdmin') {
      output = getComplaintsForAdmin();
    }
') {
       output = getPublicFileDetails(data.fileId);
    }
    // [NEW    else if (action === 'replyToComplaint') {
      output = replyToComplaint(data.rowId: Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©]
    else if (action === 'getPublicExamsList') {
, data.reply);
    }
    else if (action === 'saveGeneralSettings') {
      output       output = getPublicExamsList(data.filterClass, data.filterSubject);
    }
     = saveGeneralSettings(data.s);
    }
    else if (action === 'sendTargetedMessageelse if (action === 'getPublicExamPreview') {
       output = getPublicExamPreview(data.title') {
      output = sendTargetedMessage(data.target, data.msg);
    }
    );
    }
    // [END NEW]

    // ----------------------------------------------------
    // [Belse if (action === 'getStudentsForCards') {
      output = getStudentsForCards();
    }] Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± (Admin API)
    // ----------------------------------------------------
    else if (action === 'get
    else if (action === 'adminResetPass') {
      output = adminResetPass(data.emailAdminData') {
      output = getAdminData_V2(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    , data.newPass);
    }
    else if (action === 'deleteStudent') {
      output} 
    else if (action === 'getAdminData_V2') { 
      output = get = deleteStudent(data.email);
    }
    else if (action === 'resetStudentDevice') {AdminData_V2();
    }
    else if (action === 'generateNewCodes') {
      
      output = resetStudentDevice(data.email); 
    }
    else if (action === 'output = generateNewCodes(data.count, data.cls, data.days);
    }
    elsegetGlobalLeaderboard') {
      output = getGlobalLeaderboard(data.filterCls);
    } if (action === 'deleteUsedCodes') {
      output = deleteUsedCodes();
    }
    else
    else if (action === 'getExamsForAdminControl') {
      output = getExamsFor if (action === 'getAllResultsForAdmin') {
      output = getAllResultsForAdmin();
    }
AdminControl();
    }
    else if (action === 'toggleExamVisibility') {
      output = toggle    else if (action === 'deleteResultRow') {
      output = deleteResultRow(data.rowIdExamVisibility(data.title, data.status);
    }
    
    // ----------------------------------------------------
    // [C] Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© (System Maintenance)
    // ----------------------------------------------------);
    }
    else if (action === 'getLibraryForAdmin') {
      output = getLibrary
    else if (action === 'cleanDatabase') {
      output = cleanDatabase(data.tables);
ForAdmin();
    }
    else if (action === 'addToLibrary') {
      output = addToLibrary(data.d);
    }
    else if (action === 'deleteLibraryItem') {
      output    } 
    else if (action === 'saveSocialLinks') {
      output = saveSocialLinks( = deleteLibraryItem(data.rowId);
    }
    else if (action === 'getAssignmentsFordata.links);
    } 
    else if (action === 'getSystemLogs') {
      output = getSystemLogs();
    } 
    else if (action === 'getFinancialReport') {
      Admin') {
      output = getAssignmentsForAdmin();
    }
    else if (action === 'gradeAssignment') {
      output = gradeAssignment(data.rowId, data.grade);
    }
    output = getFinancialReport();
    } 
    else if (action === 'resetSpecificTables') {
      output = resetSpecificTables(data.tables);
    } 
    else if (action === 'fullelse if (action === 'getComplaintsForAdmin') {
      output = getComplaintsForAdmin();
SystemSetup') {
      output = {success: true, message: setupDatabase()}; // ğŸ—ï¸ Ø§Ù„Ø¨    }
    else if (action === 'replyToComplaint') {
      output = replyToComplaint(dataÙ†Ø§Ø¡ Ø§Ù„ÙƒØ§Ù…Ù„
    }
      
  } catch(err) {
    Logger.log("Critical Error in.rowId, data.reply);
    }
    else if (action === 'saveGeneralSettings') {
      output = saveGeneralSettings(data.s);
    }
    else if (action === 'send doPost: " + err.toString());
    output = {success: false, message: "Server Error: " + err.toString()};
  }
  return ContentService.createTextOutput(JSON.stringify(output)).TargetedMessage') {
      output = sendTargetedMessage(data.target, data.msg);
    setMimeType(ContentService.MimeType.JSON);
}

/* ============================================================================}
    else if (action === 'getStudentsForCards') {
      output = getStudentsForCards();
   ğŸŒ 2. ØªØ­Ø³ÙŠÙ† SEO ÙÙŠ doGet
   ============================================================================
*/
function doGet(
    }
    else if (action === 'adminResetPass') {
      output = adminResetPass(e) { 
  var template = HtmlService.createTemplateFromFile('index');
  
  // Ø§Ù„Ù‚ÙŠÙ…data.email, data.newPass);
    }
    else if (action === 'deleteStudent') {
      output = deleteStudent(data.email);
    }
    else if (action === 'resetStudent Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  template.pageTitle = "Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨Ø±Ø§Ø³ | Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ù„Ù…Ù†Ù‡Ø§Device') {
      output = resetStudentDevice(data.email); 
    }
    else if (Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ";
  template.pageDesc = "Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨Ø±Ø§Ø³ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©: Ù…ÙˆÙ‚Ø¹ Ø´Ø§Ù…Ù„action === 'getGlobalLeaderboard') {
      output = getGlobalLeaderboard(data.filterCls); ÙŠÙ‚Ø¯Ù… Ø´Ø±ÙˆØ­Ø§Øª Ù…Ø¨Ø³Ø·Ø©ØŒ Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„ØŒ ÙˆØªÙ„Ø®ÙŠØµØ§Øª Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ù„Ù„Ù…Ù†Ù‡Ø§Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ.";
  template.pageKeywords = "Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨Ø±Ø§Ø³, Ø§Ù„Ù…Ù†Ù‡Ø§Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ, Ø´Ø±Ø­ Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©, Ø§Ù…ØªØ­Ø§Ù†Ø§Øª, Ø¯ÙˆØ³ÙŠØ§Øª, ØªÙˆØ¬ÙŠÙ‡ÙŠ 2
    }
    else if (action === 'getExamsForAdminControl') {
      output = getExamsForAdminControl();
    }
    else if (action === 'toggleExamVisibility') {
      output = toggleExamVisibility(data.title, data.status);
    }
    
    // ----------------------------------------------------
    // [C] Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© (System Maintenance)
    // ----------------------------------------------------
    else if (action === 'cleanDatabase') {
      output = cleanDatabase(data.007";
  
  // ğŸ•µï¸â€â™‚ï¸ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø³ÙŠÙˆ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
  if (e && e.parameter) {
    if (e.parameter.view === 'library') {
       template.pageTitle = "Ù…ÙƒØªØ¨Ø© Ù†Ø¨Ø±Ø§Ø³ Ø§Ù„Ø¹Ø§Ù…Ø© | Ù…Ù„Ø®ØµØ§Øª ÙˆØ§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ù‡Ø§tables);
    } 
    else if (action === 'saveSocialLinks') {
      output = saveSocialLinks(data.links);
    } 
    else if (action === 'getSystemLogs') {Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ";
       template.pageDesc = "ØªØµÙØ­ ÙˆØ­Ù…Ù„ Ù…Ø¦Ø§Øª Ø§Ù„Ù…Ù„Ø®ØµØ§ØªØŒ
      output = getSystemLogs();
    } 
    else if (action === 'getFinancialReport') Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„ØŒ ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù„Ù„Ù…Ù†Ù‡Ø§Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ Ù…Ù† Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø­ØªÙ‰ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ.";
 {
      output = getFinancialReport();
    } 
    else if (action === 'resetSpecificTables    }
    else if (e.parameter.view === 'file' && e.parameter.id) {
       // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù„ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…ÙŠØªØ§ ØªØ§Ø¬
       var fileDetails = getPublicFileDetails(e.parameter.id);
       if(fileDetails.success) {
          template.page') {
      output = resetSpecificTables(data.tables);
    } 
    else if (action === 'fullSystemSetup') {
      output = {success: true, message: setupDatabase()}; // Title = fileDetails.data.title + " | " + fileDetails.data.subject + " - " +ğŸ—ï¸ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ§Ù…Ù„
    }
      
  } catch(err) {
    Logger.log(" fileDetails.data.cls;
          template.pageDesc = "ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø´Ø§Ù‡Ø¯Ø© " + fileDetailsCritical Error in doPost: " + err.toString());
    output = {success: false, message: "Server.data.title + " Ù„Ù…Ø§Ø¯Ø© " + fileDetails.data.subject + " Ù„Ù„ØµÙ " + fileDetails. Error: " + err.toString()};
  }
  return ContentService.createTextOutput(JSON.stringify(output)).setMimeType(ContentService.MimeType.JSON);
}

/* ============================================================================
   ğŸŒ 2. ØªØ­Ø³ÙŠÙ† SEO ÙÙŠ doGet
   ============================================================================
*/
function doGet(e) { 
  var template = HtmlService.createTemplateFromFile('index');
  
data.cls + ". Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„ ÙˆÙ…ÙÙŠØ¯.";
          template.pageKeywords += ", " + fileDetails.  // Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  template.pageTitle = "Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨Ø±Ø§Ø³ | Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ©data.title + ", " + fileDetails.data.subject;
       }
    }
    // [ Ù„Ù„Ù…Ù†Ù‡Ø§Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ";
  template.pageDesc = "Ù…Ù†ØµØ© Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨Ø±Ø§Ø³ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©: Ù…ÙˆÙ‚Ø¹ Ø´Ø§Ù…Ù„ ÙŠÙ‚Ø¯Ù… Ø´Ø±ÙˆØ­Ø§Øª Ù…Ø¨Ø³Ø·Ø©ØŒ Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„ØŒ ÙˆØªÙ„Ø®ÙŠØµØ§Øª Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©NEW] ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø³ÙŠÙˆ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    else if (e.parameter.view === 'publicExams') {
       template.pageTitle = "Ø¨Ù†Ùƒ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ | Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³";
       template.pageDesc = "Ø§Ø®ØªØ¨Ø± Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø¢Ù† Ù…Ø¹ Ù…Ø¦Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù„Ù…Ù†Ù‡Ø§Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ. Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ© ÙˆØª ÙˆØ§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ù„Ù„Ù…Ù†Ù‡Ø§Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ.";
  template.pageKeywords = "Ù…Ø¯Ø±Ø³Ø© Ù†Ø¨Ø±Ø§Ø³, Ø§Ù„Ù…Ù†Ù‡Ø§Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ, Ø´Ø±Ø­ Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©, Ø§Ù…ØªØ­Ø§Ù†Ø§Øª, Ø¯ÙˆØ³ÙŠØ§Øª, ØªÙˆØ¬ÙŠÙ‡ÙŠ 2007";
  
  // ğŸ•µï¸â€â™‚ï¸ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø³ÙŠÙˆ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
  if (e && e.parameter) {
    if (e.parameter.view === 'library') {
       template.pageTitle = "Ù…ÙƒØªØ¨Ø© Ù†Ø¨Ø±Ø§Ø³ Ø§Ù„Ø¹Ø§Ù…Ø© | Ù…Ù„Ø®ØµØ§Øª ÙˆØ§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ù‡Ø§Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ";
       template.pageDesc = "ØªØµÙØ­ ÙˆØ­Ù…Ù„ Ù…Ø¦Ø§Øª Ø§Ù„Ù…Ù„Ø®ØµØ§ØªØŒ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„ØŒ ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù„Ù„Ù…Ù†Ù‡Ø§Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ Ù…Ù† Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø­ØªÙ‰ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø¬Ø±ÙŠØ¨ÙŠØ©.";
       template.pageKeywords += ", Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©, Ø§Ù…ØªØ­Ø§Ù† Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†, Ø§Ø³Ø¦Ù„Ø© Ø³Ù†ÙˆØ§ØªÙŠ.";
    }
    else if (e.parameter.view === 'file' && e.parameter.";
    }
    else if (e.parameter.exam) {
       var exTitle = e.parameter.exam;
       template.pageTitle = "Ø§Ù…ØªØ­Ø§Ù†: " + exTitle + " | Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³";
       template.pageDesc = "Ø§Ø¨Ø¯Ø£ Ø§Ø®ØªØ¨Ø§Ø± " + exTitle + " Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³. Ø§Ø¹Ø±Ù Ù†ØªÙŠØ¬ØªÙƒ ÙÙˆØ±Ø§Ù‹ ÙˆÙ†Ø§ÙØ³ Ø²Ù…Ù„Ø§Ø¡Ùƒ.";
       template.pageKeywords += ", " + exTitle;
    }
  }
  return template.evaluate()
      .setTitle(template.pageTitle)
      .addMetaid) {
       // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù„ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…ÙŠØªØ§ ØªØ§Ø¬
       var fileDetailsTag('viewport', 'width=device-width, initial-scale=1.0')
      .addMeta = getPublicFileDetails(e.parameter.id);
       if(fileDetails.success) {
          Tag('description', template.pageDesc)
      .addMetaTag('keywords', template.pageKeywords)
template.pageTitle = fileDetails.data.title + " | " + fileDetails.data.subject + " - " + fileDetails.data.cls;
          template.pageDesc = "ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø´Ø§Ù‡Ø¯Ø© "      // Ø¥Ø¶Ø§ÙØ© Open Graph Meta Tags Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙÙŠØ³Ø¨ÙˆÙƒ ÙˆÙˆØ§ØªØ³Ø§Ø¨
      .addMetaTag('og:title', template.page + fileDetails.data.title + " Ù„Ù…Ø§Ø¯Ø© " + fileDetails.data.subject + " Ù„Ù„ØµÙ " +Title)
      .addMetaTag('og:description', template.pageDesc)
      .addMetaTag fileDetails.data.cls + ". Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„ ÙˆÙ…ÙÙŠØ¯.";
          template.pageKeywords += ", " + fileDetails.data.title('og:type', 'website')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode + ", " + fileDetails.data.subject;
       }
    }
    // [NEW: ØªØ­.ALLOWALL);
}

/* ============================================================================
   ğŸ”§ 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (The Bridge)
   Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ³Ù…Ø­ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø§Ù„Ø¹Ù…Ù„ Ø¯Ø§Ø®Ø³ÙŠÙ† Ø§Ù„Ø³ÙŠÙˆ Ù„ØµÙØ­Ø© Ø¨Ù†Ùƒ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª]
    else if (e.parameter.view === 'publicExams') {
       templateÙ„ÙŠØ§Ù‹ Ø¨Ø¯ÙˆÙ† Web App URL
   ============================================================================
*/
function handleAdminRequest(jsonString).pageTitle = "Ø¨Ù†Ùƒ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„ | Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©";
       template.pageDesc = "ØªØµÙØ­ Ù…Ø¦Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„Ù…Ù†Ù‡Ø§Ø¬ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ. Ø§Ø®Øª {
  // Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø¯Ø« doPost Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹
  var e = {
    postData: {
      contents: jsonString
    }
  };
  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
  Ø¨Ø± Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø¢Ù† Ù…Ø¬Ø§Ù†Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.";
    }
    // [NEW: ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø³ÙŠÙˆ Ù„Ù„Ø§Ù…var result = doPost(e);
  // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Øµ (JSON) Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ÙŠÙ‚Ø±Ø£Ù‡ Ø§Ù„Ù…ØªØµÙØ­
  return result.getContent();
}

/* ============================================================================
   ğŸ§  4.ØªØ­Ø§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ©]
    else if (e.parameter.exam) {
       template.pageTitle = "Ø§Ù…ØªØ­Ø§Ù†: " + e.parameter.exam + " | Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³";
       template.pageDesc = "Ø§Ø®ØªØ¨Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø¢Ù† ÙÙŠ " + e Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
   ============================================================================
*/

// [NEW FUNCTION] Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Public)
function getPublicExamsList(filterClass, filterSubject) {
.parameter.exam + " Ø¹Ù„Ù‰ Ù…Ù†ØµØ© Ù†Ø¨Ø±Ø§Ø³ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©. Ø§Ù…ØªØ­Ø§Ù† ØªÙØ§Ø¹Ù„ÙŠ Ù…Ø¹ ØªØµØ­ÙŠØ­ ÙÙˆØ±ÙŠ.";
         var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('Exams');template.pageKeywords += ", Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ©, " + e.parameter.exam;
    }
  }
  return
  if(!sheet) return {success:true, list:[]};
  
  var d = sheet template.evaluate()
      .setTitle(template.pageTitle)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1.0')
      .addMetaTag('description', template.getDataRange().getValues();
  var list = [];
  
  // Start from 1 to skip header
  for(var i=1; i<d.length; i++) {
    var title = d[i][0.pageDesc)
      .addMetaTag('keywords', template.pageKeywords)
      // [NEW: Open Graph Meta Tags]
      .addMetaTag('og:title', template.pageTitle)
      .];
    var cls = String(d[i][1]).trim();
    var status = d[i][6addMetaTag('og:description', template.pageDesc)
      .setXFrameOptionsMode(HtmlService];
    var subject = String(d[i][7]||"Ø¹Ø§Ù…").trim();
    
    .XFrameOptionsMode.ALLOWALL);
}

/* ============================================================================
   ğŸ”§ 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (The Bridge)
   Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ³Ù…Ø­ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø§Ù„Ø¹Ù…Ù„ Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹ Ø¨Ø¯ÙˆÙ† Web App URL
   ============================================================================
*/
function handleAdminRequest(jsonString) {
  // Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø¯Ø« doPost Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹
  var e = {
    postData: {
      contents: jsonString
    }
  };
  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
  var result = doPost(e);
  // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Øµ (JSON) Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ÙŠÙ‚Ø±Ø£Ù‡ Ø§Ù„Ù…ØªØµÙØ­
  return result.getContent();
}

/* ============================================================================
// Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø·Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…Ø®ÙÙŠØ©
    if(status === 'Hidden') continue;
    
   ğŸ§  4. Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª (ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ÙˆØ¸Ø§Ø¦Ù Ù„Ù„Ø¹Ø§Ù…Ø©)
   ============================================================================
*/

// [NEW] Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù„Ù„Ø¹Ø§Ù…Ø©
function getPublicExamsList(filterClass, filterSubject) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('Exams');
  if(!sheet) return {success:true, list:[]};
  
  var d = sheet.getDataRange().getValues();
  var list = [];
  
  for(var i=1; i<d.length; i++) {
    var title = d[i][0];
    var    if (filterClass && filterClass !== 'All' && cls !== filterClass && cls !== "Ø¹Ø§Ù…") continue;
    if (filterSubject && filterSubject !== 'All' && subject !== filterSubject) continue;
    
    list.push({
      title: title,
      cls: cls,
      subject: subject,
      duration: d[i][2] || 15
    });
  }
  // Ø¥Ø±Ø¬Ø§Ø¹ Ø£Ø­Ø¯Ø« Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
  return {success: true, list: list.reverse()};
}

// [NEW FUNCTION] cls = String(d[i][1]).trim();
    var duration = d[i][2];
    var status = d[i][6]; // Status column
    var subject = String(d[i][7]||"Ø¹Ø§Ù…").trim();
    
    // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ÙÙŠØ©
    if (status === 'Hidden') continue;
    
    // Ø§Ù„ÙÙ„ØªØ±Ø©
    if (filterClass && filterClass !== 'All' && cls !== filterClass && cls !== "Ø¹Ø§Ù…") continue;
    if (filterSubject && filterSubject !== 'All' && subject !== filterSubject) continue;
    
    list.push({
       Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù„Ù„Ø¹Ø§Ù…Ø© (Ø£ÙˆÙ„ 3 Ø£Ø³Ø¦Ù„Ø© ÙÙ‚Ø·)
function getPublicExamPreview(examTitle) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var examsData = ss.getSheetByName('Exams').getDataRange().getValues();
  var targetClass = "";
  var found = false;
  
  for(var i=1; i<examsData.length; i++) {
    if(examsData[i][0] == examTitle) {
      targetClass = String(examsData[i][1]).trim();
      found = true;
      break;
    }
  }
  
  if(!found) return {success:false, message:"Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"};
  
  // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ±Ù‚Ø©
  var sheetName = "Questions";
  if(targetClass == "Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ") sheetName = "Q_12";
  else if(targetClass == "Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ") sheetName = "Q_11";
  else if(targetClass == "Ø§Ù„Ø¹Ø§Ø´Ø±") sheetName = "Q_10";
  else if(targetClass == "Ø§Ù„ØªØ§Ø³Ø¹") sheetName = "Q_9";
  else if(targetClass == "Ø§Ù„Ø«Ø§Ù…Ù†") sheetName = "Q_8";
  else if(targetClass == "Ø§Ù„Ø³Ø§Ø¨Ø¹") sheetName = "Q_7";
  else if(targetClass == "Ø§Ù„Ø³Ø§Ø¯Ø³") sheetName = "Q_6";
  else if(targetClass == "Ø§Ù„Ø®Ø§Ù…Ø³") sheetName = "Q_5";
  else if(targetClass == "Ø§Ù„Ø±Ø§Ø¨Ø¹") sheetName = "Q_4";
  else if(targetClass == "Ø§Ù„Ø«Ø§Ù„Ø«") sheetName = "Q_3";
  
  var qSheet = ss.getSheetByName(sheetName);
  if(!qSheet) qSheet = ss.getSheetByName('Questions'); 
  
  if(!qSheet) return {success:false, message:"title: title,
      cls: cls,
      subject: subject,
      duration: duration
    });
  }
  return {success: true, list: list.reverse()};
}

// [NEW] Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† (Ø£ÙˆÙ„ 3 Ø£Ø³Ø¦Ù„Ø© ÙÙ‚Ø·)
function getPublicExamPreview(examTitle) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var examsData = ss.getSheetByName('Exams').getDataRange().getValues();
  var targetClass = "";
  var found = false;
  
  for(var i=1; i<examsData.length; i++) {
    if(examsData[i][0] == examTitle) {
      targetClass = String(examsData[Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†"};
  
  var d = qSheet.getDataRange().geti][1]).trim();
      found = true;
      break;
    }
  }
  Values();
  var qs = [];
  
  for(var i=1; i<d.length
  if(!found) return {success:false, message:"Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"};

  // Ù…Ù†Ø·; i++) {
    if(d[i][0] == examTitle) {
      var opts = [d[i][2], d[i][3], d[i][4], d[i][5]].filter(String);
      shuffleArray(opts);
      qs.push({id:i, text:d[i][1], opts:opts, img:d[i][7]});
    }
  }
  
  if(qs.length === 0) return {success:false, message:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¶Ø§ÙØ©."};
  
  // Ø®Ù„Ø· Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
  shuffleArray(qs); 
  
  Ù‚ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´ÙŠØª (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
  var sheetName = "Questions";
  if(targetClass == "Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ") sheetName = "Q_12";
  else if(targetClass == "Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ") sheetName = "Q_11";
  else if(targetClass == "Ø§Ù„Ø¹Ø§Ø´Ø±") sheetName = "Q_10";
  else if(targetClass == "Ø§Ù„ØªØ§Ø³Ø¹") sheetName = "Q_9";
  else if(targetClass == "Ø§Ù„Ø«Ø§Ù…Ù†") sheetName = "Q_8";
  else if(targetClass == "Ø§Ù„Ø³Ø§Ø¨Ø¹") sheetName = "Q_7";
  else if(targetClass == "Ø§Ù„Ø³Ø§Ø¯Ø³") sheetName = "Q_6";
  else if(targetClass == "Ø§Ù„Ø®Ø§Ù…Ø³") sheetName = "Q_5";
  // ğŸ”¥ Ø§Ù„Ù…Ø­Ø¯Ø¯: Ø¥Ø±Ø¬Ø§Ø¹ Ø£ÙˆÙ„ 3 Ø£Ø³Ø¦Ù„Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  var previewLimit = 3;
  varelse if(targetClass == "Ø§Ù„Ø±Ø§Ø¨Ø¹") sheetName = "Q_4";
  else if( limitedQs = qs.slice(0, previewLimit);
  
  return {
      success: true, 
      questions: limitedQs, 
      isPreview: true, // Ø¹Ù„Ø§Ù…Ø© ØªØ¯Ù„ Ø¹Ù„Ù‰ Ø£Ù†Ù‡Ø§ Ù…Ø¹Ø§ÙŠÙ†Ø©
      totalQuestions: qs.length
  };
}

function getExamQuestions(token, examTitle) {
  var u = getUser(token); 
  if(!u) return {success:false, message:"ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ (Invalid Token)"};
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
  var examsSheet = ss.getSheetByName('Exams');
  if(!targetClass == "Ø§Ù„Ø«Ø§Ù„Ø«") sheetName = "Q_3";
  
  var qSheet = ss.getSheetByName(sheetName);
  if(!qSheet) qSheet = ss.getSheetByName('Questions'); 
  
  if(!qSheet) return {success:false, message:"Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©"};
  
  var d = qSheet.getDataRange().getValues();
  var qs = [];
  
  for(var i=1; i<d.length; i++) {
    if(d[i][0] == examTitle) {
      var opts = [d[i][2], d[i][3], d[i][4], d[i][5]].filter(String);
      shuffleArray(opts);
      qs.push({id:i, text:d[i][1], optsexamsSheet) return {success:false, message:"Ø®Ø·Ø£: ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©."};
:opts, img:d[i][7]});
    }
  }
  
  var total  
  var examsData = examsSheet.getDataRange().getValues();
  var targetClass = "";
Questions = qs.length;
  shuffleArray(qs); 
  // [IMPORTANT] Ø¥Ø±Ø¬Ø§Ø¹ ÙÙ‚Ø· Ø£ÙˆÙ„ 3 Ø£Ø³Ø¦Ù„Ø©
  var previewQs = qs.slice(0, 3);
  
  return {
    success: true, 
    isPreview: true, // Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    questions: previewQs, 
    totalCount: totalQuestions
  }; 
}

function getExamQuestions(token, examTitle) {
  var u = getUser(token); 
  if(!u) return {success:false, message:"ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ (Invalid Token)"};
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
  var examsSheet = ss.getSheetByName('Exams');
  if(!examsSheet) return {success:false, message:"Ø®Ø·Ø£: ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©  var found = false;
  
  for(var i=1; i<examsData.length; i++) {
    if(examsData[i][0] == examTitle) {
      targetClass = String(examsData[i][1]).trim();
      found = true;
      break;
    }
  }
  
  if(!found) return {success:false, message:"Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡"};
  // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø´ÙŠØª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
  var sheetName = "Questions";
  if(targetClass == "Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ") sheetName = "Q_12";
  else if(targetClass == "Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ") sheetName = "Q_11";
  else if(targetClass == "Ø§Ù„Ø¹Ø§Ø´Ø±") sheetName = "Q_10";
  else if(targetClass == "Ø§Ù„ØªØ§Ø³Ø¹") sheetName = "Q_9";
  else if(targetClass == "Ø§Ù„Ø«Ø§Ù…Ù†") sheetName = "Q_8";
  else if(targetClass == "."};
  
  var examsData = examsSheet.getDataRange().getValues();
  var targetClass = "";
  var found = false;
  
  for(var i=1; i<examsDataØ§Ù„Ø³Ø§Ø¨Ø¹") sheetName = "Q_7";
  else if(targetClass == "Ø§Ù„Ø³Ø§Ø¯Ø³") sheet.length; i++) {
    if(examsData[i][0] == examTitle) {
      targetClass = String(examsData[i][1]).trim();
      found = true;
      break;
    }
  }
  
  if(!found) return {success:false, message:"Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡"};
  // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø´ÙŠØª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
  var sheetName = "Questions";
  if(targetClass == "Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ") sheetName = "Q_12";
  else if(targetClass == "Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ") sheetName = "Q_Name = "Q_6";
  else if(targetClass == "Ø§Ù„Ø®Ø§Ù…Ø³") sheetName = "Q_5";
  else if(targetClass == "Ø§Ù„Ø±Ø§Ø¨Ø¹") sheetName = "Q_4";
  else if(targetClass == "Ø§Ù„Ø«Ø§Ù„Ø«") sheetName = "Q_3";
  var qSheet = ss.getSheetByName(sheetName);
  // Fallback to general sheet if specific not found
  if(!qSheet) qSheet = ss.getSheetByName('Questions'); 
  
  if(!qSheet) return {success:false, message:"Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„ØµÙ (" + sheetName + ") ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…."};
  var d = qSheet.getDataRange().getValues11";
  else if(targetClass == "Ø§Ù„Ø¹Ø§Ø´Ø±") sheetName = "Q_10";
  else if(targetClass == "Ø§Ù„ØªØ§Ø³Ø¹") sheetName = "Q_9";
  else if(targetClass == "Ø§Ù„Ø«Ø§Ù…Ù†") sheetName = "Q_8";
  else if(targetClass == "Ø§Ù„Ø³Ø§Ø¨Ø¹") sheetName = "Q_7";
  else if(targetClass == "Ø§Ù„Ø³Ø§Ø¯Ø³") sheetName = "Q_6";
  else if(targetClass == "Ø§Ù„Ø®Ø§Ù…Ø³") sheetName = "Q_5";
  else if(targetClass == "Ø§Ù„Ø±Ø§Ø¨Ø¹") sheetName = "Q_4";
  else if(targetClass == "Ø§Ù„Ø«Ø§Ù„Ø«") sheetName = "Q_3";
  var qSheet = ss.getSheetByName(sheetName);
  // Fallback to general sheet if specific not found
  if(!qSheet) qSheet = ss.getSheetByName('Questions'); 
  
();
  var qs = [];
  
  for(var i=1; i<d.length; i++) {
    if(d[i][0] == examTitle) {
      var opts = [d[i][2], d[i][3], d[i][4], d[i][5]].filter(String);
      shuffleArray(opts);
      qs.push({id:i, text:d[i][1], opts:opts, img:d[i][7]});
    }
  }
  
  if(qs.length === 0) return {success:false, message:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø¹Ø¯."};
  
  shuffleArray(qs); 
  
  // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª (Ù…Ø¯Ø© Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹)
  return {success:true, questions:qs, duration: 99999}; 
}

/* ============================================================================
   ğŸ“š   if(!qSheet) return {success:false, message:"Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„ØµÙ (" + sheet5. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ù€ SEO
   ============================================================================
*/
function getPublicLibraryData(filterClass, filterSubject) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('Library');
  if (!sheet) { setupDatabase(); sheet = ss.getSheetByName('Library'); } // Auto-fix
  var d = sheet.getDataRange().getValues();
  var list = [];
  
  var settingsSheet = ss.getSheetByName('Settings');
  var previewPercent = 30; 
  if (settingsSheet) {
      var sData = settingsSheet.getDataRange().getValues();
      sData.forEach(r => { if(r[0] === 'Preview_Percent') previewPercent = parseInt(r[1]) || 30; });
  }
  for (var i = 1Name + ") ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…."};
  var d = qSheet.getDataRange().getValues();
  var qs = [];
  
  for(var i=1; i<d.length; i++) {
    if(d[i][0] == examTitle) {
      var opts = [d[i][2], d[i][3], d[i][4], d[i][5]].filter(String);
      shuffleArray(opts);
      qs.push({id:i, text:d[i][1], opts:opts, img:d[i][7]});
    }
  }
  
  if(qs.length === 0) return {success:false, message:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø¹Ø¯."};
  
  shuffleArray(qs); 
  
  // Ø¥Ù„Øº; i < d.length; i++) {
    var title = d[i][0];
    var type = d[i][1];
    // Ù„Ø§ Ù†Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§
    var cls = dØ§Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª (Ù…Ø¯Ø© Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹)
  return {success:true, questions:qs, duration: [i][3];
    var date = d[i][4];
    var subj = (d[99999}; 
}

/* ============================================================================
   ğŸ“š 5. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ù€ SEO
   ============================================================================
*/
function getPublicLibraryData(filterClass, filterSubject) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('Library');
  if (!sheet) { setupDatabase(); sheet = ss.getSheetByName('Library'); } // Auto-fix
  var d = sheet.getDataRange().getValues();
  var list = [];
  
  var settingsSheet = ss.getSheetByName('Settings');
  var previewPercent = 30; 
  if (settingsSheet) {
      var sData = settingsSheet.getDataRange().getValues();
      sData.forEach(r => { if(r[0] === 'Preview_Percent') previewPercent = parseInt(r[1]) || 30; });
  }
  for (var ii].length > 5) ? d[i][5] : "Ø¹Ø§Ù…";
    var desc = (d[i].length > 6) ? d[i][6] : "";
    if (filterClass && filterClass !== 'All' && cls !== filterClass) continue;
    if (filterSubject && filterSubject !== 'All' && subj !== filterSubject) continue;
    list.push({
      id: i + 1,
      title: title,
      type: type,
      cls: cls,
      subject: subj,
      date: new Date(date).toLocaleDateString(),
      previewPercent: previewPercent,
      desc: desc
    });
  }
  return {success: true, list: list.reverse()};
}

// ğŸ”¥ ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù„ØªØ¹Ù…Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
function getPublicFileDetails(rowId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
 = 1; i < d.length; i++) {
    var title = d[i][0];
    var type = d[i][1];
    // Ù„Ø§ Ù†Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§
    var cls = d[i][3];
    var date = d[i][4];
    var subj = (d[i].length > 5) ? d[i][5] : "Ø¹Ø§Ù…";
    var  var sheet = ss.getSheetByName('Library');
  if (!sheet) return {success: false, message: "Library Missing"};
  
  var rowIndex = parseInt(rowId);
  var lastRow = sheet.getLastRow();
  
  if (rowIndex < 2 || rowIndex > lastRow) return {success: false, message: "File not found"};
  
  var row = sheet.getRange(rowIndex, 1, 1, 8).getValues()[0];
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  var settingsSheet = ss.getSheetByName('Settings');
  var previewPercent = 30;
  if (settingsSheet) {
      var sData = settingsSheet.getDataRange().getValues();
      s desc = (d[i].length > 6) ? d[i][6] : "";
    if (filterClass && filterClass !== 'All' && cls !== filterClass) continue;
    if (filterSubject && filterSubject !== 'All' && subj !== filterSubject) continue;
    list.push({
      idData.forEach(r => { if(r[0] === 'Preview_Percent') previewPercent = parseInt(: i + 1,
      title: title,
      type: type,
      cls: cls,
      subject: subj,
      date: new Date(date).toLocaleDateString(),
      previewPercent: previewPercent,
      desc:r[1]) || 30; });
  }
  return {
    success: true,
 desc
    });
  }
  return {success: true, list: list.reverse()};
}

// ğŸ”¥ ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù„ØªØ¹Ù…Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
function getPublic    data: {
      id: rowId,
      title: row[0],
      type: row[1],
      link: row[2], // âœ… Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹
      cls:FileDetails(rowId) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('Library');
  if (!sheet) return {success: false, message: "Library Missing"};
  
  var rowIndex = parseInt(rowId);
  var lastRow = sheet.getLastRow(); row[3],
      date: new Date(row[4]).toLocaleDateString(),
      subject: row[5] || "Ø¹Ø§Ù…",
      desc: row[6] || "",
      previewPercent: previewPercent
    }
  };
}

function getLibraryContent(token) {
  var u = getUser(
  
  if (rowIndex < 2 || rowIndex > lastRow) return {success: false, message:token); 
  if(!u) return {success:false, message:"ØºÙŠØ± Ù…ØµØ±Ø­"};
  
  var sheet = Spreadsheet "File not found"};
  
  var row = sheet.getRange(rowIndex, 1, 1App.getActiveSpreadsheet().getSheetByName('Library');
  if(!sheet) return {success:true, library, 8).getValues()[0];
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  var settingsSheet: []}; 
  var d = sheet.getDataRange().getValues();
  var list = [];
 = ss.getSheetByName('Settings');
  var previewPercent = 30;
  if (settingsSheet  var studentClass = String(u.classLevel).trim();
  for(var i=1; i<d.length; i++) {
    var fileClass = String(d[i][3]).trim();
    if(fileClass === studentClass || fileClass === "Ø¹Ø§Ù…" || fileClass === "") {
       ) {
      var sData = settingsSheet.getDataRange().getValues();
      sData.forEach(r => { if(r[0] === 'Preview_Percent') previewPercent = parseInt(r[1])var subject = (d[i].length > 5) ? d[i][5] : "Ø¹Ø§Ù…"; || 30; });
  }
  return {
    success: true,
    data: {
      id: rowId,
      title: row[0],
      type: row[1],

       list.push({
         title: d[i][0], 
         type: d[i][1], 
         link: d[i][2], // Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ Ù…ØªØ§Ø­ Ù„Ù„Ø·Ø§Ù„Ø¨
         cls: d[i][3], 
         date: new Date(d[i][4]).toLocaleDateString(), 
         subject: subject
       });
    }
  }
  return {success:true, library: list.reverse()};
}

// ============================================================================
// ğŸ”’ 6      link: row[2], // âœ… Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹
      cls: row[3],
      date: new Date(row[4]).toLocaleDateString(),
      subject: row[5] || "Ø¹Ø§Ù…",
      desc: row[6] || "",
      previewPercent: previewPercent
    }
  };
}

function getLibraryContent(token) {
  var u = getUser(token); 
. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ (Validation)
// ============================================================================
function registerStudent(d) {
  try {
    // ğŸ›¡ï¸ Server-Side Validation
    if (!d.name || d.name.trim().split(/\s+/).length < 3) return {success:false, message  if(!u) return {success:false, message:"ØºÙŠØ± Ù…ØµØ±Ø­"};
  
  var sheet =:"ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"};
    if (!d.phone || !/^07 SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Library');
  if(!sheet) return {success:true, library: []}; 
  var d = sheet.getDataRange().getValues();
  var list = [];[789]\d{7}$/.test(String(d.phone).trim())) return {success:false, message:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­"};
    if (!d.email || !/^[^\s@
  var studentClass = String(u.classLevel).trim();
  for(var i=1; i<d.length; i++) {
    var fileClass = String(d[i][3]).trim]+@[^\s@]+\.[^\s@]+$/.test(d.email)) return {success:false, message:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±();
    if(fileClass === studentClass || fileClass === "Ø¹Ø§Ù…" || fileClass === "") {
ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­"};
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var codesSheet = ss.       var subject = (d[i].length > 5) ? d[i][5] : "Ø¹Ø§Ù…";
       list.push({
         title: d[i][0], 
         type: d[i][1], 
         link: d[i][2], // Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ Ù…ØªØ§Ø­ Ù„Ù„Ø·Ø§Ù„Ø¨
getSheetByName('Codes');
    if(!codesSheet) { setupDatabase(); codesSheet = ss.getSheetByName('         cls: d[i][3], 
         date: new Date(d[i][4]).toLocaleCodes'); }
    
    var codes = codesSheet.getDataRange().getValues();
    var idx =DateString(), 
         subject: subject
       });
    }
  }
  return {success: -1, cls = "Ø¹Ø§Ù…", duration = 120;
    for(var i=1;true, library: list.reverse()};
}

// ============================================================================
// ğŸ”’  i<codes.length; i++) {
      if(String(codes[i][0]).trim() ==6. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ (Validation)
// ============================================================================
function registerStudent String(d.code).trim() && String(codes[i][1]).toLowerCase() != "used") {(d) {
  try {
    // ğŸ›¡ï¸ Server-Side Validation
    if (!d. 
        idx=i+1; 
        cls=codes[i][4]; 
        durationname || d.name.trim().split(/\s+/).length < 3) return {success:false, = codes[i][5] ? parseInt(codes[i][5]) : 120; 
 message:"ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"};
    if (!d.phone || !/^07[789]\d{7}$/.test(String(d.phone).trim())) return {success        break; 
      }
    }
    if(idx == -1) return {success:false, message:"ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ø³ØªØ®Ø¯Ù…"};
    
    var stdSheet = ss.getSheet:false, message:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­"};
    if (!d.email || !/^[^\sByName('Students');
    if(!stdSheet) { setupDatabase(); stdSheet = ss.getSheetByName('Students@]+@[^\s@]+\.[^\s@]+$/.test(d.email)) return {success:false, message:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±'); }
    
    var stds = stdSheet.getDataRange().getValues();
    for(varÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­"};
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var codesSheet = ss. k=1; k<stds.length; k++) if(String(stds[k][0]).getSheetByName('Codes');
    if(!codesSheet) { setupDatabase(); codesSheet = ss.getSheetByName('toLowerCase() == String(d.email).trim().toLowerCase()) return {success:false, message:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹"};
    
    var expiryDate = new Date();
    expiryDate.setDateCodes'); }
    
    var codes = codesSheet.getDataRange().getValues();
    var idx = -1, cls = "Ø¹Ø§Ù…", duration = 120;
    for(var i=1;(expiryDate.getDate() + duration);
    stdSheet.appendRow([
        d.email.toLowerCase i<codes.length; i++) {
      if(String(codes[i][0]).trim() ==(), 
        d.password, 
        d.name, 
        "'"+d.phone, String(d.code).trim() && String(codes[i][1]).toLowerCase() != "used") { 
        cls, 
        d.photoData||"", 
        new Date(), 
        ' 
        idx=i+1; 
        cls=codes[i][4]; 
        durationActive', 
        expiryDate, 
        d.deviceId||""
    ]);
    
    codes = codes[i][5] ? parseInt(codes[i][5]) : 120; 
Sheet.getRange(idx, 2).setValue("Used");
    codesSheet.getRange(idx,        break; 
      }
    }
    if(idx == -1) return {success:false 3).setValue(d.email);
    codesSheet.getRange(idx, 4).setValue(, message:"ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ø³ØªØ®Ø¯Ù…"};
    
    var stdSheet = ss.getSheetnew Date());
    
    clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´

    return {success:trueByName('Students');
    if(!stdSheet) { setupDatabase(); stdSheet = ss.getSheetByName('Students, token:Utilities.base64Encode(d.email.toLowerCase()), name:d.name, classLevel:cls, photo:d.photoData||""};
  } catch(e) { return {success:'); }
    
    var stds = stdSheet.getDataRange().getValues();
    for(varfalse, message:e.toString()}; }
}

// ============================================================================
// ğŸ›  k=1; k<stds.length; k++) if(String(stds[k][0]).toLowerCase() == String(d.email).trim().toLowerCase()) return {success:false, message:"Ø§Ù„Ø¨Ø±ÙŠØ¯ï¸ 7. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¢Ù„ÙŠ (Auto-Setup & Repair System)
// ================================================================= Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹"};
    
    var expiryDate = new Date();
    expiryDate.setDate===========
function setupDatabase() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  // Ù‡ÙŠÙƒÙ„ÙŠØ©(expiryDate.getDate() + duration);
    stdSheet.appendRow([
        d.email.toLowerCase Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
  var schema = {
    'Students': ['Email','Password','Name','Phone','(), 
        d.password, 
        d.name, 
        "'"+d.phone,Class','Photo', 'LastLogin', 'Status', 'ExpiryDate', 'DeviceID'], 
    'Codes 
        cls, 
        d.photoData||"", 
        new Date(), 
        '': ['Code','Status','UserEmail','Date','Class', 'Duration'],
    'Exams': ['TitleActive', 
        expiryDate, 
        d.deviceId||""
    ]);
    
    codes','Class','Duration','Desc','Link','QR', 'Status', 'Subject'],
    'Questions': ['ExamSheet.getRange(idx, 2).setValue("Used");
    codesSheet.getRange(idx,Name','Question','Opt1','Opt2','Opt3','Opt4','Correct','Image'],
    'Results 3).setValue(d.email);
    codesSheet.getRange(idx, 4).setValue(': ['Date','Email','Exam','Score','Total','Percent','CheatingAttempts'],
    'Library': ['Title', 'Type', 'Link', 'Class', 'Date', 'Subject', 'Description'], 
    'new Date());
    
    clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´

    return {success:true, token:Utilities.base64Encode(d.email.toLowerCase()), name:d.name, classLevelAssignments': ['Date', 'StudentEmail', 'StudentName', 'Type', 'Description', 'FileLink', ':cls, photo:d.photoData||""};
  } catch(e) { return {success:Grade', 'TeacherNote'],
    'Complaints': ['Date', 'StudentEmail', 'StudentName', 'false, message:e.toString()}; }
}

// ============================================================================
// ğŸ› Message', 'Status', 'AdminReply'],
    'Notes': ['Email', 'NoteText', 'LastUpdatedï¸ 7. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¢Ù„ÙŠ (Auto-Setup & Repair System)
// ================================================================='],
    'Settings': ['Key', 'Value'],
    'Notifications': ['Date', 'TargetClass',===========
function setupDatabase() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  // Ù‡ÙŠÙƒÙ„ÙŠØ© 'Message'],
    // Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù†ÙØµÙ„Ø©
    'Q_12': [' Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
  var schema = {
    'Students': ['Email','Password','Name','Phone','ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_11': ['ExamID', 'Question', 'Opt1', 'Class','Photo', 'LastLogin', 'Status', 'ExpiryDate', 'DeviceID'], 
    'CodesOpt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_10': ['Code','Status','UserEmail','Date','Class', 'Duration'],
    'Exams': ['Title','Class','Duration','Desc','Link','QR', 'Status', 'Subject'],
    'Questions': ['Exam': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4',Name','Question','Opt1','Opt2','Opt3','Opt4','Correct','Image'],
    'Results 'Correct', 'Image'],
    'Q_9': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_8': ['Date','Email','Exam','Score','Total','Percent','CheatingAttempts'],
    'Library': ['': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4',Title', 'Type', 'Link', 'Class', 'Date', 'Subject', 'Description'], 
    ' 'Correct', 'Image'],
    'Q_7': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_6': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_5': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_4Assignments': ['Date', 'StudentEmail', 'StudentName', 'Type', 'Description', 'FileLink', '': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4',Grade', 'TeacherNote'],
    'Complaints': ['Date', 'StudentEmail', 'StudentName', 'Message', 'Status', 'AdminReply'],
    'Notes': ['Email', 'NoteText', 'LastUpdated 'Correct', 'Image'],
    'Q_3': ['ExamID', 'Question', 'Opt1','],
    'Settings': ['Key', 'Value'],
    'Notifications': ['Date', 'TargetClass', 'Message'],
    // Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù†ÙØµÙ„Ø©
    'Q_12': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_11': ['ExamID', 'Question', 'Opt1', ' 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image']
  };
  varOpt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_10 log = [];
  for (var t in schema) {
    var sh = ss.getSheetByName(t': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4',);
    if (!sh) { 
        sh = ss.insertSheet(t); 
        sh 'Correct', 'Image'],
    'Q_9': ['ExamID', 'Question', 'Opt1',.appendRow(schema[t]); 
        log.push("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡: " + t); 
 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_8        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        if(t === 'Settings') {
             sh.': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4',appendRow(['TeacherName', 'Ø£. Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…']);
             sh.appendRow(['News_Enabled', ' 'Correct', 'Image'],
    'Q_7': ['ExamID', 'Question', 'Opt1',On']);
             sh.appendRow(['WhatsApp_Link', 'https://wa.me/']);
             sh 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_6.appendRow(['Preview_Percent', '30']);
        }
    } else {
        // Ø¥Øµ': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_5': ['ExamID', 'Question', 'Opt1',Ù„Ø§Ø­ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù†Ø§Ù‚ØµØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        var lastCol = sh.getLastColumn();
        if( 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image'],
    'Q_4': ['ExamID', 'Question', 'Opt1', 'Opt2', 'Opt3', 'Opt4',lastCol < schema[t].length) {
             var missingCols = schema[t].slice(lastCol 'Correct', 'Image'],
    'Q_3': ['ExamID', 'Question', 'Opt1',);
             sh.getRange(1, lastCol+1, 1, missingCols.length).setValues([missingCols]);
             log.push("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù…Ø¯Ø©: " + t);
        } 'Opt2', 'Opt3', 'Opt4', 'Correct', 'Image']
  };
  var log = [];
  for (var t in schema) {
    var sh = ss.getSheetByName(t
    }
  }
  return "ØªÙ…Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­.\n" + (log.length ? log.join("\n") : "Ø§Ù„Ù†Ø¸Ø§Ù… Ø³Ù„ÙŠÙ… ÙˆÙ…Ø­Ø¯Ø« Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.");
}

// ---);
    if (!sh) { 
        sh = ss.insertSheet(t); 
        sh Helper Functions ---
function cleanDatabase(tables) { return {success:true, message:"ØªÙ…"}; }
function.appendRow(schema[t]); 
        log.push("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡: " + t); 
 resetSpecificTables(t) { return {success:true}; }
function getSystemLogs() { return []; }        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        if(t === 'Settings') {
             sh.
function getFinancialReport() { return {}; }
function getExamsForAdminControl() { return []; }
appendRow(['TeacherName', 'Ø£. Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…']);
             sh.appendRow(['News_Enabled', 'function toggleExamVisibility() { return "OK"; }
function getGlobalLeaderboard() { return []; }
functionOn']);
             sh.appendRow(['WhatsApp_Link', 'https://wa.me/']);
             sh getUser(t) { 
    try{ 
        var e=Utilities.newBlob(Utilities.base64Decode(t)).getDataAsString(); 
        var d=SpreadsheetApp.getActiveSpreadsheet().getSheet.appendRow(['Preview_Percent', '30']);
        }
    } else {
        // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù†Ø§Ù‚ØµØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        var lastCol = sh.getLastColumn();
        if(ByName('Students').getDataRange().getValues(); 
        for(var i=1;i<d.length;i++) 
            if(d[i][0]==e) return {email:e, classLevel:d[i][4], photo:d[i][5], name:d[i][2]lastCol < schema[t].length) {
             var missingCols = schema[t].slice(lastCol);
             sh.getRange(1, lastCol+1, 1, missingCols.length).setValues([missingCols]);
             log.push("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù…Ø¯Ø©: " + t);
        }}; 
    }catch(e){} 
    return null; 
}
function shuffleArray(array) {
  for (var i = array.length - 1; i > 0; i--) {
    }
  }
  return "ØªÙ…Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­.\n" + (log.length ? log.join("\n") : "Ø§Ù„Ù†Ø¸Ø§Ù… Ø³Ù„ÙŠÙ… ÙˆÙ…Ø­Ø¯Ø« Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.");
}

// --- Helper Functions ---
function cleanDatabase
    var j = Math.floor(Math.random() * (i + 1));
    var temp = array[i];
    array[i] = array[j];
    array[j] = temp(tables) { return {success:true, message:"ØªÙ…"}; }
function resetSpecificTables(t) { return {success:true}; }
function getSystemLogs() { return []; }
function getFinancialReport() {;
  }
}

// --- Menu Functions ---
function onOpen() {
  SpreadsheetApp. return {}; }
function getExamsForAdminControl() { return []; }
function toggleExamVisibility() { returngetUi().createMenu('âš¡ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Pro')
      .addItem('ğŸ›ï¸ ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', 'openAdminDashboard')
      .addSeparator()
      .addItem('ğŸ“‚ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨ "OK"; }
function getGlobalLeaderboard() { return []; }
function getUser(t) { 
Ø§Ø±ÙƒÙˆØ¯', 'showArchivingOptions')
      .addItem('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§Ø¨Ø·', 'updateExam    try{ 
        var e=Utilities.newBlob(Utilities.base64Decode(t)).getDataLinks')
      .addItem('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„', 'runSetupFromMenu')
AsString(); 
        var d=SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students').getDataRange().      .addToUi();
}
function openAdminDashboard() {
  var html;
  try {
getValues(); 
        for(var i=1;i<d.length;i++) 
            if(d[i][0]==e) return {email:e, classLevel:d[i][4    html = HtmlService.createHtmlOutputFromFile('AdminDashboard').setWidth(1200).setHeight(800);
  } catch(e) {
      SpreadsheetApp.getUi().alert("Ø®Ø·], photo:d[i][5], name:d[i][2]}; 
    }catch(Ø£: Ù…Ù„Ù HTML ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
      return;
  }
  SpreadsheetApp.getUi().showModalDialog(html, 'Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©');
}
function runSetupFromMenu() {
  var msg = setupDatabase();
  SpreadsheetApp.getUi().alert(msg);
}e){} 
    return null; 
}
function shuffleArray(array) {
  for (var i = array.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var temp = array[i];
    array[i] = array[j];
    array[j] = temp;
  }
}


function updateExamLinks() {
  if (!WEB_APP_URL || WEB_APP_URL.length < 5) { SpreadsheetApp.getUi().alert("âš ï¸ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø´Ø± Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯!"); return; }
  var s// --- Menu Functions ---
function onOpen() {
  SpreadsheetApp.getUi().createMenu('âš¡ = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Exams');
  var d = s.getDataRange(). Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Pro')
      .addItem('ğŸ›ï¸ ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', 'openAdminDashboardgetValues();
  var up = [];
  var baseUrl = WEB_APP_URL;
  if (')
      .addSeparator()
      .addItem('ğŸ“‚ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯', 'showArchivingbaseUrl.slice(-1) != "/") baseUrl += "/";
  for (var i=1; i<d.length; i++) {
    if (d[i][0]) {
      var l = baseUrl + "?exam=" + encodeURIComponent(d[i][0]);
      up.push([l, '=IMAGE("Options')
      .addItem('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§Ø¨Ø·', 'updateExamLinks')
      .addItem('https://api.qrserver.com/v1/create-qr-code/?size=150xğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„', 'runSetupFromMenu')
      .addToUi();
}
function openAdminDashboard() {
  var html;
  try {
    html = HtmlService.createHtmlOutputFromFile('AdminDashboard').setWidth(1200).setHeight(800);
  } catch(e) {
      SpreadsheetApp.getUi().alert("Ø®Ø·Ø£: Ù…Ù„Ù HTML ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");150&data='+encodeURIComponent(l)+'")']);
    } else {
      up.push(["
      return;
  }
  SpreadsheetApp.getUi().showModalDialog(html, 'Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©');
}
function runSetupFromMenu() {
  var msg = setup",""]);
    }
  }
  if(up.length > 0) s.getRange(2, 5, up.length, 2).setValues(up);
  SpreadsheetApp.getUi().alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
}
function showArchivingOptions() {
  var htmlOutput = HtmlService.createHtmlOutput(
    '<div style="fontDatabase();
  SpreadsheetApp.getUi().alert(msg);
}
function updateExamLinks() {
  if (!WEB_APP_URL || WEB_APP_URL.length < 5) { SpreadsheetApp.getUi().alert("âš ï¸ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø´Ø± Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯!"); return; }
  var s-family:sans-serif; text-align:center; padding:20px;">' +
    '<h3>ÙƒÙŠÙ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ØŸ</h3>' +
    '<button onclick="google.script.run.withSuccessHandler(closeMe).performArchiving(\'organized\');" style="padding:12px 2 = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Exams');
  var d = s.getDataRange().0px; background:#4361ee; color:white; border:none; border-radius:5getValues();
  var up = [];
  var baseUrl = WEB_APP_URL;
  if (baseUrl.slice(-1) != "/") baseUrl += "/";
  for (var i=1; i<dpx; cursor:pointer; margin:10px; width:100%; font-size:16.length; i++) {
    if (d[i][0]) {
      var l = baseUrl + "?exam=" + encodeURIComponent(d[i][0]);
      up.push([l, '=IMAGE("px;">ğŸ“‚ Ù…Ù†Ø¸Ù… (Ù…Ø¬Ù„Ø¯Ø§Øª Ù„Ù„ØµÙÙˆÙ)</button><br>' +
    '<script>function closeMe(){ google.script.host.close(); }</script>' +
    '</div>'
  ).setWidth(3https://api.qrserver.com/v1/create-qr-code/?size=150x150&data='+encodeURIComponent(l)+'")']);
    } else {
      up.push(["50).setHeight(300);
  SpreadsheetApp.getUi().showModalDialog(html",""]);
    }
  }
  if(up.length > 0) s.getRange(Output, 'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ø°ÙƒÙŠØ©');
}
function performArchiving(mode) {
  2, 5, up.length, 2).setValues(up);
  SpreadsheetApp.getvar sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Exams');
  var data = sheet.getDataUi().alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
}
function showArchRange().getValues();
  var rootName = "QR_Archive_" + Utilities.formatDate(new DateivingOptions() {
  var htmlOutput = HtmlService.createHtmlOutput(
    '<div style="font(), "GMT+3", "yyyy-MM-dd_HHmm");
  var rootFolder = DriveApp-family:sans-serif; text-align:center; padding:20px;">' +
    '.createFolder(rootName);
  var count=0;
  for (var i=1; i<h3>ÙƒÙŠÙ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ØŸ</h3>' +
    '<button onclick="google.script.run.with<data.length; i++) {
    if (data[i][0]) {
      var cls =SuccessHandler(closeMe).performArchiving(\'organized\');" style="padding:12px 2 data[i][1] || "Uncategorized";
      var subj = data[i][7] ||0px; background:#4361ee; color:white; border:none; border-radius:5 "General";
      var examName = data[i][0];
      var link = WEB_APP_px; cursor:pointer; margin:10px; width:100%; font-size:16URL + "?exam=" + encodeURIComponent(examName);
      var qrUrl = "https://api.qrpx;">ğŸ“‚ Ù…Ù†Ø¸Ù… (Ù…Ø¬Ù„Ø¯Ø§Øª Ù„Ù„ØµÙÙˆÙ)</button><br>' +
    '<script>function closeMeserver.com/v1/create-qr-code/?size=500x500&data(){ google.script.host.close(); }</script>' +
    '</div>'
  ).setWidth(3=" + encodeURIComponent(link);
      var targetFolder = rootFolder;
      if (mode === 'organized50).setHeight(300);
  SpreadsheetApp.getUi().showModalDialog(html') {
          var classFolders = rootFolder.getFoldersByName(cls);
          var classFolder = classOutput, 'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ø°ÙƒÙŠØ©');
}
function performArchiving(mode) {
  Folders.hasNext() ? classFolders.next() : rootFolder.createFolder(cls);
          var subjFoldersvar sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Exams');
  var data = sheet.getData = classFolder.getFoldersByName(subj);
          var targetFolder = subjFolders.hasNext() ? subjFolders.next() : classFolder.createFolder(subj);
      }
      try { 
          var imageBlob = UrlFetchApp.fetch(qrUrl).getBlob().setName(examName + ".png");
          Range().getValues();
  var rootName = "QR_Archive_" + Utilities.formatDate(new Date(), "GMT+3", "yyyy-MM-dd_HHmm");
  var rootFolder = DriveApptargetFolder.createFile(imageBlob);
          count++; 
      } catch (e) {}
    .createFolder(rootName);
  var count=0;
  for (var i=1; i<data.length; i++) {
    if (data[i][0]) {
      var cls =}
  }
  SpreadsheetApp.getUi().alert("âœ… ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ© Ø¨Ù†Ø¬Ø§Ø­!\ data[i][1] || "Uncategorized";
      var subj = data[i][7] ||nØ¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: " + count);
}

// ----------------------------------------------------
// [Functions] Admin & User Actions
// ----------------------------------------------------

// ğŸš€ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Caching)
function getAdminData_V2() {
  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Cache)
  var cache = CacheService.getScriptCache();
  var cachedData = cache.get("ADMIN_DASHBOARD_DATA");

  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ Ø£Ø¹Ø¯Ù‡Ø§ ÙÙˆØ±Ø§Ù‹ (Ø³Ø±Ø¹Ø© "General";
      var examName = data[i][0];
      var link = WEB_APP_URL + "?exam=" + encodeURIComponent(examName);
      var qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=" + encodeURIComponent(link);
      var targetFolder = rootFolder;
      if (mode === 'organized') {
          var classFolders Ù‚ØµÙˆÙ‰)
  if (cachedData != null) {
    return JSON.parse(cachedData);
 = rootFolder.getFoldersByName(cls);
          var classFolder = classFolders.hasNext() ? classFolders  }

  // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ù‚Ù… Ø¨Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  var data = get.next() : rootFolder.createFolder(cls);
          var subjFolders = classFolder.getFoldersByName(subj);
          var targetFolder = subjFolders.hasNext() ? subjFolders.next() : classFolder.createFolder(subj);
      }
      try { 
          var imageBlob = UrlFetchApp.fetchAdminData_Internal_Optimized();
  
  // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù„Ø§ ØªØªØºÙŠØ± ÙƒØ«ÙŠØ±Ø§Ù‹ Ù„Ø°Ø§ ÙŠÙ…ÙƒÙ† Ø¯Ù…Ø¬Ù‡Ø§ Ù‡Ù†Ø§)
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var settingsSheet(qrUrl).getBlob().setName(examName + ".png");
          targetFolder.createFile(image = ss.getSheetByName('Settings');
  var socials = { facebook: '', instagram: '', whatsapp: '', youtubeBlob);
          count++; 
      } catch (e) {}
    }
  }
  SpreadsheetApp.getUi().alert("âœ… ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ© Ø¨Ù†Ø¬Ø§Ø­!\nØ¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: " + count);
}

// ----------------------------------------------------
// [Functions] Admin & User Actions
// ----------------: '' };
  var fullSettings = {};
  
  if(settingsSheet) {
      var sRaw = settingsSheet.getDataRange().getValues();
      sRaw.forEach(r => {
         fullSettings[r[0]] = r[1];
         if(r[0]=='Facebook') socials.facebook------------------------------------

// ğŸš€ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Caching)
function getAdminData_V2() {
 = r[1];
         if(r[0]=='Instagram') socials.instagram = r[1];
         if(r[0]=='WhatsApp_Link') socials.whatsapp = r[1]; 
         if(r[0]=='Youtube') socials.youtube = r[1];
      });
  }
  
  data.socials = socials;
  data.settings = fullSettings; 

  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚ (600 Ø«Ø§Ù†ÙŠØ©)
  try {
    cache.put("ADMIN_DASHBOARD_DATA", JSON.stringify(data), 600);
  } catch(e) {
    Logger.log("Data too large for cache");
  }
  
  return data;  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Cache)
  var cache = CacheService.getScriptCache();
  var cachedData = cache.get("ADMIN_DASHBOARD_DATA");

  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ Ø£Ø¹Ø¯Ù‡Ø§ ÙÙˆØ±Ø§Ù‹ (Ø³Ø±Ø¹Ø© Ù‚ØµÙˆÙ‰)
  if (cachedData != null) {
    return JSON.parse(cachedData);
  }

  // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ù‚Ù… Ø¨Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  var data = getAdminData_Internal_Optimized();
  
  // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù„Ø§ ØªØªØºÙŠØ± ÙƒØ«ÙŠØ±Ø§Ù‹ Ù„Ø°Ø§ ÙŠÙ…ÙƒÙ† Ø¯Ù…Ø¬Ù‡Ø§ Ù‡Ù†Ø§)
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var settingsSheet = ss.getSheetByName('Settings');
  var socials = { facebook: '', instagram: '', whatsapp: '', youtube: '' };
  var fullSettings = {};
  
  if(settingsSheet) {
      var sRaw = settingsSheet.getDataRange().getValues();
      sRaw.forEach(r => {
         fullSettings[r[0]] = r[1];
         if(r[0]=='Facebook') socials.facebook = r[1];
         
}

// Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
function getAdminData_Internal_Optimized() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var codes = [];
  
  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
  var cSheet = ss.getSheetByName('Codes');
  if (cSheet) {
    var cData = cSheet.getDataRange().getValues();
    if(r[0]=='Instagram') socials.instagram = r[1];
         if(r[0]=='// Ù†Ø¨Ø¯Ø£ Ù…Ù† 1 Ù„ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    for(var i=1; i<cData.WhatsApp_Link') socials.whatsapp = r[1]; 
         if(r[0]=='Youtube') socialslength; i++) {
      if(cData[i][0]) codes.push({
        code:.youtube = r[1];
      });
  }
  
  data.socials = socials; cData[i][0], 
        status: cData[i][1], 
        email:
  data.settings = fullSettings; 

  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚ ( cData[i][2], 
        cls: cData[i][4]||"Ø¹Ø§Ù…", 600 Ø«Ø§Ù†ÙŠØ©)
  try {
    cache.put("ADMIN_DASHBOARD_DATA",
        days: cData[i][5] || 120
      });
    }
   JSON.stringify(data), 600);
  } catch(e) {
    Logger.log}
  
  // ØªØ­Ø³ÙŠÙ†: Ø§Ø³ØªØ®Ø¯Ø§Ù… getLastRow Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø¯Ø¯
  var sCount = 0, eCount = 0;
  var stdSheet = ss.getSheetByName('Students');
  var examSheet = ss.getSheetByName('Exams');
  
  if(stdSheet) sCount = Math.max(0, stdSheet.getLastRow() - 1);
  if(examSheet) eCount = Math.max(0, examSheet.getLastRow() - 1);
  
  return {
    codes: codes, 
    stats: { 
      students: sCount, 
      exams: eCount, 
      codes: codes.length 
    }
  };
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ ØªØºÙŠÙŠØ±Ø§Øª
function clearAdminCache() {
  CacheService.getScriptCache().remove("ADMIN_DASHBOARD_DATA");
}

function generateNewCodes(count, cls, days) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Codes');
  if(!sheet) { setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Codes'); }
  var newCodes = [];
  var d = days ? parseInt(days) : 120;
  for(var i=0; i<count; i++) {
    var code = Math("Data too large for cache");
  }
  
  return data;
}

// Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
function getAdminData_Internal_Optimized() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var codes = [];
  
  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
  var cSheet = ss.getSheetByName('Codes');
  if (cSheet) {
    var cData = cSheet.getDataRange().getValues();
    // Ù†Ø¨Ø¯Ø£ Ù…Ù† 1 Ù„ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    for(var i=1; i<cData.length; i++) {
      if(cData[i][0]) codes.push({
        code: cData[i][0], 
        status: cData[i][1], 
        email: cData[i][2], 
        cls: cData[i][4]||"Ø¹Ø§Ù…", 
        days: cData[i][5] || 120
      });
    }
  }
  
  // ØªØ­Ø³ÙŠÙ†.floor(10000 + Math.random() * 90000);
    newCodes.push([code, 'New', '', '', cls, d]); 
  }
  sheet.getRange(sheet.getLastRow()+1, 1, newCodes.length, 6).setValues(new: Ø§Ø³ØªØ®Ø¯Ø§Ù… getLastRow Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø¯Ø¯
  var sCount = 0, eCountCodes);
  clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
  return "ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­";
}

function getStudentsForCards() {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students');
    if(!sheet) return [];
    var d = sheet. = 0;
  var stdSheet = ss.getSheetByName('Students');
  var examSheet = ssgetDataRange().getValues();
    var list = [];
    if (d.length <= 1) return.getSheetByName('Exams');
  
  if(stdSheet) sCount = Math.max(0, stdSheet.getLastRow() - 1);
  if(examSheet) eCount = Math.max [];
    for(var i=1; i<d.length; i++) {
      var ph =(0, examSheet.getLastRow() - 1);
  
  return {
    codes: codes, 
    stats: { 
      students: sCount, 
      exams: eCount, 
      codes: codes.length 
    }
  };
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ ØªØºÙŠÙŠØ±Ø§Øª
function clearAdminCache() {
  CacheService.getScriptCache().remove("ADMIN_DASHBOARD_DATA");
}

function generateNewCodes(count, cls, days) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Codes');
  if(!sheet) { setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Codes'); }
  var newCodes = (d[i][5] && d[i][5].length > 10) ? d[i][5] : "";
      var status = d[i][7] || 'Active';
      list.push({name:d[i][2] + (status=='Deleted'?' (Ù…Ø­Ø°ÙˆÙ)':''), cls:d[i][4], photo:ph, email:d[i][0], row: i+1});
    }
    return list;
  } catch(e) { return []; }
}

 [];
  var d = days ? parseInt(days) : 120;
  for(var i=0; i<count; i++) {
    var code = Math.floor(10000 + Math.random() * 90000);
    newCodes.push([code, 'New', '', '', cls, d]); 
  }
  sheet.getRange(sheet.getLastRow()+1, 1, newCodes.length, 6).setValues(newCodes);
  clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
  return "ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­";
}

function getStudentsForCards() {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students');
    if(!sheet) return [];
    var d = sheet.getDataRange().getValues();
    var list = [];
    if (d.length <= 1) return [];
    for(var i=1; i<d.length; i++) {
      var ph = (d[i][5] && d[i][5].length > 10) ? d[i][5] : "";
      var status = d[i][7] || 'Active';
      list.push({name:d[i][2] + (status=='Deleted'?' (Ù…Ø­Ø°ÙˆÙ)':''), cls:d[i][4], photo:ph, email:d[i][0], row: i+1});
    }
    returnfunction getAllResultsForAdmin() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var resSheet = ss.getSheetByName('Results');
  if (!resSheet) return [];
  var resData = resSheet.getDataRange().getValues();
  var stdData = [];
  var stdSheet = ss.getSheetByName('Students');
  if(stdSheet) stdData = stdSheet.getDataRange().getValues();
  
  var stdMap = {};
  for(var k=1; k<stdData.length; k++) stdMap[stdData[k][0]] = {name: stdData[k][2], cls: stdData[k][4]}; 
  var list = [];
  for(var i=1; i<resData.length; i++) {
    var email = resData[i][1];
    var studentInfo = stdMap[email] || {name: email, cls: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'};
 list;
  } catch(e) { return []; }
}

function getAllResultsForAdmin() {
    list.push({rowId: i+1, date: new Date(resData[i][0]).  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var resSheet = ss.getSheetByName('Results');
  if (!resSheet) return [];
  var resData = resSheet.getDataRange().getValues();
  var stdData = [];
  var stdSheet = ss.getSheetByName('Students');
  if(stdSheet) stdData = stdSheet.getDataRange().getValues();
  
  var stdMap = {};
  for(var k=1; k<stdData.length; k++) stdMap[stdData[k][0]] = {name: stdData[k][2], cls: stdData[k][4]}; 
  var list = [];
  for(var i=1; i<resData.length; i++) {
    var email = resData[i][1];
    var studentInfo = stdMap[toLocaleDateString(), name: studentInfo.name, cls: studentInfo.cls, exam: resData[i][2], score: resData[i][5], cheats: resData[i][6]});
  }
  return list.reverse();
}

function getLibraryForAdmin() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Library');
  if(!sheet) return [];
  var d = sheet.getDataRange().getValues();
  var list = [];
  for(var i=1; i<d.length; i++) { 
    var subject = (d[i].length > 5) ? d[i][5] : "";
    var desc = (d[i].length > 6)email] || {name: email, cls: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'};
    list.push({rowId: ? d[i][6] : "";
    list.push({rowId:i+1, title:d[i][0], type:d[i][1], link:d[i][2], cls: i+1, date: new Date(resData[i][0]).toLocaleDateString(), name: studentInfod[i][3], subject: subject, desc: desc}); 
  }
  return list;
.name, cls: studentInfo.cls, exam: resData[i][2], score: resData[}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Google Drive ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function saveToDrive(base64i][5], cheats: resData[i][6]});
  }
  return list.reverse();Data, fileName) {
  try {
    var splitBase = base64Data.split('base6
}

function getLibraryForAdmin() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Library');
  if(!sheet) return [];
  var d = sheet.getDataRange().getValues();4,');
    var type = splitBase[0].split(':')[1].split(';')[0];
    var bytes = Utilities.base
  var list = [];
  for(var i=1; i<d.length; i++) {64Decode(splitBase[1]);
    var blob = Utilities.newBlob(bytes, type, fileName 
    var subject = (d[i].length > 5) ? d[i][5] :);
    
    var folderName = "Nebras_Uploads";
    var folders = DriveApp.getFoldersByName(folderName);
    var folder;
    if (folders.hasNext()) {
      folder "";
    var desc = (d[i].length > 6) ? d[i][6] : "";
    list.push({rowId:i+1, title:d[i][0], type: = folders.next();
    } else {
      folder = DriveApp.createFolder(folderName);
    }
    
    var file = folder.createFile(blob);
    file.setSharing(Drived[i][1], link:d[i][2], cls:d[i][3], subject:App.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return file.getUrl subject, desc: desc}); 
  }
  return list;
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù();
  } catch(e) {
    return "Error uploading: " + e.toString();
  Ø§Øª Ø¥Ù„Ù‰ Google Drive ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function saveToDrive(base64Data, fileName) {
  try {
    var splitBase = base64Data.split('base64,');
    var type =}
}

function addToLibrary(data) {
  try {
    var link = data.link; splitBase[0].split(':')[1].split(';')[0];
    var bytes = Utilities.base6
    // Check if it's base64 (upload to Drive)
    if (link && link.indexOf("base64,") > -1) {
       link = saveToDrive(link, data.4Decode(splitBase[1]);
    var blob = Utilities.newBlob(bytes, type, fileName);
    
    var folderName = "Nebras_Uploads";
    var folders = DriveApp.gettitle); // Helper function
    }

    var s = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('LibraryFoldersByName(folderName);
    var folder;
    if (folders.hasNext()) {
      folder =');
    if(!s) { setupDatabase(); s = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Library'); }
    s.appendRow([data.title, data.type, link, data.cls, new Date(), data.subject, data.desc || ""]);
    
    clearAdminCache(); 
    return "ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
 folders.next();
    } else {
      folder = DriveApp.createFolder(folderName);
      } catch(e) { return "Ø®Ø·Ø£: " + e; }
}

function deleteLibraryItem}
    
    var file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return file.getUrl();
  } catch(e) {
    return "Error uploading: " + e.toString();
  }
}

function addToLibrary(data) {
  try {
    var link = data.link;
    // Check if it's base64 (upload to Drive)
    if (link && link.indexOf("base64,") > -1) {
       link = saveToDrive(link, data.title); // Helper function
    }

    var s = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Library');
    if(!s) { setupDatabase(); s = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Library');(rowId) {
  SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Library').deleteRow(rowId);
  return "ØªÙ… Ø§Ù„Ø­Ø°Ù";
}

function getAssignmentsForAdmin() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Assignments');
  if(!sheet) return [];
  var d = sheet.getDataRange().getValues();
  var list = [];
  for(var i=1; i<d.length; i++) {
    list.push({rowId:i+1, date:new Date(d[i][0]).toLocaleDateString(), name:d[i][2], type:d[i][3], desc:d[i][4], link:d[i][5], grade:d[i][6]});
  }
  return list.reverse();
}

function gradeAssignment(rowId, grade) {
  SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Assignments').getRange(rowId, 7).setValue(grade);
  return "ØªÙ… Ø§Ù„Ø±ØµØ¯";
}

function getCompl }
    s.appendRow([data.title, data.type, link, data.cls, new Date(), data.subject, data.desc || ""]);
    
    clearAdminCache(); 
    return "ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
  } catch(e) { return "Ø®Ø·Ø£: " + e; }
}

function deleteLibraryItem(rowId) {
  SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Library').deleteRow(rowId);
  return "ØªÙ… Ø§Ù„Ø­Ø°Ù";
}

function getAssignmentsForAdmin() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Assignments');
  if(!sheet)aintsForAdmin() {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Complaints');
    if(!sheet) return [];
    var d = sheet.getDataRange().getValues(); return [];
  var d = sheet.getDataRange().getValues();
  var list = [];
  for
    var list = [];
    if (d.length <= 1) return []; 
    for((var i=1; i<d.length; i++) {
    list.push({rowId:i+1, date:new Date(d[i][0]).toLocaleDateString(), name:d[i][2], type:d[i][3], desc:d[i][4], link:d[i][5], grade:d[i][6]});
  }
  return list.reverse();
}

function gradeAssignment(rowId, grade) {
  SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Assignments').getRange(rowId, 7).setValue(grade);
  return "ØªÙ… Ø§Ù„Ø±ØµØ¯";
var i=1; i<d.length; i++) {
      if(d[i][0]) list.push({rowId:i+1, date:new Date(d[i][0]).toLocaleDateString(), name:d[i][2], msg:d[i][3], email:d[i][1], reply:d[i][5] || ''});
    }
    return list.reverse();
  } catch(e) { return []; }
}

function replyToComplaint(rowId, reply) {}

function getComplaintsForAdmin() {
  try {
    var sheet = SpreadsheetApp.getActiveSpread
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Complaints');
   sheet.getRange(rowId, 6).setValue(reply); 
   sheet.getRange(rowId, 5sheet().getSheetByName('Complaints');
    if(!sheet) return [];
    var d = sheet.getDataRange().getValues();
    var list = [];
    if (d.length <= 1) return [];).setValue('Replied'); 
   return "ØªÙ… Ø§Ù„Ø±Ø¯";
}

function saveGeneralSettings(s 
    for(var i=1; i<d.length; i++) {
      if(d) {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Settings');
    if(!sheet) { setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Settings'); }
    var existing[i][0]) list.push({rowId:i+1, date:new Date(d[i][0]).toLocaleDateString(), name:d[i][2], msg:d[i][3], email = sheet.getDataRange().getValues();
    var map = new Map();
    existing.forEach((r:d[i][1], reply:d[i][5] || ''});
    }
    return, i) => { if(i>0) map.set(r[0], i+1); }); 
    for (var key in s) {
        if (map.has(key)) {
            sheet.getRange(map.get(key), 2).setValue(s[key]);
        } else {
            sheet.appendRow([key, s[key]]);
        }
    }
    clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
    return "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª";
}

function sendTargetedMessage(target, msg) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Notifications');
  if(!sheet list.reverse();
  } catch(e) { return []; }
}

function replyToComplaint(rowId, reply) {
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Complaints');
   sheet.getRange(rowId, 6).setValue(reply); 
   sheet.getRange(rowId, 5).setValue('Replied'); 
   return "ØªÙ… Ø§Ù„Ø±Ø¯";
}

function saveGeneralSettings(s) {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Settings');
    if(!sheet) { setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Settings');) { setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Notifications'); }
  sheet. }
    var existing = sheet.getDataRange().getValues();
    var map = new Map();
    existing.forEach((r, i) => { if(i>0) map.set(r[0], i+1); }); 
    for (var key in s) {
        if (map.has(appendRow([new Date(), target, msg]);
  return "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
}

function resetStudentDevice(email) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students');
  var d = sheet.getDataRange().getValues();
  for(var i=1; i<dkey)) {
            sheet.getRange(map.get(key), 2).setValue(s[key.length; i++) {
    if(d[i][0] == email) {
      sheet.]);
        } else {
            sheet.appendRow([key, s[key]]);
        }
    getRange(i+1, 10).setValue(""); 
      clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ«}
    clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
    return "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª";
}

function sendTargetedMessage(target, msg) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Notifications');
  if(!sheet) { setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet Ø§Ù„ÙƒØ§Ø´
      return {success:true, message: "ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²"};
    }
  }
  return {success:false, message: "Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"};
}

function delete().getSheetByName('Notifications'); }
  sheet.appendRow([new Date(), target, msg]);
  returnStudent(email) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students');
  var d = sheet.getDataRange().getValues();
  for(var i=1; i<d. "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
}

function resetStudentDevice(email) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students');
  var d = sheet.getDataRange().getValues();
length; i++) {
    if(d[i][0] == email) {
      sheet.delete  for(var i=1; i<d.length; i++) {
    if(d[iRow(i+1);
      clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
      return "ØªÙ… Ø§Ù„Ø­Ø°Ù";
    }
  }
  return "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
}

function adminResetPass(email][0] == email) {
      sheet.getRange(i+1, 10).setValue("");, newPass) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students');
   
      clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
      return {success:true, message: "var d = sheet.getDataRange().getValues();
  for(var i=1; i<d.ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²"};
    }
  }
  return {success:false, message:length; i++) {
    if(d[i][0] == email) {
      sheet.get "Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"};
}

function deleteStudent(email) {
  var sheet = SpreadsheetApp.Range(i+1, 2).setValue(newPass);
      return "ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";getActiveSpreadsheet().getSheetByName('Students');
  var d = sheet.getDataRange().getValues();
  
    }
  }
  return "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
}

function deleteUsedCodes() {
   for(var i=1; i<d.length; i++) {
    if(d[i][var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Codes');
   if(!sheet) return;
0] == email) {
      sheet.deleteRow(i+1);
      clearAdminCache(); //   var data = sheet.getDataRange().getValues();
   for (var i = data.length -  âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
      return "ØªÙ… Ø§Ù„Ø­Ø°Ù";
    }
  }
  return "ØºÙŠØ±1; i >= 1; i--) {
       if (data[i][1] === 'Used') Ù…ÙˆØ¬ÙˆØ¯";
}

function adminResetPass(email, newPass) {
  var sheet = SpreadsheetApp. sheet.deleteRow(i + 1);
   }
   clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒgetActiveSpreadsheet().getSheetByName('Students');
  var d = sheet.getDataRange().getValues();
  Ø§Ø´
   return "ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ";
}

function saveSocialLinks(links) { return {success:for(var i=1; i<d.length; i++) {
    if(d[i][true}; }

function createTrialAccount(d) {
  try {
    var ss = SpreadsheetApp.0] == email) {
      sheet.getRange(i+1, 2).setValue(newPassgetActiveSpreadsheet();
    var stdSheet = ss.getSheetByName('Students');
    if(!stdSheet));
      return "ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
    }
  }
  return "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; { setupDatabase(); stdSheet = ss.getSheetByName('Students'); }
    
    var stds = std
}

function deleteUsedCodes() {
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Sheet.getDataRange().getValues();
    for(var k=1; k<stds.length;Codes');
   if(!sheet) return;
   var data = sheet.getDataRange().getValues();
 k++) {
        if(String(stds[k][0]).toLowerCase() == String(d.email   for (var i = data.length - 1; i >= 1; i--) {
       if).trim().toLowerCase()) return {success:false, message:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹"};
 (data[i][1] === 'Used') sheet.deleteRow(i + 1);
   }    }
    var trialPass = Math.floor(1000 + Math.random() * 9
   clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
   return "ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ";
}

function000); 
    var expiryDate = new Date();
    expiryDate.setDate(expiryDate. saveSocialLinks(links) { return {success:true}; }

function createTrialAccount(d) {
getDate() + 1); 
    
    stdSheet.appendRow([
        d.email.toLowerCase  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var stdSheet = ss.getSheet(), 
        trialPass, 
        d.name, 
        "'"+d.phone, ByName('Students');
    if(!stdSheet) { setupDatabase(); stdSheet = ss.getSheetByName('Students'); }
    
    var stds = stdSheet.getDataRange().getValues();
    for(var
        d.classLevel, 
        "", 
        new Date(), 
        'Active',  k=1; k<stds.length; k++) {
        if(String(stds[k][0]).toLowerCase() == String(d.email).trim().toLowerCase()) return {success:false, message:"
        expiryDate, 
        d.deviceId || ""
    ]);
    
    clearAdminCache();Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹"};
    }
    var trialPass = Math.floor(1 // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
    
    return {
        success: true, 
        token: Utilities.base64Encode(d.email.toLowerCase()), 
        name: d.name, 
        000 + Math.random() * 9000); 
    var expiryDate = new DateclassLevel: d.classLevel, 
        photo: "", 
        isTrial: true, 
();
    expiryDate.setDate(expiryDate.getDate() + 1); 
    
    stdSheet        tempPass: trialPass
    };
  } catch(e) { return {success:false, message.appendRow([
        d.email.toLowerCase(), 
        trialPass, 
        d.name:e.toString()}; }
}

function loginUser(email, pass, deviceId) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students');
  if (!sheet) { setupDatabase, 
        "'"+d.phone, 
        d.classLevel, 
        "", 
        new Date(), 
        'Active', 
        expiryDate, 
        d.deviceId || ""(); return {success:false, message:"ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."}; }
  
  
    ]);
    
    clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
    
    return {
var d = sheet.getDataRange().getValues();
  var settingsSheet = SpreadsheetApp.getActiveSpreadsheet().        success: true, 
        token: Utilities.base64Encode(d.email.toLowerCase()), getSheetByName('Settings');
  var isMaint = false;
  var waLink = ""; 
  
        name: d.name, 
        classLevel: d.classLevel, 
        photo:if(settingsSheet) {
      var sett = settingsSheet.getDataRange().getValues();
      for( "", 
        isTrial: true, 
        tempPass: trialPass
    };
  } catchvar k=0; k<sett.length; k++) {
         if(sett[k][0]=='(e) { return {success:false, message:e.toString()}; }
}

function loginUserMaintenance' && sett[k][1]=='On') isMaint = true;
         if(sett[k(email, pass, deviceId) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('][0]=='WhatsApp_Link') waLink = sett[k][1];
      }
  }
  Students');
  if (!sheet) { setupDatabase(); return {success:false, message:"ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."}; }
  
  var d = sheet.getDataRange().getValues();
  if(isMaint && email !== 'admin') return {success:false, message:"âš ï¸ Ø§Ù„Ù…Ù†ØµØ© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹."};
  
  for(var i=1; i<d.length; ivar settingsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Settings');
  var isMaint = false++) {
    var rowEmail = String(d[i][0]).toLowerCase().trim();
    var rowPass = String(d[i][1]);
    if(rowEmail == String(email).toLowerCase().trim;
  var waLink = ""; 
  if(settingsSheet) {
      var sett = settingsSheet() && rowPass == String(pass)) {
      var status = d[i][7]; 
      .getDataRange().getValues();
      for(var k=0; k<sett.length; k++) {
         if(sett[k][0]=='Maintenance' && sett[k][1]=='On') isMif(status === 'Deleted') return {success:false, message:"â›” Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ø°ÙˆÙ."};aint = true;
         if(sett[k][0]=='WhatsApp_Link') waLink = sett[k
      
      var expiryDate = d[i][8]; 
      if (expiryDate && new Date][1];
      }
  }
  if(isMaint && email !== 'admin') return {(expiryDate) instanceof Date) {
          if (new Date() > new Date(expiryDate)) {
success:false, message:"âš ï¸ Ø§Ù„Ù…Ù†ØµØ© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹."};
  
  for(var              return { 
                  success: false, 
                  message: "EXPIRED", 
                  wa: i=1; i<d.length; i++) {
    var rowEmail = String(d[i waLink || "https://wa.me/"
              };
          }
      }
      var storedDevice][0]).toLowerCase().trim();
    var rowPass = String(d[i][1]);
    if = d[i][9]; 
      if (deviceId && String(storedDevice) !== String(deviceId))(rowEmail == String(email).toLowerCase().trim() && rowPass == String(pass)) {
      var {
          sheet.getRange(i+1, 10).setValue(deviceId); 
      }
      
      sheet.getRange(i+1, 7).setValue(new Date()); 
       status = d[i][7]; 
      if(status === 'Deleted') return {success:false,
      return {
          success:true, 
          token:Utilities.base64Encode(rowEmail message:"â›” Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ø°ÙˆÙ."};
      
      var expiryDate = d[i][8), 
          name:d[i][2], 
          classLevel:d[i][4],]; 
      if (expiryDate && new Date(expiryDate) instanceof Date) {
          if (new Date() > new Date(expiryDate)) {
              return { 
                  success: false, 
                  message: "EXPIRED", 
                  wa: waLink || "https://wa.me/"
              }; 
          photo:d[i][5] || ""
      };
    }
  }
  
          }
      }
      var storedDevice = d[i][9]; 
      if (deviceIdreturn {success:false, message:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"};
}

function getExamsList(token) {
  var u = getUser(token); if(!u) return && String(storedDevice) !== String(deviceId)) {
          sheet.getRange(i+1,  {success:false, message:"ØºÙŠØ± Ù…ØµØ±Ø­"};
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheet10).setValue(deviceId); 
      }
      
      sheet.getRange(i+1,ByName('Exams');
  if(!sheet) return {success:true, subjects:[]};
  var 7).setValue(new Date()); 
      
      return {
          success:true, 
           d = sheet.getDataRange().getValues();
  var subjectsMap = {}; 
  var uClass =token:Utilities.base64Encode(rowEmail), 
          name:d[i][2], 
          classLevel:d[i][4], 
          photo:d[i][5] || "" String(u.classLevel).trim();
  
  for(var i=1; i<d.
      };
    }
  }
  return {success:false, message:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠlength; i++) {
    var t=d[i][0], c=String(d[i][1]).trim(), status=d[i][6], subj=String(d[i][7]||" Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"};
}

function getExamsList(token) {
  var u = getUser(token); if(!u) return {success:false, message:"ØºÙŠØ± Ù…ØµØ±Ø­"};
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Exams');
  if(!sheet) return {success:true, subjects:Ù…ÙˆØ§Ø¯ Ø¹Ø§Ù…Ø©").trim();
    if(t && (c=="" || c=="Ø¹Ø§Ù…" || c==uClass) && status !== 'Hidden') {
      if(!subjectsMap[subj]) subjectsMap[subj] = [];
      subjectsMap[subj].push({title:t, duration:d[i][2] || 15});
    }
  }
  
  var list = []; for (var k in[]};
  var d = sheet.getDataRange().getValues();
  var subjectsMap = {}; 
 subjectsMap) list.push({name: k, exams: subjectsMap[k]});
  return {success:true, subjects: list};
}

function getReviewData(token, examTitle) {
   var u = getUser(token); if(!u) return {success:false};
   var ss = SpreadsheetApp.getActiveSpreadsheet();
   var examsData = ss.getSheetByName('Exams').getDataRange().getValues();  var uClass = String(u.classLevel).trim();
  
  for(var i=1; i<d.length; i++) {
    var t=d[i][0], c=String(d[i][1]).trim(), status=d[i][6], subj=String(d[i][7]||"Ù…ÙˆØ§Ø¯ Ø¹Ø§Ù…Ø©").trim();
    if(t && (c=="" || c
   var targetClass = "";
   for(var j=1; j<examsData.length; j++) {
       if(examsData[j][0] == examTitle) {
           targetClass = String(examsData[j][1]).trim();
           break;
       }
   }
   var sheet=="Ø¹Ø§Ù…" || c==uClass) && status !== 'Hidden') {
      if(!subjectsMap[subj]) subjectsMap[subj] = [];
      subjectsMap[subj].push({title:t, duration:d[i][2] || 15});
    }
  }
  
  var list = []; for (var k in subjectsName = "Questions";
   if(targetClass == "Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ") sheetName = "Q_12";
   else if(targetClass == "Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ") sheetName = "Q_11";
   else if(targetClass == "Ø§Ù„Ø¹Ø§Ø´Ø±") sheetName = "Q_10";
Map) list.push({name: k, exams: subjectsMap[k]});
  return {success:true, subjects: list};
}

function getReviewData(token, examTitle) {
   var u = getUser(token); if(!u) return {success:false};
   var ss = SpreadsheetApp.getActiveSpreadsheet();
   var examsData = ss.getSheetByName('Exams').getDataRange().getValues();
   else if(targetClass == "Ø§Ù„ØªØ§Ø³Ø¹") sheetName = "Q_9";
   else if   var targetClass = "";
   for(var j=1; j<examsData.length; j++)(targetClass == "Ø§Ù„Ø«Ø§Ù…Ù†") sheetName = "Q_8";
   else if(targetClass == "Ø§Ù„Ø³Ø§Ø¨Ø¹") sheetName = "Q_7";
   else if(targetClass == "Ø§Ù„Ø³Ø§Ø¯Ø³") {
       if(examsData[j][0] == examTitle) {
           targetClass = String( sheetName = "Q_6";
   else if(targetClass == "Ø§Ù„Ø®Ø§Ù…Ø³") sheetNameexamsData[j][1]).trim();
           break;
       }
   }
   var sheetName = "Q_5";
   else if(targetClass == "Ø§Ù„Ø±Ø§Ø¨Ø¹") sheetName = "Q = "Questions";
   if(targetClass == "Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ") sheetName = "Q_1_4";
   else if(targetClass == "Ø§Ù„Ø«Ø§Ù„Ø«") sheetName = "Q_3";
   var qSheet = ss.getSheetByName(sheetName);
   if(!qSheet) qSheet = ss.getSheetByName('Questions');
   if (!qSheet) return {success:false, message: "Sheet not found"};
   var d = qSheet.getDataRange().getValues();
   var answers = {};
   for(var i=1; i<d.length; i++) { 
       if(d[i][0] == examTitle) answers[i] = d[i][6]; 
   }
   2";
   else if(targetClass == "Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ") sheetName = "Q_11";
   else if(targetClass == "Ø§Ù„Ø¹Ø§Ø´Ø±") sheetName = "Q_10";
   else if(targetClass == "Ø§Ù„ØªØ§Ø³Ø¹") sheetName = "Q_9";
   else if(targetClass == "Ø§Ù„Ø«Ø§Ù…Ù†") sheetName = "Q_8";
   else if(targetClass == "Ø§Ù„Ø³Ø§Ø¨Ø¹") sheetName = "Q_7";
   else if(targetClass == "Ø§Ù„Ø³Ø§Ø¯Ø³") sheetreturn {success:true, answers:answers};
}

function getStudentResults(token) {
  varName = "Q_6";
   else if(targetClass == "Ø§Ù„Ø®Ø§Ù…Ø³") sheetName = u = getUser(token); if(!u) return {success:false};
  var sheet = SpreadsheetApp. "Q_5";
   else if(targetClass == "Ø§Ù„Ø±Ø§Ø¨Ø¹") sheetName = "Q_4";
   else if(targetClass == "Ø§Ù„Ø«Ø§Ù„Ø«") sheetName = "Q_3";
   var qSheet = ss.getSheetByName(sheetName);
   if(!qSheet) qSheet = ss.getActiveSpreadsheet().getSheetByName('Results');
  if(!sheet) return {success:true, results:[]getSheetByName('Questions');
   if (!qSheet) return {success:false, message: "Sheet not found"};
   var d = qSheet.getDataRange().getValues();
   var answers = {};
   for(var i=1; i<d.length; i++) { 
       if(d[i][};
  var res = sheet.getDataRange().getValues();
  var list = [];
  for(var i=1; i<res.length; i++) {
    if(res[i][1] == u.email) list.push({exam: res[i][2], percent: res[i][5]});
  }
  return {success:true, results: list};
}

function getLeaderboard(token) {
  var u = getUser(token); if(!u) return {success:false};
0] == examTitle) answers[i] = d[i][6]; 
   }
   return {success:true, answers:answers};
}

function getStudentResults(token) {
  var u = getUser(token); if(!u) return {success:false};
  var sheet = SpreadsheetApp.getActive  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var resSheet = ss.getSheetByName('Results');Spreadsheet().getSheetByName('Results');
  if(!sheet) return {success:true, results:[]};
  var stdSheet = ss.getSheetByName('Students');
  if(!resSheet || !stdSheet)
  var res = sheet.getDataRange().getValues();
  var list = [];
  for(var i=1; i<res.length; i++) {
    if(res[i][1] == return {success:true, list:[]};
  
  var res = resSheet.getDataRange().getValues();
  var stds = stdSheet.getDataRange().getValues();
  
  var studentNames u.email) list.push({exam: res[i][2], percent: res[i][5]});
  }
  return {success:true, results: list};
}

function getLeaderboard( = {};
  for(var k=1; k<stds.length; k++) studentNames[stds[k][0]] = stds[k][2];
  var scores = {};
  for(token) {
  var u = getUser(token); if(!u) return {success:false};
  var i=1; i<res.length; i++) {
    var email = res[i][1var ss = SpreadsheetApp.getActiveSpreadsheet();
  var resSheet = ss.getSheetByName('Results');
];
    var score = parseFloat(res[i][5]); 
    if(!isNaN(score)) {
      if(!scores[email]) scores[email] = {total:0, count:0};
      scores[email].total += score;
      scores[email].count++;
    }
  }
    var stdSheet = ss.getSheetByName('Students');
  if(!resSheet || !stdSheet) return {success:true, list:[]};
  
  var res = resSheet.getDataRange().getValues
  var list = [];
  for(var email in scores) {
    var avg = Math.round(scores[email].total / scores[email].count);
    list.push({name: studentNames[email] || email, score: avg});
  }
  
  list.sort((a,b) => b.score - a.score);
  return {success:true, list: list.slice(0, 10)};
}

function uploadStudentAssignment(token, d) {
    var u = getUser(token); if(!u) return {success:false};
    var fileLink = d.fileData;();
  var stds = stdSheet.getDataRange().getValues();
  
  var studentNames = {};
  for(var k=1; k<stds.length; k++) studentNames[stds[k][0]] = stds[k][2];
  var scores = {};
  for(var i=1; i<res.length; i++) {
    var email = res[i][1];
    if (fileLink && fileLink.indexOf("base64,") > -1) {
       fileLink = saveToDrive(fileLink, d.fileName || "Assignment_" + u.name);
    }
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Assignments');
    if(!sheet) { setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Assignments'); }
    sheet.append
    var score = parseFloat(res[i][5]); 
    if(!isNaN(score)) {
      if(!scores[email]) scores[email] = {total:0, count:0};
      scoresRow([new Date(), u.email, u.name, d.type, d.desc, fileLink,[email].total += score;
      scores[email].count++;
    }
  }
  
  var list = [];
  for(var email in scores) {
    var avg = Math.round( 'Pending', '']);
    return {success:true};
}

function sendComplaint(token, msg) {
    var u = getUser(token); if(!u) return {success:false};
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Complaints');
    if(!sheet) { setupDatabase();scores[email].total / scores[email].count);
    list.push({name: studentNames[email] || email, score: avg});
  }
  
  list.sort((a,b) => sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Complaints'); }
    sheet.appendRow([new Date(), u.email, u.name, msg, 'New', '']);
    return {success:true};
}

function getStudentStats(token) {
  var u = getUser(token); if(!u) return {success:false};
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var resSheet b.score - a.score);
  return {success:true, list: list.slice(0, 10)};
}

function uploadStudentAssignment(token, d) {
    var u = getUser(token); if(!u) return {success:false};
    var fileLink = d.fileData;
 = ss.getSheetByName('Results');
  var res = resSheet ? resSheet.getDataRange().getValues() : [];
  
  var myTotal = 0, classTotal = 0, myCount = 0, classCount = 0;
  var myScores = [];
  for(var i=1; i<res.length; i++) {
      var score = parseFloat(res[i][5]);
      if(!isNaN(score)) {
        classTotal += score; classCount++;
        if(res[i][1] == u.email) { myScores.push({exam: res[i][2], score:    if (fileLink && fileLink.indexOf("base64,") > -1) {
       fileLink = saveToDrive(fileLink, d.fileName || "Assignment_" + u.name);
    }
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Assignments');
    if(!sheet) { score}); myTotal += score; myCount++; }
      }
  }
  var badges = [];
  if(myCount > 0) badges.push("Ù…Ø´Ø§Ø±Ùƒ Ù†Ø´Ø·");
  if(myScores.some(s=>s.score==100)) badges.push("Ø§Ù„Ø¹Ø¨Ù‚Ø±ÙŠ (100%)");
  
  var settingsSheet = ss.getSheetByName('Settings');
  var teacherInfo = setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Assignments'); }
    sheet.appendRow {name: ''};
  var socialLinks = {facebook:'', instagram:'', youtube:'', whatsapp:''};
  
  if(settingsSheet) {
    var sData = settingsSheet.getDataRange().getValues();
    sData.forEach(r => {
        if(r[0]=='TeacherName') teacherInfo.name([new Date(), u.email, u.name, d.type, d.desc, fileLink, ' = r[1];
        if(r[0]=='Facebook') socialLinks.facebook = r[1];
        if(r[0]=='Instagram') socialLinks.instagram = r[1];
        if(r[0]=='Youtube') socialLinks.youtube = r[1];
        if(r[0]=='WhatsApp_Link') socialLinks.whatsapp = r[1];
    });
  }
  
  return {
    success: true, myAvg: myCount > 0 ? Math.round(myTotal / myCount) : 0,
    classAvg: classCount > 0 ? Math.round(classTotal / classCountPending', '']);
    return {success:true};
}

function sendComplaint(token, msg) {
    var u = getUser(token); if(!u) return {success:false};
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Complaints');
    if(!sheet) { setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Complaints'); }
    sheet.appendRow([new Date(), u.email, u.name, msg, 'New', '']);
    return {success:true};
}

function getStudentStats(token) {
  var u = getUser(token); if(!u)) : 0,
    history: myScores, name: u.name, cls: u.classLevel, badges: badges,
    teacher: teacherInfo, socials: socialLinks 
  };
}

function return {success:false};
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var resSheet = ss.getSheetByName('Results');
  var res = resSheet ? resSheet.getDataRange().getValues() : [];
  
  var myTotal = 0, classTotal = 0, myCount = 0, classCount = 0;
  var myScores = [];
  for(var i=1; i<res.length; i++) {
      var score = parseFloat(res[i][5]);
      if(!isNaN(score)) {
        classTotal += score; classCount++;
        if(res[i][1] == u.email) { myScores.push({exam: res[i][2], score: score}); myTotal += score; myCount++; }
      }
  }
  var badges = [];
   saveStudentNote(token, text) {
   var u = getUser(token); if(!u) return {if(myCount > 0) badges.push("Ù…Ø´Ø§Ø±Ùƒ Ù†Ø´Ø·");
  if(myScores.some(s=>s.score==100)) badges.push("Ø§Ù„Ø¹Ø¨Ù‚Ø±ÙŠ (100success:false};
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Notes');
   if(!sheet) { setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Notes'); }
   
   var d = sheet.getDataRange().getValues();
   for(var i=1; i<d.length; i++) {
       if(d[i][0] == u.email) {
           sheet.getRange(i+1, 2).setValue(text);
           sheet.getRange(%)");
  
  var settingsSheet = ss.getSheetByName('Settings');
  var teacherInfo = {name: ''};
  var socialLinks = {facebook:'', instagram:'', youtube:'', whatsapp:''};
  
  if(settingsSheet) {
    var sData = settingsSheet.getDataRange().getValues();
    sData.forEach(r => {
        if(r[0]=='TeacherName') teacherInfo.name = r[1];
        if(r[0]=='Facebook') socialLinks.facebook = r[1];
        if(r[0]=='Instagram') socialLinks.instagram = r[1];
        if(r[0]=='Youtube') socialLinks.youtube = r[1];
        if(r[0]=='WhatsApp_Link') socialLinks.whatsapp = r[1];
    });
  }
  
  return {
    success: true, myAvg: myCount > 0 ? Math.round(myTotal / myCount) : 0,
    classAvg: classCount > 0 ? Math.round(classTotal / classCount) : 0,
    historyi+1, 3).setValue(new Date());
           return {success:true};
       }
   }
   sheet.appendRow([u.email, text, new Date()]);
   return {success:true};
}

function getStudentNote(token) {
   var u = getUser(token); if(!u) return {success:false};
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(': myScores, name: u.name, cls: u.classLevel, badges: badges,
    teacher: teacherInfo, socials: socialLinks 
  };
}

function saveStudentNote(token, text)Notes');
   if(!sheet) return {success:true, note:""};
   var d = sheet.getDataRange().getValues();
   for(var i=1; i<d.length; i++) {
       if(d[i][0] == u.email) return {success:true, note:d[i][1]};
   }
   return {success:true, note:""};
}

function {
   var u = getUser(token); if(!u) return {success:false};
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Notes');
   if(!sheet) { setupDatabase(); sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Notes'); }
   
   var d = sheet.getDataRange().getValues();
   for(var i=1; i<d.length; i++) {
       if(d[i][0] == u.email) {
           sheet.getRange(i+1, 2).setValue(text);
           sheet.getRange(i+1, 3).setValue(new Date());
           return {success:true};
       }
   }
   sheet.appendRow([u.email, text, new Date()]);
   return {success:true};
}

function get updateProfile(token, newPass, newPhoto) {
   var u = getUser(token); if(!u) return {success:false};
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students');StudentNote(token) {
   var u = getUser(token); if(!u) return {success:false};
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Notes');
   if(!sheet)
   var d = sheet.getDataRange().getValues();
   for(var i=1; i<d.length; i++) {
       if(d[i][0] == u.email) {
 return {success:true, note:""};
   var d = sheet.getDataRange().getValues();
   for(var i=1; i<d.length; i++) {
       if(d[i][0] == u.email) return {success:true, note:d[i][1]};
              if(newPass) sheet.getRange(i+1, 2).setValue(newPass);
           if(newPhoto) sheet.getRange(i+1, 6).setValue(newPhoto);
}
   return {success:true, note:""};
}

function updateProfile(token, newPass, newPhoto) {
   var u = getUser(token); if(!u) return {success:false};
           clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´ Ù„Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© ØªØºÙŠØ±Øª
           return {success:true, message:"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ"};
       }
   }
   return {success:false};
}

function getStudentMessages(token) {
   var u = getUser(token); if(!u) return [];
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Notifications');
   if(!sheet) return   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students');
   var d = sheet.getDataRange().getValues();
   for(var i=1; i<d.length; i++) {
       if(d[i][0] == u.email) {
           if(newPass) sheet. [];
   var d = sheet.getDataRange().getValues();
   var msgs = [];
   var start = Math.max(1, d.length - 20); 
   for(var i=start; i<d.length; i++) {
      var t = d[i][1]; 
getRange(i+1, 2).setValue(newPass);
           if(newPhoto) sheet.getRange(i+1, 6).setValue(newPhoto);
           clearAdminCache(); // âœ¨ ØªØ­Ø¯      if(t === u.classLevel || t === u.email) {
          msgs.push({date: new Date(d[i][0]).toLocaleTimeString(), msg: d[i][2]});
      }
   }
   var compSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Complaints');
ÙŠØ« Ø§Ù„ÙƒØ§Ø´ Ù„Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© ØªØºÙŠØ±Øª
           return {success:true, message:"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ"};
       }
   }
   return {success:false};
}

function getStudentMessages(token)   if(compSheet) {
      var cData = compSheet.getDataRange().getValues();
      for(var k=1; k<cData.length; k++) {
        if(cData[k][1] == u.email && cData[k][5]) { 
            msgs.push({date: 'Ø±Ø¯ Ø¥Ø¯Ø§Ø±ÙŠ', msg: 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø´ÙƒÙˆØ§Ùƒ: ' + cData[k][ {
   var u = getUser(token); if(!u) return [];
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Notifications');
   if(!sheet) return [];
   var d = sheet.getDataRange().getValues();
   var msgs = [];
   var start = Math.max(1, d.length - 20); 
   for(var i=start; i<d.length; i++) {
      var t = d[i][1]; 
      if(t === u.class5]});
        }
      }
   }
   return msgs.reverse();
}

function softDeleteAccount(token) {
   var u = getUser(token); if(!u) return {success:Level || t === u.email) {
          msgs.push({date: new Date(d[i][0]).toLocaleTimeString(), msg: d[i][2]});
      }
   }
   var compfalse};
   var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Students');
   var d = sheet.getDataRange().getValues();
   for(var i=1; i<d.length; i++) {
       if(d[i][0] == u.email) {
           sheet.getRange(i+1, 8).setValue('Deleted');
           clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Complaints');
   if(compSheet) {
      var cData = compSheet.getDataRange().getValues();
      for(var k=1; k<cData.length; k++) {
        if(cData[k][1] == u.email && cData[k][5]) { 
            msgs.push({date: 'Ø±Ø¯ Ø¥Ø¯Ø§Ø±ÙŠ',
           return {success:true, message:"ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨"};
       }
   }
   return {success:false};
}

function getPublicData() {
    var ss = SpreadsheetApp.getActiveSpread msg: 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø´ÙƒÙˆØ§Ùƒ: ' + cData[k][5]});
        }
      }
   }
   return msgs.reverse();
}

function softDeleteAccount(token) {
   var u = getUser(token); if(!u) return {success:false};
   var sheet = Spreadsheetsheet();
    var settings = {};
    
    var sSheet = ss.getSheetByName('Settings');
    if (sSheet) {
        var sData = sSheet.getDataRange().getValues();
        App.getActiveSpreadsheet().getSheetByName('Students');
   var d = sheet.getDataRange().getValues();sData.forEach(r => settings[r[0]] = r[1]);
    }
    
    var classes = [];
    var cSheet = ss.getSheetByName('Codes');
    if (cSheet) {
        var cData = cSheet.getDataRange().getValues();
        var cSet = new
   for(var i=1; i<d.length; i++) {
       if(d[i][0] == u.email) {
           sheet.getRange(i+1, 8).setValue('Deleted');
           clearAdminCache(); // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
           return {success:true, message:"ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨"};
       }
   }
   return {success:false};
}

 Set();
        for (var i = 1; i < cData.length; i++) {
            if (cData[i][4]) cSet.add(cData[i][4]);
        }
        classes = Array.from(cSet);
    }
    
    var notifSheet = ss.getSheetByName('Notifications');
    var news = [];
    if(notifSheet) {
        var nData = notifSheet.getDataRange().getValues();
        for(var i=nData.length-1; i>=1; i--) {
            if(nData[i][1] === 'All') {
                news.push({text: nData[i][2]});
                break; 
            }
        }
    }
    
    return { success: true, settings: settings, classes: classes, news: news };
}

function submitExam(token, n, a, cheats) {
    function getPublicData() {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var settings = {};
    
    var sSheet = ss.getSheetByName('Settings');
    if (sSheet) {
        var sData = sSheet.getDataRange().getValues();
        sData.forEach(r => settings[r[0]] = r[1]);
    }
    
    var classes = [];
    var cSheet = ss.getSheetByName('Codes');
    if (cSheet) {
        var cData = cSheet.getDataRange().getValues();
        var cSet = new Set();
        for (var i = 1; i < cData.length; i++) {
            if (cData[i][4]) cSet.add(cData[i][4]);
        }
        classes = Array.from(cSet);
    }
    
    var notifSheet = ss.getSheetByName('Notifications');
    try {
        var u = getUser(token);
        if(!u) return {success:false, messagevar news = [];
    if(notifSheet) {
        var nData = notifSheet.getDataRange().getValues();
        for(var i=nData.length-1; i>=1; i:"ØºÙŠØ± Ù…ØµØ±Ø­"};
        
        var ss = SpreadsheetApp.getActiveSpreadsheet();
        var qs = getExamQuestions(token, n); 
        if(!qs.success) return {success:false, message:"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„--) {
            if(nData[i][1] === 'All') {
                news.push({ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†"};
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø¢Ù…Ù†
        var examTitletext: nData[i][2]});
                break; 
            }
        }
    } = n;
        var examsData = ss.getSheetByName('Exams').getDataRange().getValues();

    
    return { success: true, settings: settings, classes: classes, news: news };
}        var targetClass = "";
        for(var i=1; i<examsData.length; i++)

function submitExam(token, n, a, cheats) {
    try {
        var u = getUser {
           if(examsData[i][0] == examTitle) {
             targetClass = String((token);
        if(!u) return {success:false, message:"ØºÙŠØ± Ù…ØµØ±Ø­"};
        
        var ss = SpreadsheetexamsData[i][1]).trim();
             break;
           }
        }
        var sheetName = "Questions";
        ifApp.getActiveSpreadsheet();
        var qs = getExamQuestions(token, n); 
        if(!(targetClass == "Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ") sheetName = "Q_12";
        else if(qs.success) return {success:false, message:"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†"};
        
        // Ø¥Ø¹Ø§Ø¯Ø©targetClass == "Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ") sheetName = "Q_11";
        else if(targetClass == "Ø§Ù„Ø¹Ø§Ø´Ø±") sheetName = "Q_10";
        else if(targetClass == " Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø¢Ù…Ù†
        var examTitle = n;
        var examsData = ss.getSheetByName('Exams').getDataRange().getValues();
        var targetClass = "";
        Ø§Ù„ØªØ§Ø³Ø¹") sheetName = "Q_9";
        
        var qSheet = ss.getSheetByNamefor(var i=1; i<examsData.length; i++) {
           if(examsData[(sheetName);
        if(!qSheet) qSheet = ss.getSheetByName('Questions');
        
i][0] == examTitle) {
             targetClass = String(examsData[i][1]).trim        var d = qSheet.getDataRange().getValues();
        var score = 0;
        var();
             break;
           }
        }
        var sheetName = "Questions";
        if(targetClass == "Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ totalQ = 0;
        
        for(var i=1; i<d.length; iÙŠ") sheetName = "Q_12";
        else if(targetClass == "Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ")++) {
           if(d[i][0] == examTitle) {
               totalQ++;
                sheetName = "Q_11";
        else if(targetClass == "Ø§Ù„Ø¹Ø§Ø´Ø±") sheetNamevar qId = i; 
               var correct = String(d[i][6]).trim(); // Ø§Ù„Ø¥ = "Q_10";
        else if(targetClass == "Ø§Ù„ØªØ§Ø³Ø¹") sheetName = "Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
               var studentAns = a[qId];
               if(studentAns && String(studentAns).trim() == correct) {
                   score++;
               }
           }
        }
        
        var percent = totalQ > 0 ? Math.round((score / totalQ) * 100) : 0;
        
        // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        var resSheet = ss.getSheetByNameQ_9";
        
        var qSheet = ss.getSheetByName(sheetName);
        if(!qSheet) qSheet = ss.getSheetByName('Questions');
        
        var d = qSheet.getDataRange().getValues();
        var score = 0;
        var totalQ = 0;
        
        for(var i=1; i<d.length; i++) {
           if(d[('Results');
        if(!resSheet) { setupDatabase(); resSheet = ss.getSheetByName('Results');i][0] == examTitle) {
               totalQ++;
               var qId = i; 
 }
        resSheet.appendRow([new Date(), u.email, n, score, totalQ, percent               var correct = String(d[i][6]).trim(); // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
               var student, cheats]);
        
        return {success:true, percent: percent};
        
    } catch(Ans = a[qId];
               if(studentAns && String(studentAns).trim() == correct)e) { return {success:false, message:e.toString()}; }
}

function deleteResultRow(rowId) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Results');
  sheet.deleteRow(rowId);
  return "ØªÙ… Ø§Ù„Ø­Ø°Ù";
}
```
